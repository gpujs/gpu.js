var GPU=function(){"use strict";function t(t){const e=new Array(t.length);for(let r=0;r<t.length;r++){const n=t[r];n.toArray?e[r]=n.toArray():e[r]=n}return e}function e(){const e=t(arguments),r=new Float32Array(this.output.x);for(let t=0;t<this.output.x;t++)this.thread.x=t,this.thread.y=0,this.thread.z=0,r[t]=this._fn.apply(this,e);return r}function r(){const e=t(arguments),r=new Array(this.output.y);for(let t=0;t<this.output.y;t++){const n=new Float32Array(this.output.x);for(let r=0;r<this.output.x;r++)this.thread.x=r,this.thread.y=t,this.thread.z=0,n[r]=this._fn.apply(this,e);r[t]=n}return r}function n(){const e=t(arguments);for(let t=0;t<this.output.y;t++)for(let r=0;r<this.output.x;r++)this.thread.x=r,this.thread.y=t,this.thread.z=0,this._fn.apply(this,e)}function i(){const e=t(arguments),r=new Array(this.output.z);for(let t=0;t<this.output.z;t++){const n=new Array(this.output.y);for(let r=0;r<this.output.y;r++){const i=new Float32Array(this.output.x);for(let n=0;n<this.output.x;n++)this.thread.x=n,this.thread.y=r,this.thread.z=t,i[n]=this._fn.apply(this,e);n[r]=i}r[t]=n}return r}function s(t){return t.setOutput=e=>{t.output=o(e),t.graphical&&a(t)},t.toJSON=()=>{throw new Error("Not usable with gpuMock")},t.setConstants=e=>(t.constants=e,t),t.setGraphical=e=>(t.graphical=e,t),t.setCanvas=e=>(t.canvas=e,t),t.setContext=e=>(t.context=e,t),t.exec=function(){return new Promise((e,r)=>{try{e(t.apply(t,arguments))}catch(t){r(t)}})},t.getPixels=e=>{const{x:r,y:n}=t.output;return e?function(t,e,r){const n=r/2|0,i=4*e,s=new Uint8ClampedArray(4*e),a=t.slice(0);for(let t=0;t<n;++t){const e=t*i,n=(r-t-1)*i;s.set(a.subarray(e,e+i)),a.copyWithin(e,n,n+i),a.set(s,n)}return a}(t._imageData.data,r,n):t._imageData.data.slice(0)},t.color=function(e,r,n,i){void 0===i&&(i=1),e=Math.floor(255*e),r=Math.floor(255*r),n=Math.floor(255*n),i=Math.floor(255*i);const s=t.output.x,a=t.output.y,o=t.thread.x+(a-t.thread.y-1)*s;t._colorData[4*o+0]=e,t._colorData[4*o+1]=r,t._colorData[4*o+2]=n,t._colorData[4*o+3]=i},t.setWarnVarUsage=()=>t,t.setOptimizeFloatMemory=()=>t,t.setArgumentTypes=()=>t,t.setDebug=()=>t,t.setLoopMaxIterations=()=>t,t.setPipeline=()=>t,t.setPrecision=()=>t,t.setImmutable=()=>t,t.setFunctions=()=>t,t.addSubKernel=()=>t,t.destroy=()=>{},t.validateSettings=()=>{},t.graphical&&t.output&&a(t),t}function a(t){const{x:e,y:r}=t.output;if(t.context&&t.context.createImageData){const n=new Uint8ClampedArray(e*r*4);t._imageData=t.context.createImageData(e,r),t._colorData=n}else{const n=new Uint8ClampedArray(e*r*4);t._imageData={data:n},t._colorData=n}}function o(t){let e=null;if(t.length)if(3===t.length){const[r,n,i]=t;e={x:r,y:n,z:i}}else if(2===t.length){const[r,n]=t;e={x:r,y:n}}else{const[r]=t;e={x:r}}else e=t;return e}var u=function(t,a={}){const u=a.output?o(a.output):null;function h(){return h.output.z?i.apply(h,arguments):h.output.y?h.graphical?n.apply(h,arguments):r.apply(h,arguments):e.apply(h,arguments)}return h._fn=t,h.constants=a.constants||null,h.context=a.context||null,h.canvas=a.canvas||null,h.graphical=a.graphical||!1,h._imageData=null,h._colorData=null,h.output=u,h.thread={x:0,y:0,z:0},s(h)};const h=/([^\s,]+)/g,l=/function ([^(]*)/,c=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm;function p(t){return"function"==typeof t}function d(t){return l.exec(t)[1].trim()}function m(t,e){if(e=e||{},"string"!=typeof t&&"function"!=typeof t)throw new Error("source not a string or function");const r="string"==typeof t?t:t.toString();let n=[];return{source:r,argumentTypes:n=Array.isArray(e.argumentTypes)?e.argumentTypes:"object"==typeof e.argumentTypes?x(r).map(t=>e.argumentTypes[t])||[]:e.argumentTypes||[],returnType:e.returnType||null}}function f(t,e,r){const n=r?`It has been replaced with "${r}"`:"It has been removed";console.warn(`You are using a deprecated ${t} "${e}". ${n}. Fixing, but please upgrade as it will soon be removed.`)}function g(t){return"string"==typeof t&&"function"===t.slice(0,"function".length).toLowerCase()}function x(t){const e=t.replace(c,"");let r=e.slice(e.indexOf("(")+1,e.indexOf(")")).match(h);return null===r&&(r=[]),r}function y(t){return!isNaN(t.length)}function T(t,e,r){const n=new Array(r);for(let i=0;i<r;i++){const r=i*e;n[i]=t.subarray(r,r+e)}return n}function b(t,e,r,n){const i=new Array(n);for(let s=0;s<n;s++){const n=new Array(r);for(let i=0;i<r;i++){const a=s*r*e+i*e;n[i]=t.subarray(a,a+e)}i[s]=n}return i}function A(t,e){const r=Array.isArray(t)?t:t.split(/\r?\n/g),n=e.loc.start,i=e.loc.end,s=[];if(n.line===i.line)s.push(r[n.line-1].substring(n.column,i.column));else{s.push(r[n.line-1].slice(n.column));for(let t=n.line;t<i.line;t++)s.push(r[t]);s.push(r[i.line-1].slice(0,i.column))}return s.join("\n")}var S=Object.freeze({isFunction:p,getFunctionNameFromString:d,functionToIFunction:m,warnDeprecated:f,isFunctionString:g,getArgumentNamesFromString:x,isArray:y,erectMemoryOptimized2DFloat:T,erectMemoryOptimized3DFloat:b,getAstString:A});class E{constructor(t,e){this.value=t,Array.isArray(e)?this.size=e:(this.size=new Int32Array(3),e.z?this.size=new Int32Array([e.x,e.y,e.z]):e.y?this.size=new Int32Array([e.x,e.y]):this.size=new Int32Array([e.x]));const[r,n,i]=this.size;if(i){if(this.value.length!==r*n*i)throw new Error(`Input size ${this.value.length} does not match ${r} * ${n} * ${i} = ${n*r*i}`)}else if(n){if(this.value.length!==r*n)throw new Error(`Input size ${this.value.length} does not match ${r} * ${n} = ${n*r}`)}else if(this.value.length!==r)throw new Error(`Input size ${this.value.length} does not match ${r}`)}toArray(){const[t,e,r]=this.size;return r?b(this.value.subarray?this.value:new Float32Array(this.value),t,e,r):e?T(this.value.subarray?this.value:new Float32Array(this.value),t,e):this.value}}var _={3:"abstract boolean byte char class double enum export extends final float goto implements import int interface long native package private protected public short static super synchronized throws transient volatile",5:"class enum extends super const export import",6:"enum",strict:"implements interface let package private protected public static yield",strictBind:"eval arguments"},v="break case catch continue debugger default do else finally for function if return switch throw try var while with null true false instanceof typeof void delete new in this",w={5:v,6:v+" const class extends export import super"},I=/^in(stanceof)?$/,D="ªµºÀ-ÖØ-öø-ˁˆ-ˑˠ-ˤˬˮͰ-ʹͶͷͺ-ͽͿΆΈ-ΊΌΎ-ΡΣ-ϵϷ-ҁҊ-ԯԱ-Ֆՙՠ-ֈא-תׯ-ײؠ-يٮٯٱ-ۓەۥۦۮۯۺ-ۼۿܐܒ-ܯݍ-ޥޱߊ-ߪߴߵߺࠀ-ࠕࠚࠤࠨࡀ-ࡘࡠ-ࡪࢠ-ࢴࢶ-ࢽऄ-हऽॐक़-ॡॱ-ঀঅ-ঌএঐও-নপ-রলশ-হঽৎড়ঢ়য়-ৡৰৱৼਅ-ਊਏਐਓ-ਨਪ-ਰਲਲ਼ਵਸ਼ਸਹਖ਼-ੜਫ਼ੲ-ੴઅ-ઍએ-ઑઓ-નપ-રલળવ-હઽૐૠૡૹଅ-ଌଏଐଓ-ନପ-ରଲଳଵ-ହଽଡ଼ଢ଼ୟ-ୡୱஃஅ-ஊஎ-ஐஒ-கஙசஜஞடணதந-பம-ஹௐఅ-ఌఎ-ఐఒ-నప-హఽౘ-ౚౠౡಀಅ-ಌಎ-ಐಒ-ನಪ-ಳವ-ಹಽೞೠೡೱೲഅ-ഌഎ-ഐഒ-ഺഽൎൔ-ൖൟ-ൡൺ-ൿඅ-ඖක-නඳ-රලව-ෆก-ะาำเ-ๆກຂຄງຈຊຍດ-ທນ-ຟມ-ຣລວສຫອ-ະາຳຽເ-ໄໆໜ-ໟༀཀ-ཇཉ-ཬྈ-ྌက-ဪဿၐ-ၕၚ-ၝၡၥၦၮ-ၰၵ-ႁႎႠ-ჅჇჍა-ჺჼ-ቈቊ-ቍቐ-ቖቘቚ-ቝበ-ኈኊ-ኍነ-ኰኲ-ኵኸ-ኾዀዂ-ዅወ-ዖዘ-ጐጒ-ጕጘ-ፚᎀ-ᎏᎠ-Ᏽᏸ-ᏽᐁ-ᙬᙯ-ᙿᚁ-ᚚᚠ-ᛪᛮ-ᛸᜀ-ᜌᜎ-ᜑᜠ-ᜱᝀ-ᝑᝠ-ᝬᝮ-ᝰក-ឳៗៜᠠ-ᡸᢀ-ᢨᢪᢰ-ᣵᤀ-ᤞᥐ-ᥭᥰ-ᥴᦀ-ᦫᦰ-ᧉᨀ-ᨖᨠ-ᩔᪧᬅ-ᬳᭅ-ᭋᮃ-ᮠᮮᮯᮺ-ᯥᰀ-ᰣᱍ-ᱏᱚ-ᱽᲀ-ᲈᲐ-ᲺᲽ-Ჿᳩ-ᳬᳮ-ᳱᳵᳶᴀ-ᶿḀ-ἕἘ-Ἕἠ-ὅὈ-Ὅὐ-ὗὙὛὝὟ-ώᾀ-ᾴᾶ-ᾼιῂ-ῄῆ-ῌῐ-ΐῖ-Ίῠ-Ῥῲ-ῴῶ-ῼⁱⁿₐ-ₜℂℇℊ-ℓℕ℘-ℝℤΩℨK-ℹℼ-ℿⅅ-ⅉⅎⅠ-ↈⰀ-Ⱞⰰ-ⱞⱠ-ⳤⳫ-ⳮⳲⳳⴀ-ⴥⴧⴭⴰ-ⵧⵯⶀ-ⶖⶠ-ⶦⶨ-ⶮⶰ-ⶶⶸ-ⶾⷀ-ⷆⷈ-ⷎⷐ-ⷖⷘ-ⷞ々-〇〡-〩〱-〵〸-〼ぁ-ゖ゛-ゟァ-ヺー-ヿㄅ-ㄯㄱ-ㆎㆠ-ㆺㇰ-ㇿ㐀-䶵一-鿯ꀀ-ꒌꓐ-ꓽꔀ-ꘌꘐ-ꘟꘪꘫꙀ-ꙮꙿ-ꚝꚠ-ꛯꜗ-ꜟꜢ-ꞈꞋ-ꞹꟷ-ꠁꠃ-ꠅꠇ-ꠊꠌ-ꠢꡀ-ꡳꢂ-ꢳꣲ-ꣷꣻꣽꣾꤊ-ꤥꤰ-ꥆꥠ-ꥼꦄ-ꦲꧏꧠ-ꧤꧦ-ꧯꧺ-ꧾꨀ-ꨨꩀ-ꩂꩄ-ꩋꩠ-ꩶꩺꩾ-ꪯꪱꪵꪶꪹ-ꪽꫀꫂꫛ-ꫝꫠ-ꫪꫲ-ꫴꬁ-ꬆꬉ-ꬎꬑ-ꬖꬠ-ꬦꬨ-ꬮꬰ-ꭚꭜ-ꭥꭰ-ꯢ가-힣ힰ-ퟆퟋ-ퟻ豈-舘並-龎ﬀ-ﬆﬓ-ﬗיִײַ-ﬨשׁ-זּטּ-לּמּנּסּףּפּצּ-ﮱﯓ-ﴽﵐ-ﶏﶒ-ﷇﷰ-ﷻﹰ-ﹴﹶ-ﻼＡ-Ｚａ-ｚｦ-ﾾￂ-ￇￊ-ￏￒ-ￗￚ-ￜ",R="‌‍·̀-ͯ·҃-֑҇-ׇֽֿׁׂׅׄؐ-ًؚ-٩ٰۖ-ۜ۟-۪ۤۧۨ-ۭ۰-۹ܑܰ-݊ަ-ް߀-߉߫-߽߳ࠖ-࠙ࠛ-ࠣࠥ-ࠧࠩ-࡙࠭-࡛࣓-ࣣ࣡-ःऺ-़ा-ॏ॑-ॗॢॣ०-९ঁ-ঃ়া-ৄেৈো-্ৗৢৣ০-৯৾ਁ-ਃ਼ਾ-ੂੇੈੋ-੍ੑ੦-ੱੵઁ-ઃ઼ા-ૅે-ૉો-્ૢૣ૦-૯ૺ-૿ଁ-ଃ଼ା-ୄେୈୋ-୍ୖୗୢୣ୦-୯ஂா-ூெ-ைொ-்ௗ௦-௯ఀ-ఄా-ౄె-ైొ-్ౕౖౢౣ౦-౯ಁ-ಃ಼ಾ-ೄೆ-ೈೊ-್ೕೖೢೣ೦-೯ഀ-ഃ഻഼ാ-ൄെ-ൈൊ-്ൗൢൣ൦-൯ංඃ්ා-ුූෘ-ෟ෦-෯ෲෳัิ-ฺ็-๎๐-๙ັິ-ູົຼ່-ໍ໐-໙༘༙༠-༩༹༵༷༾༿ཱ-྄྆྇ྍ-ྗྙ-ྼ࿆ါ-ှ၀-၉ၖ-ၙၞ-ၠၢ-ၤၧ-ၭၱ-ၴႂ-ႍႏ-ႝ፝-፟፩-፱ᜒ-᜔ᜲ-᜴ᝒᝓᝲᝳ឴-៓៝០-៩᠋-᠍᠐-᠙ᢩᤠ-ᤫᤰ-᤻᥆-᥏᧐-᧚ᨗ-ᨛᩕ-ᩞ᩠-᩿᩼-᪉᪐-᪙᪰-᪽ᬀ-ᬄ᬴-᭄᭐-᭙᭫-᭳ᮀ-ᮂᮡ-ᮭ᮰-᮹᯦-᯳ᰤ-᰷᱀-᱉᱐-᱙᳐-᳔᳒-᳨᳭ᳲ-᳴᳷-᳹᷀-᷹᷻-᷿‿⁀⁔⃐-⃥⃜⃡-⃰⳯-⵿⳱ⷠ-〪ⷿ-゙゚〯꘠-꘩꙯ꙴ-꙽ꚞꚟ꛰꛱ꠂ꠆ꠋꠣ-ꠧꢀꢁꢴ-ꣅ꣐-꣙꣠-꣱ꣿ-꤉ꤦ-꤭ꥇ-꥓ꦀ-ꦃ꦳-꧀꧐-꧙ꧥ꧰-꧹ꨩ-ꨶꩃꩌꩍ꩐-꩙ꩻ-ꩽꪰꪲ-ꪴꪷꪸꪾ꪿꫁ꫫ-ꫯꫵ꫶ꯣ-ꯪ꯬꯭꯰-꯹ﬞ︀-️︠-︯︳︴﹍-﹏０-９＿",k=new RegExp("["+D+"]"),$=new RegExp("["+D+R+"]");D=R=null;var C=[0,11,2,25,2,18,2,1,2,14,3,13,35,122,70,52,268,28,4,48,48,31,14,29,6,37,11,29,3,35,5,7,2,4,43,157,19,35,5,35,5,39,9,51,157,310,10,21,11,7,153,5,3,0,2,43,2,1,4,0,3,22,11,22,10,30,66,18,2,1,11,21,11,25,71,55,7,1,65,0,16,3,2,2,2,28,43,28,4,28,36,7,2,27,28,53,11,21,11,18,14,17,111,72,56,50,14,50,14,35,477,28,11,0,9,21,190,52,76,44,33,24,27,35,30,0,12,34,4,0,13,47,15,3,22,0,2,0,36,17,2,24,85,6,2,0,2,3,2,14,2,9,8,46,39,7,3,1,3,21,2,6,2,1,2,4,4,0,19,0,13,4,159,52,19,3,54,47,21,1,2,0,185,46,42,3,37,47,21,0,60,42,86,26,230,43,117,63,32,0,257,0,11,39,8,0,22,0,12,39,3,3,20,0,35,56,264,8,2,36,18,0,50,29,113,6,2,1,2,37,22,0,26,5,2,1,2,31,15,0,328,18,270,921,103,110,18,195,2749,1070,4050,582,8634,568,8,30,114,29,19,47,17,3,32,20,6,18,689,63,129,68,12,0,67,12,65,1,31,6129,15,754,9486,286,82,395,2309,106,6,12,4,8,8,9,5991,84,2,70,2,1,3,0,3,1,3,3,2,11,2,0,2,6,2,64,2,3,3,7,2,6,2,27,2,3,2,4,2,0,4,6,2,339,3,24,2,24,2,30,2,24,2,30,2,24,2,30,2,24,2,30,2,24,2,7,4149,196,60,67,1213,3,2,26,2,1,2,0,3,0,2,9,2,3,2,0,2,0,7,0,5,0,2,0,2,0,2,2,2,1,2,0,3,0,2,0,2,0,2,0,2,0,2,1,2,0,3,3,2,6,2,3,2,3,2,0,2,9,2,16,6,2,2,4,2,16,4421,42710,42,4148,12,221,3,5761,15,7472,3104,541],F=[509,0,227,0,150,4,294,9,1368,2,2,1,6,3,41,2,5,0,166,1,574,3,9,9,525,10,176,2,54,14,32,9,16,3,46,10,54,9,7,2,37,13,2,9,6,1,45,0,13,2,49,13,9,3,4,9,83,11,7,0,161,11,6,9,7,3,56,1,2,6,3,1,3,2,10,0,11,1,3,6,4,4,193,17,10,9,5,0,82,19,13,9,214,6,3,8,28,1,83,16,16,9,82,12,9,9,84,14,5,9,243,14,166,9,280,9,41,6,2,3,9,0,10,10,47,15,406,7,2,7,17,9,57,21,2,13,123,5,4,0,2,1,2,6,2,0,9,9,49,4,2,1,2,4,9,9,330,3,19306,9,135,4,60,6,26,9,1016,45,17,3,19723,1,5319,4,4,5,9,7,3,6,31,3,149,2,1418,49,513,54,5,49,9,0,15,0,23,4,2,14,1361,6,2,16,3,6,2,1,2,4,2214,6,110,6,6,9,792487,239];function N(t,e){for(var r=65536,n=0;n<e.length;n+=2){if((r+=e[n])>t)return!1;if((r+=e[n+1])>=t)return!0}}function O(t,e){return t<65?36===t:t<91||(t<97?95===t:t<123||(t<=65535?t>=170&&k.test(String.fromCharCode(t)):!1!==e&&N(t,C)))}function P(t,e){return t<48?36===t:t<58||!(t<65)&&(t<91||(t<97?95===t:t<123||(t<=65535?t>=170&&$.test(String.fromCharCode(t)):!1!==e&&(N(t,C)||N(t,F)))))}var z=function(t,e){void 0===e&&(e={}),this.label=t,this.keyword=e.keyword,this.beforeExpr=!!e.beforeExpr,this.startsExpr=!!e.startsExpr,this.isLoop=!!e.isLoop,this.isAssign=!!e.isAssign,this.prefix=!!e.prefix,this.postfix=!!e.postfix,this.binop=e.binop||null,this.updateContext=null};function L(t,e){return new z(t,{beforeExpr:!0,binop:e})}var M={beforeExpr:!0},V={startsExpr:!0},U={};function K(t,e){return void 0===e&&(e={}),e.keyword=t,U[t]=new z(t,e)}var B={num:new z("num",V),regexp:new z("regexp",V),string:new z("string",V),name:new z("name",V),eof:new z("eof"),bracketL:new z("[",{beforeExpr:!0,startsExpr:!0}),bracketR:new z("]"),braceL:new z("{",{beforeExpr:!0,startsExpr:!0}),braceR:new z("}"),parenL:new z("(",{beforeExpr:!0,startsExpr:!0}),parenR:new z(")"),comma:new z(",",M),semi:new z(";",M),colon:new z(":",M),dot:new z("."),question:new z("?",M),arrow:new z("=>",M),template:new z("template"),invalidTemplate:new z("invalidTemplate"),ellipsis:new z("...",M),backQuote:new z("`",V),dollarBraceL:new z("${",{beforeExpr:!0,startsExpr:!0}),eq:new z("=",{beforeExpr:!0,isAssign:!0}),assign:new z("_=",{beforeExpr:!0,isAssign:!0}),incDec:new z("++/--",{prefix:!0,postfix:!0,startsExpr:!0}),prefix:new z("!/~",{beforeExpr:!0,prefix:!0,startsExpr:!0}),logicalOR:L("||",1),logicalAND:L("&&",2),bitwiseOR:L("|",3),bitwiseXOR:L("^",4),bitwiseAND:L("&",5),equality:L("==/!=/===/!==",6),relational:L("</>/<=/>=",7),bitShift:L("<</>>/>>>",8),plusMin:new z("+/-",{beforeExpr:!0,binop:9,prefix:!0,startsExpr:!0}),modulo:L("%",10),star:L("*",10),slash:L("/",10),starstar:new z("**",{beforeExpr:!0}),_break:K("break"),_case:K("case",M),_catch:K("catch"),_continue:K("continue"),_debugger:K("debugger"),_default:K("default",M),_do:K("do",{isLoop:!0,beforeExpr:!0}),_else:K("else",M),_finally:K("finally"),_for:K("for",{isLoop:!0}),_function:K("function",V),_if:K("if"),_return:K("return",M),_switch:K("switch"),_throw:K("throw",M),_try:K("try"),_var:K("var"),_const:K("const"),_while:K("while",{isLoop:!0}),_with:K("with"),_new:K("new",{beforeExpr:!0,startsExpr:!0}),_this:K("this",V),_super:K("super",V),_class:K("class",V),_extends:K("extends",M),_export:K("export"),_import:K("import"),_null:K("null",V),_true:K("true",V),_false:K("false",V),_in:K("in",{beforeExpr:!0,binop:7}),_instanceof:K("instanceof",{beforeExpr:!0,binop:7}),_typeof:K("typeof",{beforeExpr:!0,prefix:!0,startsExpr:!0}),_void:K("void",{beforeExpr:!0,prefix:!0,startsExpr:!0}),_delete:K("delete",{beforeExpr:!0,prefix:!0,startsExpr:!0})},G=/\r\n?|\n|\u2028|\u2029/,j=new RegExp(G.source,"g");function X(t,e){return 10===t||13===t||!e&&(8232===t||8233===t)}var H=/[\u1680\u180e\u2000-\u200a\u202f\u205f\u3000\ufeff]/,W=/(?:\s|\/\/.*|\/\*[^]*?\*\/)*/g,q=Object.prototype,Y=q.hasOwnProperty,Z=q.toString;function J(t,e){return Y.call(t,e)}var Q=Array.isArray||function(t){return"[object Array]"===Z.call(t)},tt=function(t,e){this.line=t,this.column=e};tt.prototype.offset=function(t){return new tt(this.line,this.column+t)};var et=function(t,e,r){this.start=e,this.end=r,null!==t.sourceFile&&(this.source=t.sourceFile)};var rt={ecmaVersion:7,sourceType:"script",onInsertedSemicolon:null,onTrailingComma:null,allowReserved:null,allowReturnOutsideFunction:!1,allowImportExportEverywhere:!1,allowAwaitOutsideFunction:!1,allowHashBang:!1,locations:!1,onToken:null,onComment:null,ranges:!1,program:null,sourceFile:null,directSourceFile:null,preserveParens:!1,plugins:{}};function nt(t){var e={};for(var r in rt)e[r]=t&&J(t,r)?t[r]:rt[r];if(e.ecmaVersion>=2015&&(e.ecmaVersion-=2009),null==e.allowReserved&&(e.allowReserved=e.ecmaVersion<5),Q(e.onToken)){var n=e.onToken;e.onToken=function(t){return n.push(t)}}return Q(e.onComment)&&(e.onComment=function(t,e){return function(r,n,i,s,a,o){var u={type:r?"Block":"Line",value:n,start:i,end:s};t.locations&&(u.loc=new et(this,a,o)),t.ranges&&(u.range=[i,s]),e.push(u)}}(e,e.onComment)),e}var it={};function st(t){return new RegExp("^(?:"+t.replace(/ /g,"|")+")$")}var at=function(t,e,r){this.options=t=nt(t),this.sourceFile=t.sourceFile,this.keywords=st(w[t.ecmaVersion>=6?6:5]);var n="";if(!t.allowReserved){for(var i=t.ecmaVersion;!(n=_[i]);i--);"module"===t.sourceType&&(n+=" await")}this.reservedWords=st(n);var s=(n?n+" ":"")+_.strict;this.reservedWordsStrict=st(s),this.reservedWordsStrictBind=st(s+" "+_.strictBind),this.input=String(e),this.containsEsc=!1,this.loadPlugins(t.plugins),r?(this.pos=r,this.lineStart=this.input.lastIndexOf("\n",r-1)+1,this.curLine=this.input.slice(0,this.lineStart).split(G).length):(this.pos=this.lineStart=0,this.curLine=1),this.type=B.eof,this.value=null,this.start=this.end=this.pos,this.startLoc=this.endLoc=this.curPosition(),this.lastTokEndLoc=this.lastTokStartLoc=null,this.lastTokStart=this.lastTokEnd=this.pos,this.context=this.initialContext(),this.exprAllowed=!0,this.inModule="module"===t.sourceType,this.strict=this.inModule||this.strictDirective(this.pos),this.potentialArrowAt=-1,this.inFunction=this.inGenerator=this.inAsync=!1,this.yieldPos=this.awaitPos=0,this.labels=[],0===this.pos&&t.allowHashBang&&"#!"===this.input.slice(0,2)&&this.skipLineComment(2),this.scopeStack=[],this.enterFunctionScope(),this.regexpState=null};at.prototype.isKeyword=function(t){return this.keywords.test(t)},at.prototype.isReservedWord=function(t){return this.reservedWords.test(t)},at.prototype.extend=function(t,e){this[t]=e(this[t])},at.prototype.loadPlugins=function(t){for(var e in t){var r=it[e];if(!r)throw new Error("Plugin '"+e+"' not found");r(this,t[e])}},at.prototype.parse=function(){var t=this.options.program||this.startNode();return this.nextToken(),this.parseTopLevel(t)};var ot=at.prototype,ut=/^(?:'((?:\\.|[^'])*?)'|"((?:\\.|[^"])*?)"|;)/;function ht(){this.shorthandAssign=this.trailingComma=this.parenthesizedAssign=this.parenthesizedBind=this.doubleProto=-1}ot.strictDirective=function(t){for(;;){W.lastIndex=t,t+=W.exec(this.input)[0].length;var e=ut.exec(this.input.slice(t));if(!e)return!1;if("use strict"===(e[1]||e[2]))return!0;t+=e[0].length}},ot.eat=function(t){return this.type===t&&(this.next(),!0)},ot.isContextual=function(t){return this.type===B.name&&this.value===t&&!this.containsEsc},ot.eatContextual=function(t){return!!this.isContextual(t)&&(this.next(),!0)},ot.expectContextual=function(t){this.eatContextual(t)||this.unexpected()},ot.canInsertSemicolon=function(){return this.type===B.eof||this.type===B.braceR||G.test(this.input.slice(this.lastTokEnd,this.start))},ot.insertSemicolon=function(){if(this.canInsertSemicolon())return this.options.onInsertedSemicolon&&this.options.onInsertedSemicolon(this.lastTokEnd,this.lastTokEndLoc),!0},ot.semicolon=function(){this.eat(B.semi)||this.insertSemicolon()||this.unexpected()},ot.afterTrailingComma=function(t,e){if(this.type===t)return this.options.onTrailingComma&&this.options.onTrailingComma(this.lastTokStart,this.lastTokStartLoc),e||this.next(),!0},ot.expect=function(t){this.eat(t)||this.unexpected()},ot.unexpected=function(t){this.raise(null!=t?t:this.start,"Unexpected token")},ot.checkPatternErrors=function(t,e){if(t){t.trailingComma>-1&&this.raiseRecoverable(t.trailingComma,"Comma is not permitted after the rest element");var r=e?t.parenthesizedAssign:t.parenthesizedBind;r>-1&&this.raiseRecoverable(r,"Parenthesized pattern")}},ot.checkExpressionErrors=function(t,e){if(!t)return!1;var r=t.shorthandAssign,n=t.doubleProto;if(!e)return r>=0||n>=0;r>=0&&this.raise(r,"Shorthand property assignments are valid only in destructuring patterns"),n>=0&&this.raiseRecoverable(n,"Redefinition of __proto__ property")},ot.checkYieldAwaitInDefaultParams=function(){this.yieldPos&&(!this.awaitPos||this.yieldPos<this.awaitPos)&&this.raise(this.yieldPos,"Yield expression cannot be a default value"),this.awaitPos&&this.raise(this.awaitPos,"Await expression cannot be a default value")},ot.isSimpleAssignTarget=function(t){return"ParenthesizedExpression"===t.type?this.isSimpleAssignTarget(t.expression):"Identifier"===t.type||"MemberExpression"===t.type};var lt=at.prototype;lt.parseTopLevel=function(t){var e={};for(t.body||(t.body=[]);this.type!==B.eof;){var r=this.parseStatement(!0,!0,e);t.body.push(r)}return this.adaptDirectivePrologue(t.body),this.next(),this.options.ecmaVersion>=6&&(t.sourceType=this.options.sourceType),this.finishNode(t,"Program")};var ct={kind:"loop"},pt={kind:"switch"};lt.isLet=function(){if(this.options.ecmaVersion<6||!this.isContextual("let"))return!1;W.lastIndex=this.pos;var t=W.exec(this.input),e=this.pos+t[0].length,r=this.input.charCodeAt(e);if(91===r||123===r)return!0;if(O(r,!0)){for(var n=e+1;P(this.input.charCodeAt(n),!0);)++n;var i=this.input.slice(e,n);if(!I.test(i))return!0}return!1},lt.isAsyncFunction=function(){if(this.options.ecmaVersion<8||!this.isContextual("async"))return!1;W.lastIndex=this.pos;var t=W.exec(this.input),e=this.pos+t[0].length;return!(G.test(this.input.slice(this.pos,e))||"function"!==this.input.slice(e,e+8)||e+8!==this.input.length&&P(this.input.charAt(e+8)))},lt.parseStatement=function(t,e,r){var n,i=this.type,s=this.startNode();switch(this.isLet()&&(i=B._var,n="let"),i){case B._break:case B._continue:return this.parseBreakContinueStatement(s,i.keyword);case B._debugger:return this.parseDebuggerStatement(s);case B._do:return this.parseDoStatement(s);case B._for:return this.parseForStatement(s);case B._function:return!t&&this.options.ecmaVersion>=6&&this.unexpected(),this.parseFunctionStatement(s,!1);case B._class:return t||this.unexpected(),this.parseClass(s,!0);case B._if:return this.parseIfStatement(s);case B._return:return this.parseReturnStatement(s);case B._switch:return this.parseSwitchStatement(s);case B._throw:return this.parseThrowStatement(s);case B._try:return this.parseTryStatement(s);case B._const:case B._var:return n=n||this.value,t||"var"===n||this.unexpected(),this.parseVarStatement(s,n);case B._while:return this.parseWhileStatement(s);case B._with:return this.parseWithStatement(s);case B.braceL:return this.parseBlock();case B.semi:return this.parseEmptyStatement(s);case B._export:case B._import:return this.options.allowImportExportEverywhere||(e||this.raise(this.start,"'import' and 'export' may only appear at the top level"),this.inModule||this.raise(this.start,"'import' and 'export' may appear only with 'sourceType: module'")),i===B._import?this.parseImport(s):this.parseExport(s,r);default:if(this.isAsyncFunction())return t||this.unexpected(),this.next(),this.parseFunctionStatement(s,!0);var a=this.value,o=this.parseExpression();return i===B.name&&"Identifier"===o.type&&this.eat(B.colon)?this.parseLabeledStatement(s,a,o):this.parseExpressionStatement(s,o)}},lt.parseBreakContinueStatement=function(t,e){var r="break"===e;this.next(),this.eat(B.semi)||this.insertSemicolon()?t.label=null:this.type!==B.name?this.unexpected():(t.label=this.parseIdent(),this.semicolon());for(var n=0;n<this.labels.length;++n){var i=this.labels[n];if(null==t.label||i.name===t.label.name){if(null!=i.kind&&(r||"loop"===i.kind))break;if(t.label&&r)break}}return n===this.labels.length&&this.raise(t.start,"Unsyntactic "+e),this.finishNode(t,r?"BreakStatement":"ContinueStatement")},lt.parseDebuggerStatement=function(t){return this.next(),this.semicolon(),this.finishNode(t,"DebuggerStatement")},lt.parseDoStatement=function(t){return this.next(),this.labels.push(ct),t.body=this.parseStatement(!1),this.labels.pop(),this.expect(B._while),t.test=this.parseParenExpression(),this.options.ecmaVersion>=6?this.eat(B.semi):this.semicolon(),this.finishNode(t,"DoWhileStatement")},lt.parseForStatement=function(t){this.next();var e=this.options.ecmaVersion>=9&&(this.inAsync||!this.inFunction&&this.options.allowAwaitOutsideFunction)&&this.eatContextual("await")?this.lastTokStart:-1;if(this.labels.push(ct),this.enterLexicalScope(),this.expect(B.parenL),this.type===B.semi)return e>-1&&this.unexpected(e),this.parseFor(t,null);var r=this.isLet();if(this.type===B._var||this.type===B._const||r){var n=this.startNode(),i=r?"let":this.value;return this.next(),this.parseVar(n,!0,i),this.finishNode(n,"VariableDeclaration"),!(this.type===B._in||this.options.ecmaVersion>=6&&this.isContextual("of"))||1!==n.declarations.length||"var"!==i&&n.declarations[0].init?(e>-1&&this.unexpected(e),this.parseFor(t,n)):(this.options.ecmaVersion>=9&&(this.type===B._in?e>-1&&this.unexpected(e):t.await=e>-1),this.parseForIn(t,n))}var s=new ht,a=this.parseExpression(!0,s);return this.type===B._in||this.options.ecmaVersion>=6&&this.isContextual("of")?(this.options.ecmaVersion>=9&&(this.type===B._in?e>-1&&this.unexpected(e):t.await=e>-1),this.toAssignable(a,!1,s),this.checkLVal(a),this.parseForIn(t,a)):(this.checkExpressionErrors(s,!0),e>-1&&this.unexpected(e),this.parseFor(t,a))},lt.parseFunctionStatement=function(t,e){return this.next(),this.parseFunction(t,!0,!1,e)},lt.parseIfStatement=function(t){return this.next(),t.test=this.parseParenExpression(),t.consequent=this.parseStatement(!this.strict&&this.type===B._function),t.alternate=this.eat(B._else)?this.parseStatement(!this.strict&&this.type===B._function):null,this.finishNode(t,"IfStatement")},lt.parseReturnStatement=function(t){return this.inFunction||this.options.allowReturnOutsideFunction||this.raise(this.start,"'return' outside of function"),this.next(),this.eat(B.semi)||this.insertSemicolon()?t.argument=null:(t.argument=this.parseExpression(),this.semicolon()),this.finishNode(t,"ReturnStatement")},lt.parseSwitchStatement=function(t){var e;this.next(),t.discriminant=this.parseParenExpression(),t.cases=[],this.expect(B.braceL),this.labels.push(pt),this.enterLexicalScope();for(var r=!1;this.type!==B.braceR;)if(this.type===B._case||this.type===B._default){var n=this.type===B._case;e&&this.finishNode(e,"SwitchCase"),t.cases.push(e=this.startNode()),e.consequent=[],this.next(),n?e.test=this.parseExpression():(r&&this.raiseRecoverable(this.lastTokStart,"Multiple default clauses"),r=!0,e.test=null),this.expect(B.colon)}else e||this.unexpected(),e.consequent.push(this.parseStatement(!0));return this.exitLexicalScope(),e&&this.finishNode(e,"SwitchCase"),this.next(),this.labels.pop(),this.finishNode(t,"SwitchStatement")},lt.parseThrowStatement=function(t){return this.next(),G.test(this.input.slice(this.lastTokEnd,this.start))&&this.raise(this.lastTokEnd,"Illegal newline after throw"),t.argument=this.parseExpression(),this.semicolon(),this.finishNode(t,"ThrowStatement")};var dt=[];lt.parseTryStatement=function(t){if(this.next(),t.block=this.parseBlock(),t.handler=null,this.type===B._catch){var e=this.startNode();this.next(),this.eat(B.parenL)?(e.param=this.parseBindingAtom(),this.enterLexicalScope(),this.checkLVal(e.param,"let"),this.expect(B.parenR)):(this.options.ecmaVersion<10&&this.unexpected(),e.param=null,this.enterLexicalScope()),e.body=this.parseBlock(!1),this.exitLexicalScope(),t.handler=this.finishNode(e,"CatchClause")}return t.finalizer=this.eat(B._finally)?this.parseBlock():null,t.handler||t.finalizer||this.raise(t.start,"Missing catch or finally clause"),this.finishNode(t,"TryStatement")},lt.parseVarStatement=function(t,e){return this.next(),this.parseVar(t,!1,e),this.semicolon(),this.finishNode(t,"VariableDeclaration")},lt.parseWhileStatement=function(t){return this.next(),t.test=this.parseParenExpression(),this.labels.push(ct),t.body=this.parseStatement(!1),this.labels.pop(),this.finishNode(t,"WhileStatement")},lt.parseWithStatement=function(t){return this.strict&&this.raise(this.start,"'with' in strict mode"),this.next(),t.object=this.parseParenExpression(),t.body=this.parseStatement(!1),this.finishNode(t,"WithStatement")},lt.parseEmptyStatement=function(t){return this.next(),this.finishNode(t,"EmptyStatement")},lt.parseLabeledStatement=function(t,e,r){for(var n=0,i=this.labels;n<i.length;n+=1){i[n].name===e&&this.raise(r.start,"Label '"+e+"' is already declared")}for(var s=this.type.isLoop?"loop":this.type===B._switch?"switch":null,a=this.labels.length-1;a>=0;a--){var o=this.labels[a];if(o.statementStart!==t.start)break;o.statementStart=this.start,o.kind=s}return this.labels.push({name:e,kind:s,statementStart:this.start}),t.body=this.parseStatement(!0),("ClassDeclaration"===t.body.type||"VariableDeclaration"===t.body.type&&"var"!==t.body.kind||"FunctionDeclaration"===t.body.type&&(this.strict||t.body.generator||t.body.async))&&this.raiseRecoverable(t.body.start,"Invalid labeled declaration"),this.labels.pop(),t.label=r,this.finishNode(t,"LabeledStatement")},lt.parseExpressionStatement=function(t,e){return t.expression=e,this.semicolon(),this.finishNode(t,"ExpressionStatement")},lt.parseBlock=function(t){void 0===t&&(t=!0);var e=this.startNode();for(e.body=[],this.expect(B.braceL),t&&this.enterLexicalScope();!this.eat(B.braceR);){var r=this.parseStatement(!0);e.body.push(r)}return t&&this.exitLexicalScope(),this.finishNode(e,"BlockStatement")},lt.parseFor=function(t,e){return t.init=e,this.expect(B.semi),t.test=this.type===B.semi?null:this.parseExpression(),this.expect(B.semi),t.update=this.type===B.parenR?null:this.parseExpression(),this.expect(B.parenR),this.exitLexicalScope(),t.body=this.parseStatement(!1),this.labels.pop(),this.finishNode(t,"ForStatement")},lt.parseForIn=function(t,e){var r=this.type===B._in?"ForInStatement":"ForOfStatement";return this.next(),"ForInStatement"===r&&("AssignmentPattern"===e.type||"VariableDeclaration"===e.type&&null!=e.declarations[0].init&&(this.strict||"Identifier"!==e.declarations[0].id.type))&&this.raise(e.start,"Invalid assignment in for-in loop head"),t.left=e,t.right="ForInStatement"===r?this.parseExpression():this.parseMaybeAssign(),this.expect(B.parenR),this.exitLexicalScope(),t.body=this.parseStatement(!1),this.labels.pop(),this.finishNode(t,r)},lt.parseVar=function(t,e,r){for(t.declarations=[],t.kind=r;;){var n=this.startNode();if(this.parseVarId(n,r),this.eat(B.eq)?n.init=this.parseMaybeAssign(e):"const"!==r||this.type===B._in||this.options.ecmaVersion>=6&&this.isContextual("of")?"Identifier"===n.id.type||e&&(this.type===B._in||this.isContextual("of"))?n.init=null:this.raise(this.lastTokEnd,"Complex binding patterns require an initialization value"):this.unexpected(),t.declarations.push(this.finishNode(n,"VariableDeclarator")),!this.eat(B.comma))break}return t},lt.parseVarId=function(t,e){t.id=this.parseBindingAtom(e),this.checkLVal(t.id,e,!1)},lt.parseFunction=function(t,e,r,n){this.initFunction(t),(this.options.ecmaVersion>=9||this.options.ecmaVersion>=6&&!n)&&(t.generator=this.eat(B.star)),this.options.ecmaVersion>=8&&(t.async=!!n),e&&(t.id="nullableID"===e&&this.type!==B.name?null:this.parseIdent(),t.id&&this.checkLVal(t.id,this.inModule&&!this.inFunction?"let":"var"));var i=this.inGenerator,s=this.inAsync,a=this.yieldPos,o=this.awaitPos,u=this.inFunction;return this.inGenerator=t.generator,this.inAsync=t.async,this.yieldPos=0,this.awaitPos=0,this.inFunction=!0,this.enterFunctionScope(),e||(t.id=this.type===B.name?this.parseIdent():null),this.parseFunctionParams(t),this.parseFunctionBody(t,r),this.inGenerator=i,this.inAsync=s,this.yieldPos=a,this.awaitPos=o,this.inFunction=u,this.finishNode(t,e?"FunctionDeclaration":"FunctionExpression")},lt.parseFunctionParams=function(t){this.expect(B.parenL),t.params=this.parseBindingList(B.parenR,!1,this.options.ecmaVersion>=8),this.checkYieldAwaitInDefaultParams()},lt.parseClass=function(t,e){this.next(),this.parseClassId(t,e),this.parseClassSuper(t);var r=this.startNode(),n=!1;for(r.body=[],this.expect(B.braceL);!this.eat(B.braceR);){var i=this.parseClassMember(r);i&&"MethodDefinition"===i.type&&"constructor"===i.kind&&(n&&this.raise(i.start,"Duplicate constructor in the same class"),n=!0)}return t.body=this.finishNode(r,"ClassBody"),this.finishNode(t,e?"ClassDeclaration":"ClassExpression")},lt.parseClassMember=function(t){var e=this;if(this.eat(B.semi))return null;var r=this.startNode(),n=function(t,n){void 0===n&&(n=!1);var i=e.start,s=e.startLoc;return!!e.eatContextual(t)&&(!(e.type===B.parenL||n&&e.canInsertSemicolon())||(r.key&&e.unexpected(),r.computed=!1,r.key=e.startNodeAt(i,s),r.key.name=t,e.finishNode(r.key,"Identifier"),!1))};r.kind="method",r.static=n("static");var i=this.eat(B.star),s=!1;i||(this.options.ecmaVersion>=8&&n("async",!0)?(s=!0,i=this.options.ecmaVersion>=9&&this.eat(B.star)):n("get")?r.kind="get":n("set")&&(r.kind="set")),r.key||this.parsePropertyName(r);var a=r.key;return r.computed||r.static||!("Identifier"===a.type&&"constructor"===a.name||"Literal"===a.type&&"constructor"===a.value)?r.static&&"Identifier"===a.type&&"prototype"===a.name&&this.raise(a.start,"Classes may not have a static property named prototype"):("method"!==r.kind&&this.raise(a.start,"Constructor can't have get/set modifier"),i&&this.raise(a.start,"Constructor can't be a generator"),s&&this.raise(a.start,"Constructor can't be an async method"),r.kind="constructor"),this.parseClassMethod(t,r,i,s),"get"===r.kind&&0!==r.value.params.length&&this.raiseRecoverable(r.value.start,"getter should have no params"),"set"===r.kind&&1!==r.value.params.length&&this.raiseRecoverable(r.value.start,"setter should have exactly one param"),"set"===r.kind&&"RestElement"===r.value.params[0].type&&this.raiseRecoverable(r.value.params[0].start,"Setter cannot use rest params"),r},lt.parseClassMethod=function(t,e,r,n){e.value=this.parseMethod(r,n),t.body.push(this.finishNode(e,"MethodDefinition"))},lt.parseClassId=function(t,e){t.id=this.type===B.name?this.parseIdent():!0===e?this.unexpected():null},lt.parseClassSuper=function(t){t.superClass=this.eat(B._extends)?this.parseExprSubscripts():null},lt.parseExport=function(t,e){if(this.next(),this.eat(B.star))return this.expectContextual("from"),this.type!==B.string&&this.unexpected(),t.source=this.parseExprAtom(),this.semicolon(),this.finishNode(t,"ExportAllDeclaration");if(this.eat(B._default)){var r;if(this.checkExport(e,"default",this.lastTokStart),this.type===B._function||(r=this.isAsyncFunction())){var n=this.startNode();this.next(),r&&this.next(),t.declaration=this.parseFunction(n,"nullableID",!1,r)}else if(this.type===B._class){var i=this.startNode();t.declaration=this.parseClass(i,"nullableID")}else t.declaration=this.parseMaybeAssign(),this.semicolon();return this.finishNode(t,"ExportDefaultDeclaration")}if(this.shouldParseExportStatement())t.declaration=this.parseStatement(!0),"VariableDeclaration"===t.declaration.type?this.checkVariableExport(e,t.declaration.declarations):this.checkExport(e,t.declaration.id.name,t.declaration.id.start),t.specifiers=[],t.source=null;else{if(t.declaration=null,t.specifiers=this.parseExportSpecifiers(e),this.eatContextual("from"))this.type!==B.string&&this.unexpected(),t.source=this.parseExprAtom();else{for(var s=0,a=t.specifiers;s<a.length;s+=1){var o=a[s];this.checkUnreserved(o.local)}t.source=null}this.semicolon()}return this.finishNode(t,"ExportNamedDeclaration")},lt.checkExport=function(t,e,r){t&&(J(t,e)&&this.raiseRecoverable(r,"Duplicate export '"+e+"'"),t[e]=!0)},lt.checkPatternExport=function(t,e){var r=e.type;if("Identifier"===r)this.checkExport(t,e.name,e.start);else if("ObjectPattern"===r)for(var n=0,i=e.properties;n<i.length;n+=1){var s=i[n];this.checkPatternExport(t,s)}else if("ArrayPattern"===r)for(var a=0,o=e.elements;a<o.length;a+=1){var u=o[a];u&&this.checkPatternExport(t,u)}else"Property"===r?this.checkPatternExport(t,e.value):"AssignmentPattern"===r?this.checkPatternExport(t,e.left):"RestElement"===r?this.checkPatternExport(t,e.argument):"ParenthesizedExpression"===r&&this.checkPatternExport(t,e.expression)},lt.checkVariableExport=function(t,e){if(t)for(var r=0,n=e;r<n.length;r+=1){var i=n[r];this.checkPatternExport(t,i.id)}},lt.shouldParseExportStatement=function(){return"var"===this.type.keyword||"const"===this.type.keyword||"class"===this.type.keyword||"function"===this.type.keyword||this.isLet()||this.isAsyncFunction()},lt.parseExportSpecifiers=function(t){var e=[],r=!0;for(this.expect(B.braceL);!this.eat(B.braceR);){if(r)r=!1;else if(this.expect(B.comma),this.afterTrailingComma(B.braceR))break;var n=this.startNode();n.local=this.parseIdent(!0),n.exported=this.eatContextual("as")?this.parseIdent(!0):n.local,this.checkExport(t,n.exported.name,n.exported.start),e.push(this.finishNode(n,"ExportSpecifier"))}return e},lt.parseImport=function(t){return this.next(),this.type===B.string?(t.specifiers=dt,t.source=this.parseExprAtom()):(t.specifiers=this.parseImportSpecifiers(),this.expectContextual("from"),t.source=this.type===B.string?this.parseExprAtom():this.unexpected()),this.semicolon(),this.finishNode(t,"ImportDeclaration")},lt.parseImportSpecifiers=function(){var t=[],e=!0;if(this.type===B.name){var r=this.startNode();if(r.local=this.parseIdent(),this.checkLVal(r.local,"let"),t.push(this.finishNode(r,"ImportDefaultSpecifier")),!this.eat(B.comma))return t}if(this.type===B.star){var n=this.startNode();return this.next(),this.expectContextual("as"),n.local=this.parseIdent(),this.checkLVal(n.local,"let"),t.push(this.finishNode(n,"ImportNamespaceSpecifier")),t}for(this.expect(B.braceL);!this.eat(B.braceR);){if(e)e=!1;else if(this.expect(B.comma),this.afterTrailingComma(B.braceR))break;var i=this.startNode();i.imported=this.parseIdent(!0),this.eatContextual("as")?i.local=this.parseIdent():(this.checkUnreserved(i.imported),i.local=i.imported),this.checkLVal(i.local,"let"),t.push(this.finishNode(i,"ImportSpecifier"))}return t},lt.adaptDirectivePrologue=function(t){for(var e=0;e<t.length&&this.isDirectiveCandidate(t[e]);++e)t[e].directive=t[e].expression.raw.slice(1,-1)},lt.isDirectiveCandidate=function(t){return"ExpressionStatement"===t.type&&"Literal"===t.expression.type&&"string"==typeof t.expression.value&&('"'===this.input[t.start]||"'"===this.input[t.start])};var mt=at.prototype;mt.toAssignable=function(t,e,r){if(this.options.ecmaVersion>=6&&t)switch(t.type){case"Identifier":this.inAsync&&"await"===t.name&&this.raise(t.start,"Can not use 'await' as identifier inside an async function");break;case"ObjectPattern":case"ArrayPattern":case"RestElement":break;case"ObjectExpression":t.type="ObjectPattern",r&&this.checkPatternErrors(r,!0);for(var n=0,i=t.properties;n<i.length;n+=1){var s=i[n];this.toAssignable(s,e),"RestElement"!==s.type||"ArrayPattern"!==s.argument.type&&"ObjectPattern"!==s.argument.type||this.raise(s.argument.start,"Unexpected token")}break;case"Property":"init"!==t.kind&&this.raise(t.key.start,"Object pattern can't contain getter or setter"),this.toAssignable(t.value,e);break;case"ArrayExpression":t.type="ArrayPattern",r&&this.checkPatternErrors(r,!0),this.toAssignableList(t.elements,e);break;case"SpreadElement":t.type="RestElement",this.toAssignable(t.argument,e),"AssignmentPattern"===t.argument.type&&this.raise(t.argument.start,"Rest elements cannot have a default value");break;case"AssignmentExpression":"="!==t.operator&&this.raise(t.left.end,"Only '=' operator can be used for specifying default value."),t.type="AssignmentPattern",delete t.operator,this.toAssignable(t.left,e);case"AssignmentPattern":break;case"ParenthesizedExpression":this.toAssignable(t.expression,e);break;case"MemberExpression":if(!e)break;default:this.raise(t.start,"Assigning to rvalue")}else r&&this.checkPatternErrors(r,!0);return t},mt.toAssignableList=function(t,e){for(var r=t.length,n=0;n<r;n++){var i=t[n];i&&this.toAssignable(i,e)}if(r){var s=t[r-1];6===this.options.ecmaVersion&&e&&s&&"RestElement"===s.type&&"Identifier"!==s.argument.type&&this.unexpected(s.argument.start)}return t},mt.parseSpread=function(t){var e=this.startNode();return this.next(),e.argument=this.parseMaybeAssign(!1,t),this.finishNode(e,"SpreadElement")},mt.parseRestBinding=function(){var t=this.startNode();return this.next(),6===this.options.ecmaVersion&&this.type!==B.name&&this.unexpected(),t.argument=this.parseBindingAtom(),this.finishNode(t,"RestElement")},mt.parseBindingAtom=function(){if(this.options.ecmaVersion>=6)switch(this.type){case B.bracketL:var t=this.startNode();return this.next(),t.elements=this.parseBindingList(B.bracketR,!0,!0),this.finishNode(t,"ArrayPattern");case B.braceL:return this.parseObj(!0)}return this.parseIdent()},mt.parseBindingList=function(t,e,r){for(var n=[],i=!0;!this.eat(t);)if(i?i=!1:this.expect(B.comma),e&&this.type===B.comma)n.push(null);else{if(r&&this.afterTrailingComma(t))break;if(this.type===B.ellipsis){var s=this.parseRestBinding();this.parseBindingListItem(s),n.push(s),this.type===B.comma&&this.raise(this.start,"Comma is not permitted after the rest element"),this.expect(t);break}var a=this.parseMaybeDefault(this.start,this.startLoc);this.parseBindingListItem(a),n.push(a)}return n},mt.parseBindingListItem=function(t){return t},mt.parseMaybeDefault=function(t,e,r){if(r=r||this.parseBindingAtom(),this.options.ecmaVersion<6||!this.eat(B.eq))return r;var n=this.startNodeAt(t,e);return n.left=r,n.right=this.parseMaybeAssign(),this.finishNode(n,"AssignmentPattern")},mt.checkLVal=function(t,e,r){switch(t.type){case"Identifier":this.strict&&this.reservedWordsStrictBind.test(t.name)&&this.raiseRecoverable(t.start,(e?"Binding ":"Assigning to ")+t.name+" in strict mode"),r&&(J(r,t.name)&&this.raiseRecoverable(t.start,"Argument name clash"),r[t.name]=!0),e&&"none"!==e&&(("var"===e&&!this.canDeclareVarName(t.name)||"var"!==e&&!this.canDeclareLexicalName(t.name))&&this.raiseRecoverable(t.start,"Identifier '"+t.name+"' has already been declared"),"var"===e?this.declareVarName(t.name):this.declareLexicalName(t.name));break;case"MemberExpression":e&&this.raiseRecoverable(t.start,"Binding member expression");break;case"ObjectPattern":for(var n=0,i=t.properties;n<i.length;n+=1){var s=i[n];this.checkLVal(s,e,r)}break;case"Property":this.checkLVal(t.value,e,r);break;case"ArrayPattern":for(var a=0,o=t.elements;a<o.length;a+=1){var u=o[a];u&&this.checkLVal(u,e,r)}break;case"AssignmentPattern":this.checkLVal(t.left,e,r);break;case"RestElement":this.checkLVal(t.argument,e,r);break;case"ParenthesizedExpression":this.checkLVal(t.expression,e,r);break;default:this.raise(t.start,(e?"Binding":"Assigning to")+" rvalue")}};var ft=at.prototype;ft.checkPropClash=function(t,e,r){if(!(this.options.ecmaVersion>=9&&"SpreadElement"===t.type||this.options.ecmaVersion>=6&&(t.computed||t.method||t.shorthand))){var n,i=t.key;switch(i.type){case"Identifier":n=i.name;break;case"Literal":n=String(i.value);break;default:return}var s=t.kind;if(this.options.ecmaVersion>=6)"__proto__"===n&&"init"===s&&(e.proto&&(r&&r.doubleProto<0?r.doubleProto=i.start:this.raiseRecoverable(i.start,"Redefinition of __proto__ property")),e.proto=!0);else{var a=e[n="$"+n];if(a)("init"===s?this.strict&&a.init||a.get||a.set:a.init||a[s])&&this.raiseRecoverable(i.start,"Redefinition of property");else a=e[n]={init:!1,get:!1,set:!1};a[s]=!0}}},ft.parseExpression=function(t,e){var r=this.start,n=this.startLoc,i=this.parseMaybeAssign(t,e);if(this.type===B.comma){var s=this.startNodeAt(r,n);for(s.expressions=[i];this.eat(B.comma);)s.expressions.push(this.parseMaybeAssign(t,e));return this.finishNode(s,"SequenceExpression")}return i},ft.parseMaybeAssign=function(t,e,r){if(this.inGenerator&&this.isContextual("yield"))return this.parseYield();var n=!1,i=-1,s=-1;e?(i=e.parenthesizedAssign,s=e.trailingComma,e.parenthesizedAssign=e.trailingComma=-1):(e=new ht,n=!0);var a=this.start,o=this.startLoc;this.type!==B.parenL&&this.type!==B.name||(this.potentialArrowAt=this.start);var u=this.parseMaybeConditional(t,e);if(r&&(u=r.call(this,u,a,o)),this.type.isAssign){var h=this.startNodeAt(a,o);return h.operator=this.value,h.left=this.type===B.eq?this.toAssignable(u,!1,e):u,n||ht.call(e),e.shorthandAssign=-1,this.checkLVal(u),this.next(),h.right=this.parseMaybeAssign(t),this.finishNode(h,"AssignmentExpression")}return n&&this.checkExpressionErrors(e,!0),i>-1&&(e.parenthesizedAssign=i),s>-1&&(e.trailingComma=s),u},ft.parseMaybeConditional=function(t,e){var r=this.start,n=this.startLoc,i=this.parseExprOps(t,e);if(this.checkExpressionErrors(e))return i;if(this.eat(B.question)){var s=this.startNodeAt(r,n);return s.test=i,s.consequent=this.parseMaybeAssign(),this.expect(B.colon),s.alternate=this.parseMaybeAssign(t),this.finishNode(s,"ConditionalExpression")}return i},ft.parseExprOps=function(t,e){var r=this.start,n=this.startLoc,i=this.parseMaybeUnary(e,!1);return this.checkExpressionErrors(e)?i:i.start===r&&"ArrowFunctionExpression"===i.type?i:this.parseExprOp(i,r,n,-1,t)},ft.parseExprOp=function(t,e,r,n,i){var s=this.type.binop;if(null!=s&&(!i||this.type!==B._in)&&s>n){var a=this.type===B.logicalOR||this.type===B.logicalAND,o=this.value;this.next();var u=this.start,h=this.startLoc,l=this.parseExprOp(this.parseMaybeUnary(null,!1),u,h,s,i),c=this.buildBinary(e,r,t,l,o,a);return this.parseExprOp(c,e,r,n,i)}return t},ft.buildBinary=function(t,e,r,n,i,s){var a=this.startNodeAt(t,e);return a.left=r,a.operator=i,a.right=n,this.finishNode(a,s?"LogicalExpression":"BinaryExpression")},ft.parseMaybeUnary=function(t,e){var r,n=this.start,i=this.startLoc;if(this.isContextual("await")&&(this.inAsync||!this.inFunction&&this.options.allowAwaitOutsideFunction))r=this.parseAwait(),e=!0;else if(this.type.prefix){var s=this.startNode(),a=this.type===B.incDec;s.operator=this.value,s.prefix=!0,this.next(),s.argument=this.parseMaybeUnary(null,!0),this.checkExpressionErrors(t,!0),a?this.checkLVal(s.argument):this.strict&&"delete"===s.operator&&"Identifier"===s.argument.type?this.raiseRecoverable(s.start,"Deleting local variable in strict mode"):e=!0,r=this.finishNode(s,a?"UpdateExpression":"UnaryExpression")}else{if(r=this.parseExprSubscripts(t),this.checkExpressionErrors(t))return r;for(;this.type.postfix&&!this.canInsertSemicolon();){var o=this.startNodeAt(n,i);o.operator=this.value,o.prefix=!1,o.argument=r,this.checkLVal(r),this.next(),r=this.finishNode(o,"UpdateExpression")}}return!e&&this.eat(B.starstar)?this.buildBinary(n,i,r,this.parseMaybeUnary(null,!1),"**",!1):r},ft.parseExprSubscripts=function(t){var e=this.start,r=this.startLoc,n=this.parseExprAtom(t),i="ArrowFunctionExpression"===n.type&&")"!==this.input.slice(this.lastTokStart,this.lastTokEnd);if(this.checkExpressionErrors(t)||i)return n;var s=this.parseSubscripts(n,e,r);return t&&"MemberExpression"===s.type&&(t.parenthesizedAssign>=s.start&&(t.parenthesizedAssign=-1),t.parenthesizedBind>=s.start&&(t.parenthesizedBind=-1)),s},ft.parseSubscripts=function(t,e,r,n){for(var i=this.options.ecmaVersion>=8&&"Identifier"===t.type&&"async"===t.name&&this.lastTokEnd===t.end&&!this.canInsertSemicolon()&&"async"===this.input.slice(t.start,t.end),s=void 0;;)if((s=this.eat(B.bracketL))||this.eat(B.dot)){var a=this.startNodeAt(e,r);a.object=t,a.property=s?this.parseExpression():this.parseIdent(!0),a.computed=!!s,s&&this.expect(B.bracketR),t=this.finishNode(a,"MemberExpression")}else if(!n&&this.eat(B.parenL)){var o=new ht,u=this.yieldPos,h=this.awaitPos;this.yieldPos=0,this.awaitPos=0;var l=this.parseExprList(B.parenR,this.options.ecmaVersion>=8,!1,o);if(i&&!this.canInsertSemicolon()&&this.eat(B.arrow))return this.checkPatternErrors(o,!1),this.checkYieldAwaitInDefaultParams(),this.yieldPos=u,this.awaitPos=h,this.parseArrowExpression(this.startNodeAt(e,r),l,!0);this.checkExpressionErrors(o,!0),this.yieldPos=u||this.yieldPos,this.awaitPos=h||this.awaitPos;var c=this.startNodeAt(e,r);c.callee=t,c.arguments=l,t=this.finishNode(c,"CallExpression")}else{if(this.type!==B.backQuote)return t;var p=this.startNodeAt(e,r);p.tag=t,p.quasi=this.parseTemplate({isTagged:!0}),t=this.finishNode(p,"TaggedTemplateExpression")}},ft.parseExprAtom=function(t){var e,r=this.potentialArrowAt===this.start;switch(this.type){case B._super:return this.inFunction||this.raise(this.start,"'super' outside of function or class"),e=this.startNode(),this.next(),this.type!==B.dot&&this.type!==B.bracketL&&this.type!==B.parenL&&this.unexpected(),this.finishNode(e,"Super");case B._this:return e=this.startNode(),this.next(),this.finishNode(e,"ThisExpression");case B.name:var n=this.start,i=this.startLoc,s=this.containsEsc,a=this.parseIdent(this.type!==B.name);if(this.options.ecmaVersion>=8&&!s&&"async"===a.name&&!this.canInsertSemicolon()&&this.eat(B._function))return this.parseFunction(this.startNodeAt(n,i),!1,!1,!0);if(r&&!this.canInsertSemicolon()){if(this.eat(B.arrow))return this.parseArrowExpression(this.startNodeAt(n,i),[a],!1);if(this.options.ecmaVersion>=8&&"async"===a.name&&this.type===B.name&&!s)return a=this.parseIdent(),!this.canInsertSemicolon()&&this.eat(B.arrow)||this.unexpected(),this.parseArrowExpression(this.startNodeAt(n,i),[a],!0)}return a;case B.regexp:var o=this.value;return(e=this.parseLiteral(o.value)).regex={pattern:o.pattern,flags:o.flags},e;case B.num:case B.string:return this.parseLiteral(this.value);case B._null:case B._true:case B._false:return(e=this.startNode()).value=this.type===B._null?null:this.type===B._true,e.raw=this.type.keyword,this.next(),this.finishNode(e,"Literal");case B.parenL:var u=this.start,h=this.parseParenAndDistinguishExpression(r);return t&&(t.parenthesizedAssign<0&&!this.isSimpleAssignTarget(h)&&(t.parenthesizedAssign=u),t.parenthesizedBind<0&&(t.parenthesizedBind=u)),h;case B.bracketL:return e=this.startNode(),this.next(),e.elements=this.parseExprList(B.bracketR,!0,!0,t),this.finishNode(e,"ArrayExpression");case B.braceL:return this.parseObj(!1,t);case B._function:return e=this.startNode(),this.next(),this.parseFunction(e,!1);case B._class:return this.parseClass(this.startNode(),!1);case B._new:return this.parseNew();case B.backQuote:return this.parseTemplate();default:this.unexpected()}},ft.parseLiteral=function(t){var e=this.startNode();return e.value=t,e.raw=this.input.slice(this.start,this.end),this.next(),this.finishNode(e,"Literal")},ft.parseParenExpression=function(){this.expect(B.parenL);var t=this.parseExpression();return this.expect(B.parenR),t},ft.parseParenAndDistinguishExpression=function(t){var e,r=this.start,n=this.startLoc,i=this.options.ecmaVersion>=8;if(this.options.ecmaVersion>=6){this.next();var s,a=this.start,o=this.startLoc,u=[],h=!0,l=!1,c=new ht,p=this.yieldPos,d=this.awaitPos;for(this.yieldPos=0,this.awaitPos=0;this.type!==B.parenR;){if(h?h=!1:this.expect(B.comma),i&&this.afterTrailingComma(B.parenR,!0)){l=!0;break}if(this.type===B.ellipsis){s=this.start,u.push(this.parseParenItem(this.parseRestBinding())),this.type===B.comma&&this.raise(this.start,"Comma is not permitted after the rest element");break}u.push(this.parseMaybeAssign(!1,c,this.parseParenItem))}var m=this.start,f=this.startLoc;if(this.expect(B.parenR),t&&!this.canInsertSemicolon()&&this.eat(B.arrow))return this.checkPatternErrors(c,!1),this.checkYieldAwaitInDefaultParams(),this.yieldPos=p,this.awaitPos=d,this.parseParenArrowList(r,n,u);u.length&&!l||this.unexpected(this.lastTokStart),s&&this.unexpected(s),this.checkExpressionErrors(c,!0),this.yieldPos=p||this.yieldPos,this.awaitPos=d||this.awaitPos,u.length>1?((e=this.startNodeAt(a,o)).expressions=u,this.finishNodeAt(e,"SequenceExpression",m,f)):e=u[0]}else e=this.parseParenExpression();if(this.options.preserveParens){var g=this.startNodeAt(r,n);return g.expression=e,this.finishNode(g,"ParenthesizedExpression")}return e},ft.parseParenItem=function(t){return t},ft.parseParenArrowList=function(t,e,r){return this.parseArrowExpression(this.startNodeAt(t,e),r)};var gt=[];ft.parseNew=function(){var t=this.startNode(),e=this.parseIdent(!0);if(this.options.ecmaVersion>=6&&this.eat(B.dot)){t.meta=e;var r=this.containsEsc;return t.property=this.parseIdent(!0),("target"!==t.property.name||r)&&this.raiseRecoverable(t.property.start,"The only valid meta property for new is new.target"),this.inFunction||this.raiseRecoverable(t.start,"new.target can only be used in functions"),this.finishNode(t,"MetaProperty")}var n=this.start,i=this.startLoc;return t.callee=this.parseSubscripts(this.parseExprAtom(),n,i,!0),this.eat(B.parenL)?t.arguments=this.parseExprList(B.parenR,this.options.ecmaVersion>=8,!1):t.arguments=gt,this.finishNode(t,"NewExpression")},ft.parseTemplateElement=function(t){var e=t.isTagged,r=this.startNode();return this.type===B.invalidTemplate?(e||this.raiseRecoverable(this.start,"Bad escape sequence in untagged template literal"),r.value={raw:this.value,cooked:null}):r.value={raw:this.input.slice(this.start,this.end).replace(/\r\n?/g,"\n"),cooked:this.value},this.next(),r.tail=this.type===B.backQuote,this.finishNode(r,"TemplateElement")},ft.parseTemplate=function(t){void 0===t&&(t={});var e=t.isTagged;void 0===e&&(e=!1);var r=this.startNode();this.next(),r.expressions=[];var n=this.parseTemplateElement({isTagged:e});for(r.quasis=[n];!n.tail;)this.type===B.eof&&this.raise(this.pos,"Unterminated template literal"),this.expect(B.dollarBraceL),r.expressions.push(this.parseExpression()),this.expect(B.braceR),r.quasis.push(n=this.parseTemplateElement({isTagged:e}));return this.next(),this.finishNode(r,"TemplateLiteral")},ft.isAsyncProp=function(t){return!t.computed&&"Identifier"===t.key.type&&"async"===t.key.name&&(this.type===B.name||this.type===B.num||this.type===B.string||this.type===B.bracketL||this.type.keyword||this.options.ecmaVersion>=9&&this.type===B.star)&&!G.test(this.input.slice(this.lastTokEnd,this.start))},ft.parseObj=function(t,e){var r=this.startNode(),n=!0,i={};for(r.properties=[],this.next();!this.eat(B.braceR);){if(n)n=!1;else if(this.expect(B.comma),this.afterTrailingComma(B.braceR))break;var s=this.parseProperty(t,e);t||this.checkPropClash(s,i,e),r.properties.push(s)}return this.finishNode(r,t?"ObjectPattern":"ObjectExpression")},ft.parseProperty=function(t,e){var r,n,i,s,a=this.startNode();if(this.options.ecmaVersion>=9&&this.eat(B.ellipsis))return t?(a.argument=this.parseIdent(!1),this.type===B.comma&&this.raise(this.start,"Comma is not permitted after the rest element"),this.finishNode(a,"RestElement")):(this.type===B.parenL&&e&&(e.parenthesizedAssign<0&&(e.parenthesizedAssign=this.start),e.parenthesizedBind<0&&(e.parenthesizedBind=this.start)),a.argument=this.parseMaybeAssign(!1,e),this.type===B.comma&&e&&e.trailingComma<0&&(e.trailingComma=this.start),this.finishNode(a,"SpreadElement"));this.options.ecmaVersion>=6&&(a.method=!1,a.shorthand=!1,(t||e)&&(i=this.start,s=this.startLoc),t||(r=this.eat(B.star)));var o=this.containsEsc;return this.parsePropertyName(a),!t&&!o&&this.options.ecmaVersion>=8&&!r&&this.isAsyncProp(a)?(n=!0,r=this.options.ecmaVersion>=9&&this.eat(B.star),this.parsePropertyName(a,e)):n=!1,this.parsePropertyValue(a,t,r,n,i,s,e,o),this.finishNode(a,"Property")},ft.parsePropertyValue=function(t,e,r,n,i,s,a,o){if((r||n)&&this.type===B.colon&&this.unexpected(),this.eat(B.colon))t.value=e?this.parseMaybeDefault(this.start,this.startLoc):this.parseMaybeAssign(!1,a),t.kind="init";else if(this.options.ecmaVersion>=6&&this.type===B.parenL)e&&this.unexpected(),t.kind="init",t.method=!0,t.value=this.parseMethod(r,n);else if(e||o||!(this.options.ecmaVersion>=5)||t.computed||"Identifier"!==t.key.type||"get"!==t.key.name&&"set"!==t.key.name||this.type===B.comma||this.type===B.braceR)this.options.ecmaVersion>=6&&!t.computed&&"Identifier"===t.key.type?(this.checkUnreserved(t.key),t.kind="init",e?t.value=this.parseMaybeDefault(i,s,t.key):this.type===B.eq&&a?(a.shorthandAssign<0&&(a.shorthandAssign=this.start),t.value=this.parseMaybeDefault(i,s,t.key)):t.value=t.key,t.shorthand=!0):this.unexpected();else{(r||n)&&this.unexpected(),t.kind=t.key.name,this.parsePropertyName(t),t.value=this.parseMethod(!1);var u="get"===t.kind?0:1;if(t.value.params.length!==u){var h=t.value.start;"get"===t.kind?this.raiseRecoverable(h,"getter should have no params"):this.raiseRecoverable(h,"setter should have exactly one param")}else"set"===t.kind&&"RestElement"===t.value.params[0].type&&this.raiseRecoverable(t.value.params[0].start,"Setter cannot use rest params")}},ft.parsePropertyName=function(t){if(this.options.ecmaVersion>=6){if(this.eat(B.bracketL))return t.computed=!0,t.key=this.parseMaybeAssign(),this.expect(B.bracketR),t.key;t.computed=!1}return t.key=this.type===B.num||this.type===B.string?this.parseExprAtom():this.parseIdent(!0)},ft.initFunction=function(t){t.id=null,this.options.ecmaVersion>=6&&(t.generator=!1,t.expression=!1),this.options.ecmaVersion>=8&&(t.async=!1)},ft.parseMethod=function(t,e){var r=this.startNode(),n=this.inGenerator,i=this.inAsync,s=this.yieldPos,a=this.awaitPos,o=this.inFunction;return this.initFunction(r),this.options.ecmaVersion>=6&&(r.generator=t),this.options.ecmaVersion>=8&&(r.async=!!e),this.inGenerator=r.generator,this.inAsync=r.async,this.yieldPos=0,this.awaitPos=0,this.inFunction=!0,this.enterFunctionScope(),this.expect(B.parenL),r.params=this.parseBindingList(B.parenR,!1,this.options.ecmaVersion>=8),this.checkYieldAwaitInDefaultParams(),this.parseFunctionBody(r,!1),this.inGenerator=n,this.inAsync=i,this.yieldPos=s,this.awaitPos=a,this.inFunction=o,this.finishNode(r,"FunctionExpression")},ft.parseArrowExpression=function(t,e,r){var n=this.inGenerator,i=this.inAsync,s=this.yieldPos,a=this.awaitPos,o=this.inFunction;return this.enterFunctionScope(),this.initFunction(t),this.options.ecmaVersion>=8&&(t.async=!!r),this.inGenerator=!1,this.inAsync=t.async,this.yieldPos=0,this.awaitPos=0,this.inFunction=!0,t.params=this.toAssignableList(e,!0),this.parseFunctionBody(t,!0),this.inGenerator=n,this.inAsync=i,this.yieldPos=s,this.awaitPos=a,this.inFunction=o,this.finishNode(t,"ArrowFunctionExpression")},ft.parseFunctionBody=function(t,e){var r=e&&this.type!==B.braceL,n=this.strict,i=!1;if(r)t.body=this.parseMaybeAssign(),t.expression=!0,this.checkParams(t,!1);else{var s=this.options.ecmaVersion>=7&&!this.isSimpleParamList(t.params);n&&!s||(i=this.strictDirective(this.end))&&s&&this.raiseRecoverable(t.start,"Illegal 'use strict' directive in function with non-simple parameter list");var a=this.labels;this.labels=[],i&&(this.strict=!0),this.checkParams(t,!n&&!i&&!e&&this.isSimpleParamList(t.params)),t.body=this.parseBlock(!1),t.expression=!1,this.adaptDirectivePrologue(t.body.body),this.labels=a}this.exitFunctionScope(),this.strict&&t.id&&this.checkLVal(t.id,"none"),this.strict=n},ft.isSimpleParamList=function(t){for(var e=0,r=t;e<r.length;e+=1){if("Identifier"!==r[e].type)return!1}return!0},ft.checkParams=function(t,e){for(var r={},n=0,i=t.params;n<i.length;n+=1){var s=i[n];this.checkLVal(s,"var",e?null:r)}},ft.parseExprList=function(t,e,r,n){for(var i=[],s=!0;!this.eat(t);){if(s)s=!1;else if(this.expect(B.comma),e&&this.afterTrailingComma(t))break;var a=void 0;r&&this.type===B.comma?a=null:this.type===B.ellipsis?(a=this.parseSpread(n),n&&this.type===B.comma&&n.trailingComma<0&&(n.trailingComma=this.start)):a=this.parseMaybeAssign(!1,n),i.push(a)}return i},ft.checkUnreserved=function(t){var e=t.start,r=t.end,n=t.name;(this.inGenerator&&"yield"===n&&this.raiseRecoverable(e,"Can not use 'yield' as identifier inside a generator"),this.inAsync&&"await"===n&&this.raiseRecoverable(e,"Can not use 'await' as identifier inside an async function"),this.isKeyword(n)&&this.raise(e,"Unexpected keyword '"+n+"'"),this.options.ecmaVersion<6&&-1!==this.input.slice(e,r).indexOf("\\"))||(this.strict?this.reservedWordsStrict:this.reservedWords).test(n)&&(this.inAsync||"await"!==n||this.raiseRecoverable(e,"Can not use keyword 'await' outside an async function"),this.raiseRecoverable(e,"The keyword '"+n+"' is reserved"))},ft.parseIdent=function(t,e){var r=this.startNode();return t&&"never"===this.options.allowReserved&&(t=!1),this.type===B.name?r.name=this.value:this.type.keyword?(r.name=this.type.keyword,"class"!==r.name&&"function"!==r.name||this.lastTokEnd===this.lastTokStart+1&&46===this.input.charCodeAt(this.lastTokStart)||this.context.pop()):this.unexpected(),this.next(),this.finishNode(r,"Identifier"),t||this.checkUnreserved(r),r},ft.parseYield=function(){this.yieldPos||(this.yieldPos=this.start);var t=this.startNode();return this.next(),this.type===B.semi||this.canInsertSemicolon()||this.type!==B.star&&!this.type.startsExpr?(t.delegate=!1,t.argument=null):(t.delegate=this.eat(B.star),t.argument=this.parseMaybeAssign()),this.finishNode(t,"YieldExpression")},ft.parseAwait=function(){this.awaitPos||(this.awaitPos=this.start);var t=this.startNode();return this.next(),t.argument=this.parseMaybeUnary(null,!0),this.finishNode(t,"AwaitExpression")};var xt=at.prototype;xt.raise=function(t,e){var r=function(t,e){for(var r=1,n=0;;){j.lastIndex=n;var i=j.exec(t);if(!(i&&i.index<e))return new tt(r,e-n);++r,n=i.index+i[0].length}}(this.input,t);e+=" ("+r.line+":"+r.column+")";var n=new SyntaxError(e);throw n.pos=t,n.loc=r,n.raisedAt=this.pos,n},xt.raiseRecoverable=xt.raise,xt.curPosition=function(){if(this.options.locations)return new tt(this.curLine,this.pos-this.lineStart)};var yt=at.prototype,Tt=Object.assign||function(t){for(var e=[],r=arguments.length-1;r-- >0;)e[r]=arguments[r+1];for(var n=0,i=e;n<i.length;n+=1){var s=i[n];for(var a in s)J(s,a)&&(t[a]=s[a])}return t};yt.enterFunctionScope=function(){this.scopeStack.push({var:{},lexical:{},childVar:{},parentLexical:{}})},yt.exitFunctionScope=function(){this.scopeStack.pop()},yt.enterLexicalScope=function(){var t=this.scopeStack[this.scopeStack.length-1],e={var:{},lexical:{},childVar:{},parentLexical:{}};this.scopeStack.push(e),Tt(e.parentLexical,t.lexical,t.parentLexical)},yt.exitLexicalScope=function(){var t=this.scopeStack.pop(),e=this.scopeStack[this.scopeStack.length-1];Tt(e.childVar,t.var,t.childVar)},yt.canDeclareVarName=function(t){var e=this.scopeStack[this.scopeStack.length-1];return!J(e.lexical,t)&&!J(e.parentLexical,t)},yt.canDeclareLexicalName=function(t){var e=this.scopeStack[this.scopeStack.length-1];return!J(e.lexical,t)&&!J(e.var,t)&&!J(e.childVar,t)},yt.declareVarName=function(t){this.scopeStack[this.scopeStack.length-1].var[t]=!0},yt.declareLexicalName=function(t){this.scopeStack[this.scopeStack.length-1].lexical[t]=!0};var bt=function(t,e,r){this.type="",this.start=e,this.end=0,t.options.locations&&(this.loc=new et(t,r)),t.options.directSourceFile&&(this.sourceFile=t.options.directSourceFile),t.options.ranges&&(this.range=[e,0])},At=at.prototype;function St(t,e,r,n){return t.type=e,t.end=r,this.options.locations&&(t.loc.end=n),this.options.ranges&&(t.range[1]=r),t}At.startNode=function(){return new bt(this,this.start,this.startLoc)},At.startNodeAt=function(t,e){return new bt(this,t,e)},At.finishNode=function(t,e){return St.call(this,t,e,this.lastTokEnd,this.lastTokEndLoc)},At.finishNodeAt=function(t,e,r,n){return St.call(this,t,e,r,n)};var Et=function(t,e,r,n,i){this.token=t,this.isExpr=!!e,this.preserveSpace=!!r,this.override=n,this.generator=!!i},_t={b_stat:new Et("{",!1),b_expr:new Et("{",!0),b_tmpl:new Et("${",!1),p_stat:new Et("(",!1),p_expr:new Et("(",!0),q_tmpl:new Et("`",!0,!0,(function(t){return t.tryReadTemplateToken()})),f_stat:new Et("function",!1),f_expr:new Et("function",!0),f_expr_gen:new Et("function",!0,!1,null,!0),f_gen:new Et("function",!1,!1,null,!0)},vt=at.prototype;vt.initialContext=function(){return[_t.b_stat]},vt.braceIsBlock=function(t){var e=this.curContext();return e===_t.f_expr||e===_t.f_stat||(t!==B.colon||e!==_t.b_stat&&e!==_t.b_expr?t===B._return||t===B.name&&this.exprAllowed?G.test(this.input.slice(this.lastTokEnd,this.start)):t===B._else||t===B.semi||t===B.eof||t===B.parenR||t===B.arrow||(t===B.braceL?e===_t.b_stat:t!==B._var&&t!==B.name&&!this.exprAllowed):!e.isExpr)},vt.inGeneratorContext=function(){for(var t=this.context.length-1;t>=1;t--){var e=this.context[t];if("function"===e.token)return e.generator}return!1},vt.updateContext=function(t){var e,r=this.type;r.keyword&&t===B.dot?this.exprAllowed=!1:(e=r.updateContext)?e.call(this,t):this.exprAllowed=r.beforeExpr},B.parenR.updateContext=B.braceR.updateContext=function(){if(1!==this.context.length){var t=this.context.pop();t===_t.b_stat&&"function"===this.curContext().token&&(t=this.context.pop()),this.exprAllowed=!t.isExpr}else this.exprAllowed=!0},B.braceL.updateContext=function(t){this.context.push(this.braceIsBlock(t)?_t.b_stat:_t.b_expr),this.exprAllowed=!0},B.dollarBraceL.updateContext=function(){this.context.push(_t.b_tmpl),this.exprAllowed=!0},B.parenL.updateContext=function(t){var e=t===B._if||t===B._for||t===B._with||t===B._while;this.context.push(e?_t.p_stat:_t.p_expr),this.exprAllowed=!0},B.incDec.updateContext=function(){},B._function.updateContext=B._class.updateContext=function(t){t.beforeExpr&&t!==B.semi&&t!==B._else&&(t!==B.colon&&t!==B.braceL||this.curContext()!==_t.b_stat)?this.context.push(_t.f_expr):this.context.push(_t.f_stat),this.exprAllowed=!1},B.backQuote.updateContext=function(){this.curContext()===_t.q_tmpl?this.context.pop():this.context.push(_t.q_tmpl),this.exprAllowed=!1},B.star.updateContext=function(t){if(t===B._function){var e=this.context.length-1;this.context[e]===_t.f_expr?this.context[e]=_t.f_expr_gen:this.context[e]=_t.f_gen}this.exprAllowed=!0},B.name.updateContext=function(t){var e=!1;this.options.ecmaVersion>=6&&t!==B.dot&&("of"===this.value&&!this.exprAllowed||"yield"===this.value&&this.inGeneratorContext())&&(e=!0),this.exprAllowed=e};var wt={$LONE:["ASCII","ASCII_Hex_Digit","AHex","Alphabetic","Alpha","Any","Assigned","Bidi_Control","Bidi_C","Bidi_Mirrored","Bidi_M","Case_Ignorable","CI","Cased","Changes_When_Casefolded","CWCF","Changes_When_Casemapped","CWCM","Changes_When_Lowercased","CWL","Changes_When_NFKC_Casefolded","CWKCF","Changes_When_Titlecased","CWT","Changes_When_Uppercased","CWU","Dash","Default_Ignorable_Code_Point","DI","Deprecated","Dep","Diacritic","Dia","Emoji","Emoji_Component","Emoji_Modifier","Emoji_Modifier_Base","Emoji_Presentation","Extender","Ext","Grapheme_Base","Gr_Base","Grapheme_Extend","Gr_Ext","Hex_Digit","Hex","IDS_Binary_Operator","IDSB","IDS_Trinary_Operator","IDST","ID_Continue","IDC","ID_Start","IDS","Ideographic","Ideo","Join_Control","Join_C","Logical_Order_Exception","LOE","Lowercase","Lower","Math","Noncharacter_Code_Point","NChar","Pattern_Syntax","Pat_Syn","Pattern_White_Space","Pat_WS","Quotation_Mark","QMark","Radical","Regional_Indicator","RI","Sentence_Terminal","STerm","Soft_Dotted","SD","Terminal_Punctuation","Term","Unified_Ideograph","UIdeo","Uppercase","Upper","Variation_Selector","VS","White_Space","space","XID_Continue","XIDC","XID_Start","XIDS"],General_Category:["Cased_Letter","LC","Close_Punctuation","Pe","Connector_Punctuation","Pc","Control","Cc","cntrl","Currency_Symbol","Sc","Dash_Punctuation","Pd","Decimal_Number","Nd","digit","Enclosing_Mark","Me","Final_Punctuation","Pf","Format","Cf","Initial_Punctuation","Pi","Letter","L","Letter_Number","Nl","Line_Separator","Zl","Lowercase_Letter","Ll","Mark","M","Combining_Mark","Math_Symbol","Sm","Modifier_Letter","Lm","Modifier_Symbol","Sk","Nonspacing_Mark","Mn","Number","N","Open_Punctuation","Ps","Other","C","Other_Letter","Lo","Other_Number","No","Other_Punctuation","Po","Other_Symbol","So","Paragraph_Separator","Zp","Private_Use","Co","Punctuation","P","punct","Separator","Z","Space_Separator","Zs","Spacing_Mark","Mc","Surrogate","Cs","Symbol","S","Titlecase_Letter","Lt","Unassigned","Cn","Uppercase_Letter","Lu"],Script:["Adlam","Adlm","Ahom","Anatolian_Hieroglyphs","Hluw","Arabic","Arab","Armenian","Armn","Avestan","Avst","Balinese","Bali","Bamum","Bamu","Bassa_Vah","Bass","Batak","Batk","Bengali","Beng","Bhaiksuki","Bhks","Bopomofo","Bopo","Brahmi","Brah","Braille","Brai","Buginese","Bugi","Buhid","Buhd","Canadian_Aboriginal","Cans","Carian","Cari","Caucasian_Albanian","Aghb","Chakma","Cakm","Cham","Cherokee","Cher","Common","Zyyy","Coptic","Copt","Qaac","Cuneiform","Xsux","Cypriot","Cprt","Cyrillic","Cyrl","Deseret","Dsrt","Devanagari","Deva","Duployan","Dupl","Egyptian_Hieroglyphs","Egyp","Elbasan","Elba","Ethiopic","Ethi","Georgian","Geor","Glagolitic","Glag","Gothic","Goth","Grantha","Gran","Greek","Grek","Gujarati","Gujr","Gurmukhi","Guru","Han","Hani","Hangul","Hang","Hanunoo","Hano","Hatran","Hatr","Hebrew","Hebr","Hiragana","Hira","Imperial_Aramaic","Armi","Inherited","Zinh","Qaai","Inscriptional_Pahlavi","Phli","Inscriptional_Parthian","Prti","Javanese","Java","Kaithi","Kthi","Kannada","Knda","Katakana","Kana","Kayah_Li","Kali","Kharoshthi","Khar","Khmer","Khmr","Khojki","Khoj","Khudawadi","Sind","Lao","Laoo","Latin","Latn","Lepcha","Lepc","Limbu","Limb","Linear_A","Lina","Linear_B","Linb","Lisu","Lycian","Lyci","Lydian","Lydi","Mahajani","Mahj","Malayalam","Mlym","Mandaic","Mand","Manichaean","Mani","Marchen","Marc","Masaram_Gondi","Gonm","Meetei_Mayek","Mtei","Mende_Kikakui","Mend","Meroitic_Cursive","Merc","Meroitic_Hieroglyphs","Mero","Miao","Plrd","Modi","Mongolian","Mong","Mro","Mroo","Multani","Mult","Myanmar","Mymr","Nabataean","Nbat","New_Tai_Lue","Talu","Newa","Nko","Nkoo","Nushu","Nshu","Ogham","Ogam","Ol_Chiki","Olck","Old_Hungarian","Hung","Old_Italic","Ital","Old_North_Arabian","Narb","Old_Permic","Perm","Old_Persian","Xpeo","Old_South_Arabian","Sarb","Old_Turkic","Orkh","Oriya","Orya","Osage","Osge","Osmanya","Osma","Pahawh_Hmong","Hmng","Palmyrene","Palm","Pau_Cin_Hau","Pauc","Phags_Pa","Phag","Phoenician","Phnx","Psalter_Pahlavi","Phlp","Rejang","Rjng","Runic","Runr","Samaritan","Samr","Saurashtra","Saur","Sharada","Shrd","Shavian","Shaw","Siddham","Sidd","SignWriting","Sgnw","Sinhala","Sinh","Sora_Sompeng","Sora","Soyombo","Soyo","Sundanese","Sund","Syloti_Nagri","Sylo","Syriac","Syrc","Tagalog","Tglg","Tagbanwa","Tagb","Tai_Le","Tale","Tai_Tham","Lana","Tai_Viet","Tavt","Takri","Takr","Tamil","Taml","Tangut","Tang","Telugu","Telu","Thaana","Thaa","Thai","Tibetan","Tibt","Tifinagh","Tfng","Tirhuta","Tirh","Ugaritic","Ugar","Vai","Vaii","Warang_Citi","Wara","Yi","Yiii","Zanabazar_Square","Zanb"]};Array.prototype.push.apply(wt.$LONE,wt.General_Category),wt.gc=wt.General_Category,wt.sc=wt.Script_Extensions=wt.scx=wt.Script;var It=at.prototype,Dt=function(t){this.parser=t,this.validFlags="gim"+(t.options.ecmaVersion>=6?"uy":"")+(t.options.ecmaVersion>=9?"s":""),this.source="",this.flags="",this.start=0,this.switchU=!1,this.switchN=!1,this.pos=0,this.lastIntValue=0,this.lastStringValue="",this.lastAssertionIsQuantifiable=!1,this.numCapturingParens=0,this.maxBackReference=0,this.groupNames=[],this.backReferenceNames=[]};function Rt(t){return t<=65535?String.fromCharCode(t):(t-=65536,String.fromCharCode(55296+(t>>10),56320+(1023&t)))}function kt(t){return 36===t||t>=40&&t<=43||46===t||63===t||t>=91&&t<=94||t>=123&&t<=125}function $t(t){return t>=65&&t<=90||t>=97&&t<=122}function Ct(t){return $t(t)||95===t}function Ft(t){return Ct(t)||Nt(t)}function Nt(t){return t>=48&&t<=57}function Ot(t){return t>=48&&t<=57||t>=65&&t<=70||t>=97&&t<=102}function Pt(t){return t>=65&&t<=70?t-65+10:t>=97&&t<=102?t-97+10:t-48}function zt(t){return t>=48&&t<=55}Dt.prototype.reset=function(t,e,r){var n=-1!==r.indexOf("u");this.start=0|t,this.source=e+"",this.flags=r,this.switchU=n&&this.parser.options.ecmaVersion>=6,this.switchN=n&&this.parser.options.ecmaVersion>=9},Dt.prototype.raise=function(t){this.parser.raiseRecoverable(this.start,"Invalid regular expression: /"+this.source+"/: "+t)},Dt.prototype.at=function(t){var e=this.source,r=e.length;if(t>=r)return-1;var n=e.charCodeAt(t);return!this.switchU||n<=55295||n>=57344||t+1>=r?n:(n<<10)+e.charCodeAt(t+1)-56613888},Dt.prototype.nextIndex=function(t){var e=this.source,r=e.length;if(t>=r)return r;var n=e.charCodeAt(t);return!this.switchU||n<=55295||n>=57344||t+1>=r?t+1:t+2},Dt.prototype.current=function(){return this.at(this.pos)},Dt.prototype.lookahead=function(){return this.at(this.nextIndex(this.pos))},Dt.prototype.advance=function(){this.pos=this.nextIndex(this.pos)},Dt.prototype.eat=function(t){return this.current()===t&&(this.advance(),!0)},It.validateRegExpFlags=function(t){for(var e=t.validFlags,r=t.flags,n=0;n<r.length;n++){var i=r.charAt(n);-1===e.indexOf(i)&&this.raise(t.start,"Invalid regular expression flag"),r.indexOf(i,n+1)>-1&&this.raise(t.start,"Duplicate regular expression flag")}},It.validateRegExpPattern=function(t){this.regexp_pattern(t),!t.switchN&&this.options.ecmaVersion>=9&&t.groupNames.length>0&&(t.switchN=!0,this.regexp_pattern(t))},It.regexp_pattern=function(t){t.pos=0,t.lastIntValue=0,t.lastStringValue="",t.lastAssertionIsQuantifiable=!1,t.numCapturingParens=0,t.maxBackReference=0,t.groupNames.length=0,t.backReferenceNames.length=0,this.regexp_disjunction(t),t.pos!==t.source.length&&(t.eat(41)&&t.raise("Unmatched ')'"),(t.eat(93)||t.eat(125))&&t.raise("Lone quantifier brackets")),t.maxBackReference>t.numCapturingParens&&t.raise("Invalid escape");for(var e=0,r=t.backReferenceNames;e<r.length;e+=1){var n=r[e];-1===t.groupNames.indexOf(n)&&t.raise("Invalid named capture referenced")}},It.regexp_disjunction=function(t){for(this.regexp_alternative(t);t.eat(124);)this.regexp_alternative(t);this.regexp_eatQuantifier(t,!0)&&t.raise("Nothing to repeat"),t.eat(123)&&t.raise("Lone quantifier brackets")},It.regexp_alternative=function(t){for(;t.pos<t.source.length&&this.regexp_eatTerm(t););},It.regexp_eatTerm=function(t){return this.regexp_eatAssertion(t)?(t.lastAssertionIsQuantifiable&&this.regexp_eatQuantifier(t)&&t.switchU&&t.raise("Invalid quantifier"),!0):!(t.switchU?!this.regexp_eatAtom(t):!this.regexp_eatExtendedAtom(t))&&(this.regexp_eatQuantifier(t),!0)},It.regexp_eatAssertion=function(t){var e=t.pos;if(t.lastAssertionIsQuantifiable=!1,t.eat(94)||t.eat(36))return!0;if(t.eat(92)){if(t.eat(66)||t.eat(98))return!0;t.pos=e}if(t.eat(40)&&t.eat(63)){var r=!1;if(this.options.ecmaVersion>=9&&(r=t.eat(60)),t.eat(61)||t.eat(33))return this.regexp_disjunction(t),t.eat(41)||t.raise("Unterminated group"),t.lastAssertionIsQuantifiable=!r,!0}return t.pos=e,!1},It.regexp_eatQuantifier=function(t,e){return void 0===e&&(e=!1),!!this.regexp_eatQuantifierPrefix(t,e)&&(t.eat(63),!0)},It.regexp_eatQuantifierPrefix=function(t,e){return t.eat(42)||t.eat(43)||t.eat(63)||this.regexp_eatBracedQuantifier(t,e)},It.regexp_eatBracedQuantifier=function(t,e){var r=t.pos;if(t.eat(123)){var n=0,i=-1;if(this.regexp_eatDecimalDigits(t)&&(n=t.lastIntValue,t.eat(44)&&this.regexp_eatDecimalDigits(t)&&(i=t.lastIntValue),t.eat(125)))return-1!==i&&i<n&&!e&&t.raise("numbers out of order in {} quantifier"),!0;t.switchU&&!e&&t.raise("Incomplete quantifier"),t.pos=r}return!1},It.regexp_eatAtom=function(t){return this.regexp_eatPatternCharacters(t)||t.eat(46)||this.regexp_eatReverseSolidusAtomEscape(t)||this.regexp_eatCharacterClass(t)||this.regexp_eatUncapturingGroup(t)||this.regexp_eatCapturingGroup(t)},It.regexp_eatReverseSolidusAtomEscape=function(t){var e=t.pos;if(t.eat(92)){if(this.regexp_eatAtomEscape(t))return!0;t.pos=e}return!1},It.regexp_eatUncapturingGroup=function(t){var e=t.pos;if(t.eat(40)){if(t.eat(63)&&t.eat(58)){if(this.regexp_disjunction(t),t.eat(41))return!0;t.raise("Unterminated group")}t.pos=e}return!1},It.regexp_eatCapturingGroup=function(t){if(t.eat(40)){if(this.options.ecmaVersion>=9?this.regexp_groupSpecifier(t):63===t.current()&&t.raise("Invalid group"),this.regexp_disjunction(t),t.eat(41))return t.numCapturingParens+=1,!0;t.raise("Unterminated group")}return!1},It.regexp_eatExtendedAtom=function(t){return t.eat(46)||this.regexp_eatReverseSolidusAtomEscape(t)||this.regexp_eatCharacterClass(t)||this.regexp_eatUncapturingGroup(t)||this.regexp_eatCapturingGroup(t)||this.regexp_eatInvalidBracedQuantifier(t)||this.regexp_eatExtendedPatternCharacter(t)},It.regexp_eatInvalidBracedQuantifier=function(t){return this.regexp_eatBracedQuantifier(t,!0)&&t.raise("Nothing to repeat"),!1},It.regexp_eatSyntaxCharacter=function(t){var e=t.current();return!!kt(e)&&(t.lastIntValue=e,t.advance(),!0)},It.regexp_eatPatternCharacters=function(t){for(var e=t.pos,r=0;-1!==(r=t.current())&&!kt(r);)t.advance();return t.pos!==e},It.regexp_eatExtendedPatternCharacter=function(t){var e=t.current();return!(-1===e||36===e||e>=40&&e<=43||46===e||63===e||91===e||94===e||124===e)&&(t.advance(),!0)},It.regexp_groupSpecifier=function(t){if(t.eat(63)){if(this.regexp_eatGroupName(t))return-1!==t.groupNames.indexOf(t.lastStringValue)&&t.raise("Duplicate capture group name"),void t.groupNames.push(t.lastStringValue);t.raise("Invalid group")}},It.regexp_eatGroupName=function(t){if(t.lastStringValue="",t.eat(60)){if(this.regexp_eatRegExpIdentifierName(t)&&t.eat(62))return!0;t.raise("Invalid capture group name")}return!1},It.regexp_eatRegExpIdentifierName=function(t){if(t.lastStringValue="",this.regexp_eatRegExpIdentifierStart(t)){for(t.lastStringValue+=Rt(t.lastIntValue);this.regexp_eatRegExpIdentifierPart(t);)t.lastStringValue+=Rt(t.lastIntValue);return!0}return!1},It.regexp_eatRegExpIdentifierStart=function(t){var e=t.pos,r=t.current();return t.advance(),92===r&&this.regexp_eatRegExpUnicodeEscapeSequence(t)&&(r=t.lastIntValue),function(t){return O(t,!0)||36===t||95===t}(r)?(t.lastIntValue=r,!0):(t.pos=e,!1)},It.regexp_eatRegExpIdentifierPart=function(t){var e=t.pos,r=t.current();return t.advance(),92===r&&this.regexp_eatRegExpUnicodeEscapeSequence(t)&&(r=t.lastIntValue),function(t){return P(t,!0)||36===t||95===t||8204===t||8205===t}(r)?(t.lastIntValue=r,!0):(t.pos=e,!1)},It.regexp_eatAtomEscape=function(t){return!!(this.regexp_eatBackReference(t)||this.regexp_eatCharacterClassEscape(t)||this.regexp_eatCharacterEscape(t)||t.switchN&&this.regexp_eatKGroupName(t))||(t.switchU&&(99===t.current()&&t.raise("Invalid unicode escape"),t.raise("Invalid escape")),!1)},It.regexp_eatBackReference=function(t){var e=t.pos;if(this.regexp_eatDecimalEscape(t)){var r=t.lastIntValue;if(t.switchU)return r>t.maxBackReference&&(t.maxBackReference=r),!0;if(r<=t.numCapturingParens)return!0;t.pos=e}return!1},It.regexp_eatKGroupName=function(t){if(t.eat(107)){if(this.regexp_eatGroupName(t))return t.backReferenceNames.push(t.lastStringValue),!0;t.raise("Invalid named reference")}return!1},It.regexp_eatCharacterEscape=function(t){return this.regexp_eatControlEscape(t)||this.regexp_eatCControlLetter(t)||this.regexp_eatZero(t)||this.regexp_eatHexEscapeSequence(t)||this.regexp_eatRegExpUnicodeEscapeSequence(t)||!t.switchU&&this.regexp_eatLegacyOctalEscapeSequence(t)||this.regexp_eatIdentityEscape(t)},It.regexp_eatCControlLetter=function(t){var e=t.pos;if(t.eat(99)){if(this.regexp_eatControlLetter(t))return!0;t.pos=e}return!1},It.regexp_eatZero=function(t){return 48===t.current()&&!Nt(t.lookahead())&&(t.lastIntValue=0,t.advance(),!0)},It.regexp_eatControlEscape=function(t){var e=t.current();return 116===e?(t.lastIntValue=9,t.advance(),!0):110===e?(t.lastIntValue=10,t.advance(),!0):118===e?(t.lastIntValue=11,t.advance(),!0):102===e?(t.lastIntValue=12,t.advance(),!0):114===e&&(t.lastIntValue=13,t.advance(),!0)},It.regexp_eatControlLetter=function(t){var e=t.current();return!!$t(e)&&(t.lastIntValue=e%32,t.advance(),!0)},It.regexp_eatRegExpUnicodeEscapeSequence=function(t){var e,r=t.pos;if(t.eat(117)){if(this.regexp_eatFixedHexDigits(t,4)){var n=t.lastIntValue;if(t.switchU&&n>=55296&&n<=56319){var i=t.pos;if(t.eat(92)&&t.eat(117)&&this.regexp_eatFixedHexDigits(t,4)){var s=t.lastIntValue;if(s>=56320&&s<=57343)return t.lastIntValue=1024*(n-55296)+(s-56320)+65536,!0}t.pos=i,t.lastIntValue=n}return!0}if(t.switchU&&t.eat(123)&&this.regexp_eatHexDigits(t)&&t.eat(125)&&((e=t.lastIntValue)>=0&&e<=1114111))return!0;t.switchU&&t.raise("Invalid unicode escape"),t.pos=r}return!1},It.regexp_eatIdentityEscape=function(t){if(t.switchU)return!!this.regexp_eatSyntaxCharacter(t)||!!t.eat(47)&&(t.lastIntValue=47,!0);var e=t.current();return!(99===e||t.switchN&&107===e)&&(t.lastIntValue=e,t.advance(),!0)},It.regexp_eatDecimalEscape=function(t){t.lastIntValue=0;var e=t.current();if(e>=49&&e<=57){do{t.lastIntValue=10*t.lastIntValue+(e-48),t.advance()}while((e=t.current())>=48&&e<=57);return!0}return!1},It.regexp_eatCharacterClassEscape=function(t){var e=t.current();if(function(t){return 100===t||68===t||115===t||83===t||119===t||87===t}(e))return t.lastIntValue=-1,t.advance(),!0;if(t.switchU&&this.options.ecmaVersion>=9&&(80===e||112===e)){if(t.lastIntValue=-1,t.advance(),t.eat(123)&&this.regexp_eatUnicodePropertyValueExpression(t)&&t.eat(125))return!0;t.raise("Invalid property name")}return!1},It.regexp_eatUnicodePropertyValueExpression=function(t){var e=t.pos;if(this.regexp_eatUnicodePropertyName(t)&&t.eat(61)){var r=t.lastStringValue;if(this.regexp_eatUnicodePropertyValue(t)){var n=t.lastStringValue;return this.regexp_validateUnicodePropertyNameAndValue(t,r,n),!0}}if(t.pos=e,this.regexp_eatLoneUnicodePropertyNameOrValue(t)){var i=t.lastStringValue;return this.regexp_validateUnicodePropertyNameOrValue(t,i),!0}return!1},It.regexp_validateUnicodePropertyNameAndValue=function(t,e,r){wt.hasOwnProperty(e)&&-1!==wt[e].indexOf(r)||t.raise("Invalid property name")},It.regexp_validateUnicodePropertyNameOrValue=function(t,e){-1===wt.$LONE.indexOf(e)&&t.raise("Invalid property name")},It.regexp_eatUnicodePropertyName=function(t){var e=0;for(t.lastStringValue="";Ct(e=t.current());)t.lastStringValue+=Rt(e),t.advance();return""!==t.lastStringValue},It.regexp_eatUnicodePropertyValue=function(t){var e=0;for(t.lastStringValue="";Ft(e=t.current());)t.lastStringValue+=Rt(e),t.advance();return""!==t.lastStringValue},It.regexp_eatLoneUnicodePropertyNameOrValue=function(t){return this.regexp_eatUnicodePropertyValue(t)},It.regexp_eatCharacterClass=function(t){if(t.eat(91)){if(t.eat(94),this.regexp_classRanges(t),t.eat(93))return!0;t.raise("Unterminated character class")}return!1},It.regexp_classRanges=function(t){for(;this.regexp_eatClassAtom(t);){var e=t.lastIntValue;if(t.eat(45)&&this.regexp_eatClassAtom(t)){var r=t.lastIntValue;!t.switchU||-1!==e&&-1!==r||t.raise("Invalid character class"),-1!==e&&-1!==r&&e>r&&t.raise("Range out of order in character class")}}},It.regexp_eatClassAtom=function(t){var e=t.pos;if(t.eat(92)){if(this.regexp_eatClassEscape(t))return!0;if(t.switchU){var r=t.current();(99===r||zt(r))&&t.raise("Invalid class escape"),t.raise("Invalid escape")}t.pos=e}var n=t.current();return 93!==n&&(t.lastIntValue=n,t.advance(),!0)},It.regexp_eatClassEscape=function(t){var e=t.pos;if(t.eat(98))return t.lastIntValue=8,!0;if(t.switchU&&t.eat(45))return t.lastIntValue=45,!0;if(!t.switchU&&t.eat(99)){if(this.regexp_eatClassControlLetter(t))return!0;t.pos=e}return this.regexp_eatCharacterClassEscape(t)||this.regexp_eatCharacterEscape(t)},It.regexp_eatClassControlLetter=function(t){var e=t.current();return!(!Nt(e)&&95!==e)&&(t.lastIntValue=e%32,t.advance(),!0)},It.regexp_eatHexEscapeSequence=function(t){var e=t.pos;if(t.eat(120)){if(this.regexp_eatFixedHexDigits(t,2))return!0;t.switchU&&t.raise("Invalid escape"),t.pos=e}return!1},It.regexp_eatDecimalDigits=function(t){var e=t.pos,r=0;for(t.lastIntValue=0;Nt(r=t.current());)t.lastIntValue=10*t.lastIntValue+(r-48),t.advance();return t.pos!==e},It.regexp_eatHexDigits=function(t){var e=t.pos,r=0;for(t.lastIntValue=0;Ot(r=t.current());)t.lastIntValue=16*t.lastIntValue+Pt(r),t.advance();return t.pos!==e},It.regexp_eatLegacyOctalEscapeSequence=function(t){if(this.regexp_eatOctalDigit(t)){var e=t.lastIntValue;if(this.regexp_eatOctalDigit(t)){var r=t.lastIntValue;e<=3&&this.regexp_eatOctalDigit(t)?t.lastIntValue=64*e+8*r+t.lastIntValue:t.lastIntValue=8*e+r}else t.lastIntValue=e;return!0}return!1},It.regexp_eatOctalDigit=function(t){var e=t.current();return zt(e)?(t.lastIntValue=e-48,t.advance(),!0):(t.lastIntValue=0,!1)},It.regexp_eatFixedHexDigits=function(t,e){var r=t.pos;t.lastIntValue=0;for(var n=0;n<e;++n){var i=t.current();if(!Ot(i))return t.pos=r,!1;t.lastIntValue=16*t.lastIntValue+Pt(i),t.advance()}return!0};var Lt=function(t){this.type=t.type,this.value=t.value,this.start=t.start,this.end=t.end,t.options.locations&&(this.loc=new et(t,t.startLoc,t.endLoc)),t.options.ranges&&(this.range=[t.start,t.end])},Mt=at.prototype;function Vt(t){return t<=65535?String.fromCharCode(t):(t-=65536,String.fromCharCode(55296+(t>>10),56320+(1023&t)))}Mt.next=function(){this.options.onToken&&this.options.onToken(new Lt(this)),this.lastTokEnd=this.end,this.lastTokStart=this.start,this.lastTokEndLoc=this.endLoc,this.lastTokStartLoc=this.startLoc,this.nextToken()},Mt.getToken=function(){return this.next(),new Lt(this)},"undefined"!=typeof Symbol&&(Mt[Symbol.iterator]=function(){var t=this;return{next:function(){var e=t.getToken();return{done:e.type===B.eof,value:e}}}}),Mt.curContext=function(){return this.context[this.context.length-1]},Mt.nextToken=function(){var t=this.curContext();return t&&t.preserveSpace||this.skipSpace(),this.start=this.pos,this.options.locations&&(this.startLoc=this.curPosition()),this.pos>=this.input.length?this.finishToken(B.eof):t.override?t.override(this):void this.readToken(this.fullCharCodeAtPos())},Mt.readToken=function(t){return O(t,this.options.ecmaVersion>=6)||92===t?this.readWord():this.getTokenFromCode(t)},Mt.fullCharCodeAtPos=function(){var t=this.input.charCodeAt(this.pos);return t<=55295||t>=57344?t:(t<<10)+this.input.charCodeAt(this.pos+1)-56613888},Mt.skipBlockComment=function(){var t,e=this.options.onComment&&this.curPosition(),r=this.pos,n=this.input.indexOf("*/",this.pos+=2);if(-1===n&&this.raise(this.pos-2,"Unterminated comment"),this.pos=n+2,this.options.locations)for(j.lastIndex=r;(t=j.exec(this.input))&&t.index<this.pos;)++this.curLine,this.lineStart=t.index+t[0].length;this.options.onComment&&this.options.onComment(!0,this.input.slice(r+2,n),r,this.pos,e,this.curPosition())},Mt.skipLineComment=function(t){for(var e=this.pos,r=this.options.onComment&&this.curPosition(),n=this.input.charCodeAt(this.pos+=t);this.pos<this.input.length&&!X(n);)n=this.input.charCodeAt(++this.pos);this.options.onComment&&this.options.onComment(!1,this.input.slice(e+t,this.pos),e,this.pos,r,this.curPosition())},Mt.skipSpace=function(){t:for(;this.pos<this.input.length;){var t=this.input.charCodeAt(this.pos);switch(t){case 32:case 160:++this.pos;break;case 13:10===this.input.charCodeAt(this.pos+1)&&++this.pos;case 10:case 8232:case 8233:++this.pos,this.options.locations&&(++this.curLine,this.lineStart=this.pos);break;case 47:switch(this.input.charCodeAt(this.pos+1)){case 42:this.skipBlockComment();break;case 47:this.skipLineComment(2);break;default:break t}break;default:if(!(t>8&&t<14||t>=5760&&H.test(String.fromCharCode(t))))break t;++this.pos}}},Mt.finishToken=function(t,e){this.end=this.pos,this.options.locations&&(this.endLoc=this.curPosition());var r=this.type;this.type=t,this.value=e,this.updateContext(r)},Mt.readToken_dot=function(){var t=this.input.charCodeAt(this.pos+1);if(t>=48&&t<=57)return this.readNumber(!0);var e=this.input.charCodeAt(this.pos+2);return this.options.ecmaVersion>=6&&46===t&&46===e?(this.pos+=3,this.finishToken(B.ellipsis)):(++this.pos,this.finishToken(B.dot))},Mt.readToken_slash=function(){var t=this.input.charCodeAt(this.pos+1);return this.exprAllowed?(++this.pos,this.readRegexp()):61===t?this.finishOp(B.assign,2):this.finishOp(B.slash,1)},Mt.readToken_mult_modulo_exp=function(t){var e=this.input.charCodeAt(this.pos+1),r=1,n=42===t?B.star:B.modulo;return this.options.ecmaVersion>=7&&42===t&&42===e&&(++r,n=B.starstar,e=this.input.charCodeAt(this.pos+2)),61===e?this.finishOp(B.assign,r+1):this.finishOp(n,r)},Mt.readToken_pipe_amp=function(t){var e=this.input.charCodeAt(this.pos+1);return e===t?this.finishOp(124===t?B.logicalOR:B.logicalAND,2):61===e?this.finishOp(B.assign,2):this.finishOp(124===t?B.bitwiseOR:B.bitwiseAND,1)},Mt.readToken_caret=function(){return 61===this.input.charCodeAt(this.pos+1)?this.finishOp(B.assign,2):this.finishOp(B.bitwiseXOR,1)},Mt.readToken_plus_min=function(t){var e=this.input.charCodeAt(this.pos+1);return e===t?45!==e||this.inModule||62!==this.input.charCodeAt(this.pos+2)||0!==this.lastTokEnd&&!G.test(this.input.slice(this.lastTokEnd,this.pos))?this.finishOp(B.incDec,2):(this.skipLineComment(3),this.skipSpace(),this.nextToken()):61===e?this.finishOp(B.assign,2):this.finishOp(B.plusMin,1)},Mt.readToken_lt_gt=function(t){var e=this.input.charCodeAt(this.pos+1),r=1;return e===t?(r=62===t&&62===this.input.charCodeAt(this.pos+2)?3:2,61===this.input.charCodeAt(this.pos+r)?this.finishOp(B.assign,r+1):this.finishOp(B.bitShift,r)):33!==e||60!==t||this.inModule||45!==this.input.charCodeAt(this.pos+2)||45!==this.input.charCodeAt(this.pos+3)?(61===e&&(r=2),this.finishOp(B.relational,r)):(this.skipLineComment(4),this.skipSpace(),this.nextToken())},Mt.readToken_eq_excl=function(t){var e=this.input.charCodeAt(this.pos+1);return 61===e?this.finishOp(B.equality,61===this.input.charCodeAt(this.pos+2)?3:2):61===t&&62===e&&this.options.ecmaVersion>=6?(this.pos+=2,this.finishToken(B.arrow)):this.finishOp(61===t?B.eq:B.prefix,1)},Mt.getTokenFromCode=function(t){switch(t){case 46:return this.readToken_dot();case 40:return++this.pos,this.finishToken(B.parenL);case 41:return++this.pos,this.finishToken(B.parenR);case 59:return++this.pos,this.finishToken(B.semi);case 44:return++this.pos,this.finishToken(B.comma);case 91:return++this.pos,this.finishToken(B.bracketL);case 93:return++this.pos,this.finishToken(B.bracketR);case 123:return++this.pos,this.finishToken(B.braceL);case 125:return++this.pos,this.finishToken(B.braceR);case 58:return++this.pos,this.finishToken(B.colon);case 63:return++this.pos,this.finishToken(B.question);case 96:if(this.options.ecmaVersion<6)break;return++this.pos,this.finishToken(B.backQuote);case 48:var e=this.input.charCodeAt(this.pos+1);if(120===e||88===e)return this.readRadixNumber(16);if(this.options.ecmaVersion>=6){if(111===e||79===e)return this.readRadixNumber(8);if(98===e||66===e)return this.readRadixNumber(2)}case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.readNumber(!1);case 34:case 39:return this.readString(t);case 47:return this.readToken_slash();case 37:case 42:return this.readToken_mult_modulo_exp(t);case 124:case 38:return this.readToken_pipe_amp(t);case 94:return this.readToken_caret();case 43:case 45:return this.readToken_plus_min(t);case 60:case 62:return this.readToken_lt_gt(t);case 61:case 33:return this.readToken_eq_excl(t);case 126:return this.finishOp(B.prefix,1)}this.raise(this.pos,"Unexpected character '"+Vt(t)+"'")},Mt.finishOp=function(t,e){var r=this.input.slice(this.pos,this.pos+e);return this.pos+=e,this.finishToken(t,r)},Mt.readRegexp=function(){for(var t,e,r=this.pos;;){this.pos>=this.input.length&&this.raise(r,"Unterminated regular expression");var n=this.input.charAt(this.pos);if(G.test(n)&&this.raise(r,"Unterminated regular expression"),t)t=!1;else{if("["===n)e=!0;else if("]"===n&&e)e=!1;else if("/"===n&&!e)break;t="\\"===n}++this.pos}var i=this.input.slice(r,this.pos);++this.pos;var s=this.pos,a=this.readWord1();this.containsEsc&&this.unexpected(s);var o=this.regexpState||(this.regexpState=new Dt(this));o.reset(r,i,a),this.validateRegExpFlags(o),this.validateRegExpPattern(o);var u=null;try{u=new RegExp(i,a)}catch(t){}return this.finishToken(B.regexp,{pattern:i,flags:a,value:u})},Mt.readInt=function(t,e){for(var r=this.pos,n=0,i=0,s=null==e?1/0:e;i<s;++i){var a=this.input.charCodeAt(this.pos),o=void 0;if((o=a>=97?a-97+10:a>=65?a-65+10:a>=48&&a<=57?a-48:1/0)>=t)break;++this.pos,n=n*t+o}return this.pos===r||null!=e&&this.pos-r!==e?null:n},Mt.readRadixNumber=function(t){this.pos+=2;var e=this.readInt(t);return null==e&&this.raise(this.start+2,"Expected number in radix "+t),O(this.fullCharCodeAtPos())&&this.raise(this.pos,"Identifier directly after number"),this.finishToken(B.num,e)},Mt.readNumber=function(t){var e=this.pos;t||null!==this.readInt(10)||this.raise(e,"Invalid number");var r=this.pos-e>=2&&48===this.input.charCodeAt(e);r&&this.strict&&this.raise(e,"Invalid number"),r&&/[89]/.test(this.input.slice(e,this.pos))&&(r=!1);var n=this.input.charCodeAt(this.pos);46!==n||r||(++this.pos,this.readInt(10),n=this.input.charCodeAt(this.pos)),69!==n&&101!==n||r||(43!==(n=this.input.charCodeAt(++this.pos))&&45!==n||++this.pos,null===this.readInt(10)&&this.raise(e,"Invalid number")),O(this.fullCharCodeAtPos())&&this.raise(this.pos,"Identifier directly after number");var i=this.input.slice(e,this.pos),s=r?parseInt(i,8):parseFloat(i);return this.finishToken(B.num,s)},Mt.readCodePoint=function(){var t;if(123===this.input.charCodeAt(this.pos)){this.options.ecmaVersion<6&&this.unexpected();var e=++this.pos;t=this.readHexChar(this.input.indexOf("}",this.pos)-this.pos),++this.pos,t>1114111&&this.invalidStringToken(e,"Code point out of bounds")}else t=this.readHexChar(4);return t},Mt.readString=function(t){for(var e="",r=++this.pos;;){this.pos>=this.input.length&&this.raise(this.start,"Unterminated string constant");var n=this.input.charCodeAt(this.pos);if(n===t)break;92===n?(e+=this.input.slice(r,this.pos),e+=this.readEscapedChar(!1),r=this.pos):(X(n,this.options.ecmaVersion>=10)&&this.raise(this.start,"Unterminated string constant"),++this.pos)}return e+=this.input.slice(r,this.pos++),this.finishToken(B.string,e)};var Ut={};function Kt(t,e){return new at(e,t).parse()}Mt.tryReadTemplateToken=function(){this.inTemplateElement=!0;try{this.readTmplToken()}catch(t){if(t!==Ut)throw t;this.readInvalidTemplateToken()}this.inTemplateElement=!1},Mt.invalidStringToken=function(t,e){if(this.inTemplateElement&&this.options.ecmaVersion>=9)throw Ut;this.raise(t,e)},Mt.readTmplToken=function(){for(var t="",e=this.pos;;){this.pos>=this.input.length&&this.raise(this.start,"Unterminated template");var r=this.input.charCodeAt(this.pos);if(96===r||36===r&&123===this.input.charCodeAt(this.pos+1))return this.pos!==this.start||this.type!==B.template&&this.type!==B.invalidTemplate?(t+=this.input.slice(e,this.pos),this.finishToken(B.template,t)):36===r?(this.pos+=2,this.finishToken(B.dollarBraceL)):(++this.pos,this.finishToken(B.backQuote));if(92===r)t+=this.input.slice(e,this.pos),t+=this.readEscapedChar(!0),e=this.pos;else if(X(r)){switch(t+=this.input.slice(e,this.pos),++this.pos,r){case 13:10===this.input.charCodeAt(this.pos)&&++this.pos;case 10:t+="\n";break;default:t+=String.fromCharCode(r)}this.options.locations&&(++this.curLine,this.lineStart=this.pos),e=this.pos}else++this.pos}},Mt.readInvalidTemplateToken=function(){for(;this.pos<this.input.length;this.pos++)switch(this.input[this.pos]){case"\\":++this.pos;break;case"$":if("{"!==this.input[this.pos+1])break;case"`":return this.finishToken(B.invalidTemplate,this.input.slice(this.start,this.pos))}this.raise(this.start,"Unterminated template")},Mt.readEscapedChar=function(t){var e=this.input.charCodeAt(++this.pos);switch(++this.pos,e){case 110:return"\n";case 114:return"\r";case 120:return String.fromCharCode(this.readHexChar(2));case 117:return Vt(this.readCodePoint());case 116:return"\t";case 98:return"\b";case 118:return"\v";case 102:return"\f";case 13:10===this.input.charCodeAt(this.pos)&&++this.pos;case 10:return this.options.locations&&(this.lineStart=this.pos,++this.curLine),"";default:if(e>=48&&e<=55){var r=this.input.substr(this.pos-1,3).match(/^[0-7]+/)[0],n=parseInt(r,8);return n>255&&(r=r.slice(0,-1),n=parseInt(r,8)),this.pos+=r.length-1,e=this.input.charCodeAt(this.pos),"0"===r&&56!==e&&57!==e||!this.strict&&!t||this.invalidStringToken(this.pos-1-r.length,t?"Octal literal in template string":"Octal literal in strict mode"),String.fromCharCode(n)}return String.fromCharCode(e)}},Mt.readHexChar=function(t){var e=this.pos,r=this.readInt(16,t);return null===r&&this.invalidStringToken(e,"Bad character escape sequence"),r},Mt.readWord1=function(){this.containsEsc=!1;for(var t="",e=!0,r=this.pos,n=this.options.ecmaVersion>=6;this.pos<this.input.length;){var i=this.fullCharCodeAtPos();if(P(i,n))this.pos+=i<=65535?1:2;else{if(92!==i)break;this.containsEsc=!0,t+=this.input.slice(r,this.pos);var s=this.pos;117!==this.input.charCodeAt(++this.pos)&&this.invalidStringToken(this.pos,"Expecting Unicode escape sequence \\uXXXX"),++this.pos;var a=this.readCodePoint();(e?O:P)(a,n)||this.invalidStringToken(s,"Invalid Unicode escape"),t+=Vt(a),r=this.pos}e=!1}return t+this.input.slice(r,this.pos)},Mt.readWord=function(){var t=this.readWord1(),e=B.name;return this.keywords.test(t)&&(this.containsEsc&&this.raiseRecoverable(this.start,"Escape sequence in keyword "+t),e=U[t]),this.finishToken(e,t)};class Bt{constructor(t){const{texture:e,size:r,dimensions:n,output:i,context:s,type:a="NumberTexture"}=t;if(!i)throw new Error('settings property "output" required.');if(!s)throw new Error('settings property "context" required.');this.texture=e,this.size=r,this.dimensions=n,this.output=i,this.context=s,this.kernel=null,this.type=a}toArray(){throw new Error(`Not implemented on ${this.constructor.name}`)}delete(){return this.context.deleteTexture(this.texture)}}function Gt(){const t=new ArrayBuffer(4),e=new Uint32Array(t),r=new Uint8Array(t);if(e[0]=3735928559,239===r[0])return"LE";if(222===r[0])return"BE";throw new Error("unknown endianness")}const jt=Gt();function Xt(t,e){if(y(t))return"IMG"===t[0].nodeName?"HTMLImageArray":"Array";switch(t.constructor){case Boolean:return"Boolean";case Number:return e&&Number.isInteger(t)?"Integer":"Float";case Bt:return t.type;case E:return"Input"}switch(t.nodeName){case"IMG":return"HTMLImage";case"VIDEO":return"HTMLVideo"}return t.hasOwnProperty("type")?t.type:"Unknown"}const Ht={systemEndianness:function(){return jt},getSystemEndianness:Gt,isFunction:p,isFunctionString:g,getFunctionNameFromString:d,getFunctionBodyFromString:t=>t.substring(t.indexOf("{")+1,t.lastIndexOf("}")),getArgumentNamesFromString:x,clone(t){if(null===t||"object"!=typeof t||t.hasOwnProperty("isActiveClone"))return t;const e=t.constructor();for(let r in t)Object.prototype.hasOwnProperty.call(t,r)&&(t.isActiveClone=null,e[r]=Ht.clone(t[r]),delete t.isActiveClone);return e},isArray:y,getVariableType:Xt,getKernelTextureSize(t,e){let[r,n,i]=e,s=(r||1)*(n||1)*(i||1);return t.optimizeFloatMemory&&"single"===t.precision&&(r=s=Math.ceil(s/4)),n>1&&r*n===s?new Int32Array([r,n]):Ht.closestSquareDimensions(s)},closestSquareDimensions(t){const e=Math.sqrt(t);let r=Math.ceil(e),n=Math.floor(e);for(;r*n<t;)r--,n=Math.ceil(t/r);return new Int32Array([n,Math.ceil(t/n)])},getMemoryOptimizedFloatTextureSize(t,e){const r=Ht.roundTo((t[0]||1)*(t[1]||1)*(t[2]||1)*(t[3]||1),4)/e;return Ht.closestSquareDimensions(r)},getMemoryOptimizedPackedTextureSize(t,e){const[r,n,i]=t,s=Ht.roundTo((r||1)*(n||1)*(i||1),4)/(4/e);return Ht.closestSquareDimensions(s)},roundTo:(t,e)=>Math.floor((t+e-1)/e)*e,getDimensions(t,e){let r;if(y(t)){const e=[];let n=t;for(;y(n);)e.push(n.length),n=n[0];r=e.reverse()}else if(t instanceof Bt)r=t.output;else{if(!(t instanceof E))throw new Error(`Unknown dimensions of ${t}`);r=t.size}if(e)for(r=Array.from(r);r.length<3;)r.push(1);return new Int32Array(r)},flatten2dArrayTo(t,e){let r=0;for(let n=0;n<t.length;n++)e.set(t[n],r),r+=t[n].length},flatten3dArrayTo(t,e){let r=0;for(let n=0;n<t.length;n++)for(let i=0;i<t[n].length;i++)e.set(t[n][i],r),r+=t[n][i].length},flatten4dArrayTo(t,e){let r=0;for(let n=0;n<t.length;n++)for(let i=0;i<t[n].length;i++)for(let s=0;s<t[n][i].length;s++)e.set(t[n][i][s],r),r+=t[n][i][s].length},flattenTo(t,e){y(t[0])?y(t[0][0])?y(t[0][0][0])?Ht.flatten4dArrayTo(t,e):Ht.flatten3dArrayTo(t,e):Ht.flatten2dArrayTo(t,e):e.set(t)},splitArray(t,e){const r=[];for(let n=0;n<t.length;n+=e)r.push(new t.constructor(t.buffer,4*n+t.byteOffset,e));return r},getAstString:A,allPropertiesOf(t){const e=[];do{e.push.apply(e,Object.getOwnPropertyNames(t))}while(t=Object.getPrototypeOf(t));return e},linesToString:t=>t.length>0?t.join(";\n")+";\n":"\n",warnDeprecated:f,functionToIFunction:m,flipPixels(t,e,r){const n=r/2|0,i=4*e,s=new Uint8ClampedArray(4*e),a=t.slice(0);for(let t=0;t<n;++t){const e=t*i,n=(r-t-1)*i;s.set(a.subarray(e,e+i)),a.copyWithin(e,n,n+i),a.set(s,n)}return a},erectPackedFloat:(t,e)=>t.subarray(0,e),erect2DPackedFloat:(t,e,r)=>{const n=new Array(r);for(let i=0;i<r;i++){const r=i*e,s=r+e;n[i]=t.subarray(r,s)}return n},erect3DPackedFloat:(t,e,r,n)=>{const i=new Array(n);for(let s=0;s<n;s++){const n=new Array(r);for(let i=0;i<r;i++){const a=s*r*e+i*e,o=a+e;n[i]=t.subarray(a,o)}i[s]=n}return i},erectMemoryOptimizedFloat:(t,e)=>t.subarray(0,e),erectMemoryOptimized2DFloat:T,erectMemoryOptimized3DFloat:b,erectFloat:(t,e)=>{const r=new Float32Array(e);let n=0;for(let i=0;i<e;i++)r[i]=t[n],n+=4;return r},erect2DFloat:(t,e,r)=>{const n=new Array(r);let i=0;for(let s=0;s<r;s++){const r=new Float32Array(e);for(let n=0;n<e;n++)r[n]=t[i],i+=4;n[s]=r}return n},erect3DFloat:(t,e,r,n)=>{const i=new Array(n);let s=0;for(let a=0;a<n;a++){const n=new Array(r);for(let i=0;i<r;i++){const r=new Float32Array(e);for(let n=0;n<e;n++)r[n]=t[s],s+=4;n[i]=r}i[a]=n}return i},erectArray2:(t,e)=>{const r=new Array(e),n=4*e;let i=0;for(let e=0;e<n;e+=4)r[i++]=t.subarray(e,e+2);return r},erect2DArray2:(t,e,r)=>{const n=new Array(r),i=4*e;for(let s=0;s<r;s++){const r=new Array(e),a=s*i;let o=0;for(let e=0;e<i;e+=4)r[o++]=t.subarray(e+a,e+a+2);n[s]=r}return n},erect3DArray2:(t,e,r,n)=>{const i=4*e,s=new Array(n);for(let a=0;a<n;a++){const n=new Array(r);for(let s=0;s<r;s++){const o=new Array(e),u=a*i*r+s*i;let h=0;for(let e=0;e<i;e+=4)o[h++]=t.subarray(e+u,e+u+2);n[s]=o}s[a]=n}return s},erectArray3:(t,e)=>{const r=new Array(e),n=4*e;let i=0;for(let e=0;e<n;e+=4)r[i++]=t.subarray(e,e+3);return r},erect2DArray3:(t,e,r)=>{const n=4*e,i=new Array(r);for(let s=0;s<r;s++){const r=new Array(e),a=s*n;let o=0;for(let e=0;e<n;e+=4)r[o++]=t.subarray(e+a,e+a+3);i[s]=r}return i},erect3DArray3:(t,e,r,n)=>{const i=4*e,s=new Array(n);for(let a=0;a<n;a++){const n=new Array(r);for(let s=0;s<r;s++){const o=new Array(e),u=a*i*r+s*i;let h=0;for(let e=0;e<i;e+=4)o[h++]=t.subarray(e+u,e+u+3);n[s]=o}s[a]=n}return s},erectArray4:(t,e)=>{const r=new Array(t),n=4*e;let i=0;for(let e=0;e<n;e+=4)r[i++]=t.subarray(e,e+4);return r},erect2DArray4:(t,e,r)=>{const n=4*e,i=new Array(r);for(let s=0;s<r;s++){const r=new Array(e),a=s*n;let o=0;for(let e=0;e<n;e+=4)r[o++]=t.subarray(e+a,e+a+4);i[s]=r}return i},erect3DArray4:(t,e,r,n)=>{const i=4*e,s=new Array(n);for(let a=0;a<n;a++){const n=new Array(r);for(let s=0;s<r;s++){const o=new Array(e),u=a*i*r+s*i;let h=0;for(let e=0;e<i;e+=4)o[h++]=t.subarray(e+u,e+u+4);n[s]=o}s[a]=n}return s},flattenFunctionToString:(t,e)=>{const{findDependency:r,thisLookup:n,doNotDefine:i}=e;let s=e.flattened;s||(s=e.flattened={});const a=Kt(t),o=[];const u=function t(e){if(Array.isArray(e)){const r=[];for(let n=0;n<e.length;n++)r.push(t(e[n]));return r.join("")}switch(e.type){case"Program":return t(e.body);case"FunctionDeclaration":return`function ${e.id.name}(${e.params.map(t).join(", ")}) ${t(e.body)}`;case"BlockStatement":{const r=[];for(let n=0;n<e.body.length;n++)r.push(t(e.body[n]),";\n");return`{\n${r.join("")}}`}case"VariableDeclaration":switch(e.declarations[0].id.type){case"ObjectPattern":{const r=t(e.declarations[0].init),i=e.declarations.map(e=>e.id.properties.map(t))[0];if(/this/.test(r)){const t=[],r=i.map(n);for(let n=0;n<r.length;n++){const s=r[n];if(null===s)continue;const a=i[n];t.push(`${e.kind} ${a} = ${s};\n`)}return t.join("")}return`${e.kind} { ${i} } = ${r}`}case"ArrayPattern":return`${e.kind} [ ${e.declarations.map(e=>t(e.id)).join(", ")} ] = ${t(e.declarations[0].init)}`}return i&&-1!==i.indexOf(e.declarations[0].id.name)?"":`${e.kind} ${e.declarations[0].id.name} = ${t(e.declarations[0].init)}`;case"CallExpression":if("subarray"===e.callee.property.name)return`${t(e.callee.object)}.${t(e.callee.property)}(${e.arguments.map(e=>t(e)).join(", ")})`;if("gl"===e.callee.object.name||"context"===e.callee.object.name)return`${t(e.callee.object)}.${t(e.callee.property)}(${e.arguments.map(e=>t(e)).join(", ")})`;if("ThisExpression"===e.callee.object.type)return o.push(r("this",e.callee.property.name)),`${e.callee.property.name}(${e.arguments.map(e=>t(e)).join(", ")})`;if(e.callee.object.name){const n=r(e.callee.object.name,e.callee.property.name);return null===n?`${e.callee.object.name}.${e.callee.property.name}(${e.arguments.map(e=>t(e)).join(", ")})`:(o.push(n),`${e.callee.property.name}(${e.arguments.map(e=>t(e)).join(", ")})`)}if("MemberExpression"===e.callee.object.type)return`${t(e.callee.object)}.${e.callee.property.name}(${e.arguments.map(e=>t(e)).join(", ")})`;throw new Error("unknown ast.callee");case"ReturnStatement":return`return ${t(e.argument)}`;case"BinaryExpression":return`(${t(e.left)}${e.operator}${t(e.right)})`;case"UnaryExpression":return e.prefix?`${e.operator} ${t(e.argument)}`:`${t(e.argument)} ${e.operator}`;case"ExpressionStatement":return`(${t(e.expression)})`;case"ArrowFunctionExpression":return`(${e.params.map(t).join(", ")}) => ${t(e.body)}`;case"Literal":return e.raw;case"Identifier":return e.name;case"MemberExpression":return"ThisExpression"===e.object.type?n(e.property.name):e.computed?`${t(e.object)}[${t(e.property)}]`:t(e.object)+"."+t(e.property);case"ThisExpression":return"this";case"NewExpression":return`new ${t(e.callee)}(${e.arguments.map(e=>t(e)).join(", ")})`;case"ForStatement":return`for (${t(e.init)};${t(e.test)};${t(e.update)}) ${t(e.body)}`;case"AssignmentExpression":return`${t(e.left)}${e.operator}${t(e.right)}`;case"UpdateExpression":return`${t(e.argument)}${e.operator}`;case"IfStatement":return`if (${t(e.test)}) ${t(e.consequent)}`;case"ThrowStatement":return`throw ${t(e.argument)}`;case"ObjectPattern":return e.properties.map(t).join(", ");case"ArrayPattern":return e.elements.map(t).join(", ");case"DebuggerStatement":return"debugger;";case"ConditionalExpression":return`${t(e.test)}?${t(e.consequent)}:${t(e.alternate)}`;case"Property":if("init"===e.kind)return t(e.key)}throw new Error(`unhandled ast.type of ${e.type}`)}(a);if(o.length>0){const t=[];for(let r=0;r<o.length;r++){const n=o[r];s[n]||(s[n]=!0),t.push(Ht.flattenFunctionToString(n,e)+";\n")}return t.join("")+u}return u}};class Wt{static get isSupported(){throw new Error(`"isSupported" not implemented on ${this.name}`)}static isContextMatch(t){throw new Error(`"isContextMatch" not implemented on ${this.name}`)}static getFeatures(){throw new Error(`"getFeatures" not implemented on ${this.name}`)}static destroyContext(t){throw new Error(`"destroyContext" called on ${this.name}`)}static nativeFunctionArguments(){throw new Error(`"nativeFunctionArguments" called on ${this.name}`)}static nativeFunctionReturnType(){throw new Error(`"nativeFunctionReturnType" called on ${this.name}`)}static combineKernels(){throw new Error(`"combineKernels" called on ${this.name}`)}constructor(t,e){if("object"!=typeof t){if("string"!=typeof t)throw new Error("source not a string");if(!g(t))throw new Error("source not a function string")}this.useLegacyEncoder=!1,this.fallbackRequested=!1,this.onRequestFallback=null,this.argumentNames="string"==typeof t?x(t):null,this.argumentTypes=null,this.argumentSizes=null,this.argumentBitRatios=null,this.kernelArguments=null,this.kernelConstants=null,this.source=t,this.output=null,this.debug=!1,this.graphical=!1,this.loopMaxIterations=0,this.constants=null,this.constantTypes=null,this.constantBitRatios=null,this.dynamicArguments=!1,this.dynamicOutput=!1,this.canvas=null,this.context=null,this.checkContext=null,this.gpu=null,this.functions=null,this.nativeFunctions=null,this.injectedNative=null,this.subKernels=null,this.validate=!0,this.immutable=!1,this.pipeline=!1,this.precision=null,this.tactic="balanced",this.plugins=null,this.returnType=null,this.leadingReturnStatement=null,this.followingReturnStatement=null,this.optimizeFloatMemory=null,this.strictIntegers=!1,this.fixIntegerDivisionAccuracy=null,this.warnVarUsage=!0}mergeSettings(t){for(let e in t)if(t.hasOwnProperty(e)&&this.hasOwnProperty(e)){switch(e){case"output":if(!Array.isArray(t.output)){this.setOutput(t.output);continue}break;case"functions":if("function"==typeof t.functions[0]){this.functions=t.functions.map(t=>m(t));continue}break;case"graphical":t[e]&&!t.hasOwnProperty("precision")&&(this.precision="unsigned"),this[e]=t[e];continue}this[e]=t[e]}this.canvas||(this.canvas=this.initCanvas()),this.context||(this.context=this.initContext()),this.plugins||(this.plugins=this.initPlugins(t))}build(){throw new Error(`"build" not defined on ${this.constructor.name}`)}run(){throw new Error(`"run" not defined on ${this.constructor.name}`)}initCanvas(){throw new Error(`"initCanvas" not defined on ${this.constructor.name}`)}initContext(){throw new Error(`"initContext" not defined on ${this.constructor.name}`)}initPlugins(t){throw new Error(`"initPlugins" not defined on ${this.constructor.name}`)}setupArguments(t){if(this.kernelArguments=[],this.argumentTypes)for(let t=0;t<this.argumentTypes.length;t++)this.kernelArguments.push({type:this.argumentTypes[t]});else if(!this.argumentTypes){this.argumentTypes=[];for(let e=0;e<t.length;e++){const r=Xt(t[e],this.strictIntegers),n="Integer"===r?"Number":r;this.argumentTypes.push(n),this.kernelArguments.push({type:n})}}this.argumentSizes=new Array(t.length),this.argumentBitRatios=new Int32Array(t.length);for(let e=0;e<t.length;e++){const r=t[e];this.argumentSizes[e]=r.constructor===E?r.size:null,this.argumentBitRatios[e]=this.getBitRatio(r)}if(this.argumentNames.length!==t.length)throw new Error("arguments are miss-aligned")}setupConstants(){this.kernelConstants=[];let t=null===this.constantTypes;if(t&&(this.constantTypes={}),this.constantBitRatios={},this.constants)for(let e in this.constants){if(t){const t=Xt(this.constants[e],this.strictIntegers);this.constantTypes[e]=t,this.kernelConstants.push({name:e,type:t})}else this.kernelConstants.push({name:e,type:this.constantTypes[e]});this.constantBitRatios[e]=this.getBitRatio(this.constants[e])}}setOptimizeFloatMemory(t){return this.optimizeFloatMemory=t,this}setOutput(t){return t.hasOwnProperty("x")?t.hasOwnProperty("y")?t.hasOwnProperty("z")?this.output=[t.x,t.y,t.z]:this.output=[t.x,t.y]:this.output=[t.x]:this.output=t,this}setDebug(t){return this.debug=t,this}setGraphical(t){return this.graphical=t,this.precision="unsigned",this}setLoopMaxIterations(t){return this.loopMaxIterations=t,this}setConstants(t){return this.constants=t,this}setConstantTypes(t){return this.constantTypes=t,this}setFunctions(t){return"function"==typeof t[0]?this.functions=t.map(t=>m(t)):this.functions=t,this}setNativeFunctions(t){return this.nativeFunctions=t,this}setInjectedNative(t){return this.injectedNative=t,this}setPipeline(t){return this.pipeline=t,this}setPrecision(t){return this.precision=t,this}setOutputToTexture(t){return f("method","setOutputToTexture","setPipeline"),this.pipeline=t,this}setImmutable(t){return this.immutable=t,this}setCanvas(t){return this.canvas=t,this}setStrictIntegers(t){return this.strictIntegers=t,this}setDynamicOutput(t){return this.dynamicOutput=t,this}setHardcodeConstants(t){return f("method","setHardcodeConstants"),this.setDynamicOutput(t),this.setDynamicArguments(t),this}setDynamicArguments(t){return this.dynamicArguments=t,this}setUseLegacyEncoder(t){return this.useLegacyEncoder=t,this}setWarnVarUsage(t){return this.warnVarUsage=t,this}getCanvas(){return f("method","getCanvas"),this.canvas}getWebGl(){return f("method","getWebGl"),this.context}setContext(t){return this.context=t,this}setArgumentTypes(t){if(Array.isArray(t))this.argumentTypes=t;else{this.argumentTypes=[];for(const e in t){const r=this.argumentNames.indexOf(e);if(-1===r)throw new Error(`unable to find argument ${e}`);this.argumentTypes[r]=t[e]}}return this}setTactic(t){return this.tactic=t,this}requestFallback(t){if(!this.onRequestFallback)throw new Error(`"onRequestFallback" not defined on ${this.constructor.name}`);return this.fallbackRequested=!0,this.onRequestFallback(t)}validateSettings(){throw new Error(`"validateSettings" not defined on ${this.constructor.name}`)}addSubKernel(t){if(null===this.subKernels&&(this.subKernels=[]),!t.source)throw new Error('subKernel missing "source" property');if(!t.property&&isNaN(t.property))throw new Error('subKernel missing "property" property');if(!t.name)throw new Error('subKernel missing "name" property');return this.subKernels.push(t),this}destroy(t){throw new Error(`"destroy" called on ${this.constructor.name}`)}getBitRatio(t){if("single"===this.precision)return 4;if(Array.isArray(t[0]))return this.getBitRatio(t[0]);if(t.constructor===E)return this.getBitRatio(t.value);switch(t.constructor){case Uint8ClampedArray:case Uint8Array:case Int8Array:return 1;case Uint16Array:case Int16Array:return 2;case Float32Array:case Int32Array:default:return 4}}getPixels(){throw new Error(`"getPixels" called on ${this.constructor.name}`)}checkOutput(){if(!this.output||!y(this.output))throw new Error("kernel.output not an array");if(this.output.length<1)throw new Error("kernel.output is empty, needs at least 1 value");for(let t=0;t<this.output.length;t++)if(isNaN(this.output[t])||this.output[t]<1)throw new Error(`${this.constructor.name}.output[${t}] incorrectly defined as \`${this.output[t]}\`, needs to be numeric, and greater than 0`)}toJSON(){return{settings:{output:this.output,threadDim:this.threadDim,pipeline:this.pipeline,argumentNames:this.argumentNames,argumentsTypes:this.argumentTypes,constants:this.constants,pluginNames:this.plugins?this.plugins.map(t=>t.name):null,returnType:this.returnType}}}}class qt{static fromKernel(t,e,r){const{kernelArguments:n,kernelConstants:i,argumentNames:s,argumentSizes:a,argumentBitRatios:o,constants:u,constantBitRatios:h,debug:l,loopMaxIterations:c,nativeFunctions:p,output:d,optimizeFloatMemory:m,precision:f,plugins:g,source:x,subKernels:y,functions:T,leadingReturnStatement:b,followingReturnStatement:A,dynamicArguments:S,dynamicOutput:E,warnVarUsage:_}=t,v=new Array(n.length),w={};for(let t=0;t<n.length;t++)v[t]=n[t].type;for(let t=0;t<i.length;t++){const e=i[t];w[e.name]=e.type}const I=(t,e)=>K.needsArgumentType(t,e),D=(t,e,r)=>{K.assignArgumentType(t,e,r)},R=(t,e,r)=>K.lookupReturnType(t,e,r),k=t=>K.lookupFunctionArgumentTypes(t),$=(t,e)=>K.lookupFunctionArgumentName(t,e),C=(t,e)=>K.lookupFunctionArgumentBitRatio(t,e),F=(t,e,r,n)=>{K.assignArgumentType(t,e,r,n)},N=(t,e,r,n)=>{K.trackArgumentSynonym(t,e,r,n)},O=(t,e,r)=>K.lookupArgumentSynonym(t,e,r),P=(t,e,r)=>{K.trackFunctionCall(t,e,r)},z=Object.assign({isRootKernel:!1,onNestedFunction:(t,r)=>{const n=[];for(let e=0;e<t.params.length;e++)n.push(t.params[e].name);const i=new e(null,Object.assign({},z,{returnType:null,ast:t,name:t.id.name,argumentNames:n,lookupReturnType:R,lookupFunctionArgumentTypes:k,lookupFunctionArgumentName:$,lookupFunctionArgumentBitRatio:C,needsArgumentType:I,assignArgumentType:D,triggerImplyArgumentType:F,triggerTrackArgumentSynonym:N,lookupArgumentSynonym:O,onFunctionCall:P,warnVarUsage:_}));i.traceFunctionAST(t),K.addFunctionNode(i)},lookupReturnType:R,lookupFunctionArgumentTypes:k,lookupFunctionArgumentName:$,lookupFunctionArgumentBitRatio:C,needsArgumentType:I,assignArgumentType:D,triggerImplyArgumentType:F,triggerTrackArgumentSynonym:N,lookupArgumentSynonym:O,onFunctionCall:P,optimizeFloatMemory:m,precision:f,constants:u,constantTypes:w,constantBitRatios:h,debug:l,loopMaxIterations:c,output:d,plugins:g,dynamicArguments:S,dynamicOutput:E},r||{}),L=Object.assign({},z,{isRootKernel:!0,name:"kernel",argumentNames:s,argumentTypes:v,argumentSizes:a,argumentBitRatios:o,leadingReturnStatement:b,followingReturnStatement:A});if("object"==typeof x&&x.functionNodes)return(new qt).fromJSON(x.functionNodes,e);const M=new e(x,L);let V=null;T&&(V=T.map(t=>new e(t.source,{returnType:t.returnType,argumentTypes:t.argumentTypes,output:d,plugins:g,constants:u,constantTypes:w,constantBitRatios:h,optimizeFloatMemory:m,precision:f,lookupReturnType:R,lookupFunctionArgumentTypes:k,lookupFunctionArgumentName:$,lookupFunctionArgumentBitRatio:C,needsArgumentType:I,assignArgumentType:D,triggerImplyArgumentType:F,triggerTrackArgumentSynonym:N,lookupArgumentSynonym:O,onFunctionCall:P})));let U=null;y&&(U=y.map(t=>{const{name:r,source:n}=t;return new e(n,Object.assign({},z,{name:r,isSubKernel:!0,isRootKernel:!1}))}));const K=new qt({kernel:t,rootNode:M,functionNodes:V,nativeFunctions:p,subKernelNodes:U});return K}constructor(t){if(t=t||{},this.kernel=t.kernel,this.rootNode=t.rootNode,this.functionNodes=t.functionNodes||[],this.subKernelNodes=t.subKernelNodes||[],this.nativeFunctions=t.nativeFunctions||[],this.functionMap={},this.nativeFunctionNames=[],this.lookupChain=[],this.argumentChain=[],this.functionNodeDependencies={},this.functionCalls={},this.rootNode&&(this.functionMap.kernel=this.rootNode),this.functionNodes)for(let t=0;t<this.functionNodes.length;t++)this.functionMap[this.functionNodes[t].name]=this.functionNodes[t];if(this.subKernelNodes)for(let t=0;t<this.subKernelNodes.length;t++)this.functionMap[this.subKernelNodes[t].name]=this.subKernelNodes[t];if(this.nativeFunctions)for(let t=0;t<this.nativeFunctions.length;t++){const e=this.nativeFunctions[t];this.nativeFunctionNames.push(e.name)}}addFunctionNode(t){if(!t.name)throw new Error("functionNode.name needs set");this.functionMap[t.name]=t,t.isRootKernel&&(this.rootNode=t)}traceFunctionCalls(t,e){if(t=t||"kernel",e=e||[],this.nativeFunctionNames.indexOf(t)>-1)return-1===e.indexOf(t)&&e.push(t),e;const r=this.functionMap[t];if(r){const n=e.indexOf(t);if(-1===n){e.push(t),r.toString();for(let t=0;t<r.calledFunctions.length;++t)this.traceFunctionCalls(r.calledFunctions[t],e)}else{const t=e.splice(n,1)[0];e.push(t)}}return e}getPrototypeString(t){return this.getPrototypes(t).join("\n")}getPrototypes(t){return this.rootNode&&this.rootNode.toString(),t?this.getPrototypesFromFunctionNames(this.traceFunctionCalls(t,[]).reverse()):this.getPrototypesFromFunctionNames(Object.keys(this.functionMap))}getStringFromFunctionNames(t){const e=[];for(let r=0;r<t.length;++r){this.functionMap[t[r]]&&e.push(this.functionMap[t[r]].toString())}return e.join("\n")}getPrototypesFromFunctionNames(t){const e=[];for(let r=0;r<t.length;++r){const n=t[r],i=this.nativeFunctionNames.indexOf(n);if(i>-1){e.push(this.nativeFunctions[i].source);continue}const s=this.functionMap[n];s&&e.push(s.toString())}return e}toJSON(){return this.traceFunctionCalls(this.rootNode.name).reverse().map(t=>{const e=this.nativeFunctions.indexOf(t);if(e>-1)return{name:t,source:this.nativeFunctions[e].source};if(this.functionMap[t])return this.functionMap[t].toJSON();throw new Error(`function ${t} not found`)})}fromJSON(t,e){this.functionMap={};for(let r=0;r<t.length;r++){const n=t[r];this.functionMap[n.settings.name]=new e(n.ast,n.settings)}return this}getString(t){return t?this.getStringFromFunctionNames(this.traceFunctionCalls(t).reverse()):this.getStringFromFunctionNames(Object.keys(this.functionMap))}lookupReturnType(t,e,r){if("CallExpression"!==e.type)throw new Error(`expected ast type of "CallExpression", but is ${e.type}`);if(this._isNativeFunction(t))return this._lookupNativeFunctionReturnType(t);if(this._isFunction(t)){const n=this._getFunction(t);if(n.returnType)return n.returnType;{for(let t=0;t<this.lookupChain.length;t++)if(this.lookupChain[t].ast===e){if(0===n.argumentTypes.length&&e.arguments.length>0){const i=e.arguments;for(let e=0;e<i.length;e++)this.lookupChain.push({name:r.name,ast:i[t],requestingNode:r}),n.argumentTypes[e]=r.getType(i[e]),this.lookupChain.pop();return n.returnType=n.getType(n.getJsAST())}throw new Error("circlical logic detected!")}this.lookupChain.push({name:r.name,ast:e,requestingNode:r});const t=n.getType(n.getJsAST());return this.lookupChain.pop(),n.returnType=t}}return null}_getFunction(t){return this._isFunction(t),this.functionMap[t]}_isFunction(t){return Boolean(this.functionMap[t])}_getNativeFunction(t){for(let e=0;e<this.nativeFunctions.length;e++)if(this.nativeFunctions[e].name===t)return this.nativeFunctions[e];return null}_isNativeFunction(t){return Boolean(this._getNativeFunction(t))}_lookupNativeFunctionReturnType(t){let e=this._getNativeFunction(t);if(e)return e.returnType;throw new Error(`Native function ${t} not found`)}lookupFunctionArgumentTypes(t){return this._isNativeFunction(t)?this._getNativeFunction(t).argumentTypes:this._isFunction(t)?this._getFunction(t).argumentTypes:null}lookupFunctionArgumentName(t,e){return this._getFunction(t).argumentNames[e]}lookupFunctionArgumentBitRatio(t,e){if(!this._isFunction(t))throw new Error("function not found");if(this.rootNode.name===t){const t=this.rootNode.argumentNames.indexOf(e);if(-1!==t)return this.rootNode.argumentBitRatios[t];throw new Error("argument bit ratio not found")}{const e=this._getFunction(t),r=e.argumentSynonym[e.synonymIndex];if(!r)throw new Error("argument synonym not found");return this.lookupFunctionArgumentBitRatio(r.functionName,r.argumentName)}}needsArgumentType(t,e){if(!this._isFunction(t))return!1;return!this._getFunction(t).argumentTypes[e]}assignArgumentType(t,e,r,n){if(!this._isFunction(t))return;const i=this._getFunction(t);i.argumentTypes[e]||(i.argumentTypes[e]=r)}trackArgumentSynonym(t,e,r,n){if(!this._isFunction(r))return;const i=this._getFunction(r);i.argumentSynonym||(i.argumentSynonym={});const s=i.argumentNames[n];i.argumentSynonym[s]||(i.argumentSynonym[s]={}),i.synonymIndex++,i.argumentSynonym[i.synonymIndex]={functionName:t,argumentName:e,calleeArgumentName:s,calleeFunctionName:r}}lookupArgumentSynonym(t,e,r){if(t===e)return r;if(!this._isFunction(e))return null;const n=this._getFunction(e),i=n.argumentSynonym[n.synonymUseIndex];return i?i.calleeArgumentName!==r?null:(n.synonymUseIndex++,t!==e?this.lookupArgumentSynonym(t,i.functionName,i.argumentName):i.argumentName):null}trackFunctionCall(t,e,r){this.functionNodeDependencies[t]||(this.functionNodeDependencies[t]=new Set,this.functionCalls[t]=[]),this.functionNodeDependencies[t].add(e),this.functionCalls[t].push(r)}getKernelResultType(){return this.rootNode.returnType||this.rootNode.getType(this.rootNode.ast)}getSubKernelResultType(t){const e=this.subKernelNodes[t];let r=!1;for(let t=0;t<this.rootNode.functionCalls.length;t++){this.rootNode.functionCalls[t].ast.callee.name===e.name&&(r=!0)}if(!r)throw new Error(`SubKernel ${e.name} never called by kernel`);return e.returnType||e.getType(e.getJsAST())}getReturnTypes(){const t={[this.rootNode.name]:this.rootNode.getType(this.rootNode.ast)},e=this.traceFunctionCalls(this.rootNode.name);for(let r=0;r<e.length;r++){const n=e[r],i=this.functionMap[n];t[n]=i.getType(i.ast)}return t}}class Yt{constructor(t){this.runningContexts=[],this.contexts=[],this.functionCalls=[],this.declarations=[],this.identifiers=[],this.functions=[],this.returnStatements=[],this.inLoopInit=!1,this.scan(t)}get currentContext(){return this.runningContexts.length>0?this.runningContexts[this.runningContexts.length-1]:null}newContext(t){const e=Object.assign({},this.currentContext);this.contexts.push(e),this.runningContexts.push(e),t(),this.runningContexts.pop()}scan(t){if(Array.isArray(t))for(let e=0;e<t.length;e++)this.scan(t[e]);else switch(t.type){case"Program":this.scan(t.body);break;case"BlockStatement":this.newContext(()=>{this.scan(t.body)});break;case"AssignmentExpression":case"LogicalExpression":case"BinaryExpression":this.scan(t.left),this.scan(t.right);break;case"UpdateExpression":case"UnaryExpression":this.scan(t.argument);break;case"VariableDeclaration":this.scan(t.declarations);break;case"VariableDeclarator":const{currentContext:e}=this,r={ast:t,context:e,name:t.id.name,origin:"declaration",forceInteger:this.inLoopInit,assignable:!this.inLoopInit&&!e.hasOwnProperty(t.id.name)};e[t.id.name]=r,this.declarations.push(r),this.scan(t.id),this.scan(t.init);break;case"FunctionExpression":case"FunctionDeclaration":0===this.runningContexts.length?this.scan(t.body):this.functions.push(t);break;case"IfStatement":this.scan(t.test),this.scan(t.consequent),t.alternate&&this.scan(t.alternate);break;case"ForStatement":this.newContext(()=>{this.inLoopInit=!0,this.scan(t.init),this.inLoopInit=!1,this.scan(t.test),this.scan(t.update),this.newContext(()=>{this.scan(t.body)})});break;case"DoWhileStatement":case"WhileStatement":this.newContext(()=>{this.scan(t.body),this.scan(t.test)});break;case"Identifier":this.identifiers.push({context:this.currentContext,ast:t});break;case"ReturnStatement":this.returnStatements.push(t),this.scan(t.argument);break;case"MemberExpression":this.scan(t.object),this.scan(t.property);break;case"ExpressionStatement":this.scan(t.expression);break;case"CallExpression":this.functionCalls.push({context:this.currentContext,ast:t}),this.scan(t.arguments);break;case"ArrayExpression":this.scan(t.elements);break;case"ConditionalExpression":this.scan(t.test),this.scan(t.alternate),this.scan(t.consequent);break;case"SwitchStatement":this.scan(t.discriminant),this.scan(t.cases);break;case"SwitchCase":this.scan(t.test),this.scan(t.consequent);break;case"ThisExpression":this.scan(t.left),this.scan(t.right);break;case"Literal":case"DebuggerStatement":case"EmptyStatement":case"BreakStatement":case"ContinueStatement":break;default:throw new Error(`unhandled type "${t.type}"`)}}}class Zt{constructor(t,e){if(!t&&!e.ast)throw new Error("source parameter is missing");if(e=e||{},this.source=t,this.ast=null,this.name="string"==typeof t?e.isRootKernel?"kernel":e.name||d(t):null,this.calledFunctions=[],this.constants={},this.constantTypes={},this.constantBitRatios={},this.isRootKernel=!1,this.isSubKernel=!1,this.debug=null,this.declarations=null,this.functions=null,this.identifiers=null,this.contexts=null,this.functionCalls=null,this.states=[],this.needsArgumentType=null,this.assignArgumentType=null,this.lookupReturnType=null,this.lookupFunctionArgumentTypes=null,this.lookupFunctionArgumentBitRatio=null,this.triggerImplyArgumentType=null,this.triggerImplyArgumentBitRatio=null,this.onNestedFunction=null,this.onFunctionCall=null,this.optimizeFloatMemory=null,this.precision=null,this.loopMaxIterations=null,this.argumentNames="string"==typeof this.source?x(this.source):null,this.argumentTypes=[],this.argumentSizes=[],this.argumentBitRatios=null,this.returnType=null,this.output=[],this.plugins=null,this.leadingReturnStatement=null,this.followingReturnStatement=null,this.dynamicOutput=null,this.dynamicArguments=null,this.strictTypingChecking=!1,this.fixIntegerDivisionAccuracy=null,this.warnVarUsage=!0,e)for(const t in e)e.hasOwnProperty(t)&&this.hasOwnProperty(t)&&(this[t]=e[t]);this.literalTypes={},this.validate(),this._string=null,this._internalVariableNames={}}validate(){if("string"!=typeof this.source&&!this.ast)throw new Error("this.source not a string");if(!this.ast&&!g(this.source))throw new Error("this.source not a function string");if(!this.name)throw new Error("this.name could not be set");if(this.argumentTypes.length>0&&this.argumentTypes.length!==this.argumentNames.length)throw new Error(`argumentTypes count of ${this.argumentTypes.length} exceeds ${this.argumentNames.length}`);if(this.output.length<1)throw new Error("this.output is not big enough")}isIdentifierConstant(t){return!!this.constants&&this.constants.hasOwnProperty(t)}isInput(t){return"Input"===this.argumentTypes[this.argumentNames.indexOf(t)]}pushState(t){this.states.push(t)}popState(t){if(this.state!==t)throw new Error(`Cannot popState ${t} when in ${this.state}`);this.states.pop()}isState(t){return this.state===t}get state(){return this.states[this.states.length-1]}astMemberExpressionUnroll(t){if("Identifier"===t.type)return t.name;if("ThisExpression"===t.type)return"this";if("MemberExpression"===t.type&&t.object&&t.property)return t.object.hasOwnProperty("name")&&"_"===t.object.name[0]?this.astMemberExpressionUnroll(t.property):this.astMemberExpressionUnroll(t.object)+"."+this.astMemberExpressionUnroll(t.property);if(t.hasOwnProperty("expressions")){const e=t.expressions[0];if("Literal"===e.type&&0===e.value&&2===t.expressions.length)return this.astMemberExpressionUnroll(t.expressions[1])}throw this.astErrorOutput("Unknown astMemberExpressionUnroll",t)}getJsAST(t){if(this.ast)return this.ast;if("object"==typeof this.source)return this.traceFunctionAST(this.source),this.ast=this.source;const e=t&&t.hasOwnProperty("parse")?t.parse:Kt;if(null===t)throw new Error("Missing JS to AST parser");const r=Object.freeze(e(`const parser_${this.name} = ${this.source};`,{locations:!0})),n=r.body[0].declarations[0].init;if(this.traceFunctionAST(n),!r)throw new Error("Failed to parse JS code");return this.ast=n}traceFunctionAST(t){const{contexts:e,declarations:r,functions:n,identifiers:i,functionCalls:s}=new Yt(t);this.contexts=e,this.identifiers=i,this.functionCalls=s,this.declarations=[],this.functions=n;for(let t=0;t<r.length;t++){const e=r[t],{ast:n,context:i,name:s,origin:a,forceInteger:o,assignable:u}=e,{init:h}=n,l=this.getDependencies(h);let c=null;if(o)c="Integer";else if(h){const t=this.getType(h);switch(t){case"Integer":case"Float":case"Number":c="MemberExpression"===h.type?t:"Number";break;case"LiteralInteger":c="Number";break;default:c=t}}this.declarations.push({valueType:c,dependencies:l,isSafe:this.isSafeDependencies(l),ast:n,name:s,context:i,origin:a,assignable:u})}for(let t=0;t<n.length;t++)this.onNestedFunction(n[t])}getDeclaration(t){for(let e=0;e<this.identifiers.length;e++){const r=this.identifiers[e];if(t===r.ast&&r.context.hasOwnProperty(t.name))for(let e=0;e<this.declarations.length;e++){const n=this.declarations[e];if(n.name===t.name&&n.context[t.name]===r.context[t.name])return n}}return null}getVariableType(t){if("Identifier"!==t.type)throw new Error(`ast of ${t.type} not "Identifier"`);let e=null;const r=this.argumentNames.indexOf(t.name);if(-1===r){const e=this.getDeclaration(t);if(e)return e.valueType}else{const t=this.argumentTypes[r];t&&(e=t)}if(!e&&this.strictTypingChecking)throw new Error(`Declaration of ${name} not found`);return e}getLookupType(t){if(!Jt.hasOwnProperty(t))throw new Error(`unknown typeLookupMap ${t}`);return Jt[t]}getConstantType(t){if(this.constantTypes[t]){const e=this.constantTypes[t];return"Float"===e?"Number":e}throw new Error(`Type for constant "${t}" not declared`)}toString(){return this._string?this._string:this._string=this.astGeneric(this.getJsAST(),[]).join("").trim()}toJSON(){const t={source:this.source,name:this.name,constants:this.constants,constantTypes:this.constantTypes,isRootKernel:this.isRootKernel,isSubKernel:this.isSubKernel,debug:this.debug,output:this.output,loopMaxIterations:this.loopMaxIterations,argumentNames:this.argumentNames,argumentTypes:this.argumentTypes,argumentSizes:this.argumentSizes,returnType:this.returnType,leadingReturnStatement:this.leadingReturnStatement,followingReturnStatement:this.followingReturnStatement};return{ast:this.ast,settings:t}}getType(t){if(Array.isArray(t))return this.getType(t[t.length-1]);switch(t.type){case"BlockStatement":return this.getType(t.body);case"ArrayExpression":return`Array(${t.elements.length})`;case"Literal":const e=`${t.start},${t.end}`;return this.literalTypes[e]?this.literalTypes[e]:Number.isInteger(t.value)?"LiteralInteger":!0===t.value||!1===t.value?"Boolean":"Number";case"AssignmentExpression":return this.getType(t.left);case"CallExpression":if(this.isAstMathFunction(t))return"Number";if(!t.callee||!t.callee.name){if("SequenceExpression"===t.callee.type&&t.callee.expressions[t.callee.expressions.length-1].property.name){const e=t.callee.expressions[t.callee.expressions.length-1].property.name;return this.inferArgumentTypesIfNeeded(e,t.arguments),this.lookupReturnType(e,t,this)}throw this.astErrorOutput("Unknown call expression",t)}if(t.callee&&t.callee.name){const e=t.callee.name;return this.inferArgumentTypesIfNeeded(e,t.arguments),this.lookupReturnType(e,t,this)}throw this.astErrorOutput(`Unhandled getType Type "${t.type}"`,t);case"BinaryExpression":switch(t.operator){case"%":case"/":if(this.fixIntegerDivisionAccuracy)return"Number";break;case">":case"<":return"Boolean";case"&":case"|":case"^":case"<<":case">>":case">>>":return"Integer"}const r=this.getType(t.left);if(this.isState("skip-literal-correction"))return r;if("LiteralInteger"===r){const e=this.getType(t.right);return"LiteralInteger"===e?t.left.value%1==0?"Integer":"Float":e}return Jt[r]||r;case"UpdateExpression":return this.getType(t.argument);case"UnaryExpression":return"~"===t.operator?"Integer":this.getType(t.argument);case"VariableDeclaration":{const e=t.declarations;let r;for(let t=0;t<e.length;t++){const n=e[t];r=this.getType(n)}if(!r)throw this.astErrorOutput("Unable to find type for declaration",t);return r}case"VariableDeclarator":const n=this.getDeclaration(t.id);if(!n)throw this.astErrorOutput("Unable to find declarator",t);if(!n.valueType)throw this.astErrorOutput("Unable to find declarator valueType",t);return n.valueType;case"Identifier":if("Infinity"===t.name)return"Number";if(this.isAstVariable(t)){if("value"===this.getVariableSignature(t)){const e=this.getVariableType(t);if(!e)throw this.astErrorOutput("Unable to find identifier valueType",t);return e}}const i=this.findIdentifierOrigin(t);return i&&i.init?this.getType(i.init):null;case"ReturnStatement":return this.getType(t.argument);case"MemberExpression":if(this.isAstMathFunction(t)){switch(t.property.name){case"ceil":case"floor":case"round":return"Integer"}return"Number"}if(this.isAstVariable(t)){switch(this.getVariableSignature(t)){case"value[]":return this.getLookupType(this.getVariableType(t.object));case"value[][]":return this.getLookupType(this.getVariableType(t.object.object));case"value[][][]":return this.getLookupType(this.getVariableType(t.object.object.object));case"value[][][][]":return this.getLookupType(this.getVariableType(t.object.object.object.object));case"value.thread.value":case"this.thread.value":return"Integer";case"this.output.value":return this.dynamicOutput?"Integer":"LiteralInteger";case"this.constants.value":return this.getConstantType(t.property.name);case"this.constants.value[]":return this.getLookupType(this.getConstantType(t.object.property.name));case"this.constants.value[][]":return this.getLookupType(this.getConstantType(t.object.object.property.name));case"this.constants.value[][][]":return this.getLookupType(this.getConstantType(t.object.object.object.property.name));case"this.constants.value[][][][]":return this.getLookupType(this.getConstantType(t.object.object.object.object.property.name));case"fn()[]":case"fn()[][]":case"fn()[][][]":return this.getLookupType(this.getType(t.object));case"value.value":if(this.isAstMathVariable(t))return"Number";switch(t.property.name){case"r":case"g":case"b":case"a":return this.getLookupType(this.getVariableType(t.object))}case"[][]":return"Number"}throw this.astErrorOutput("Unhandled getType MemberExpression",t)}throw this.astErrorOutput("Unhandled getType MemberExpression",t);case"ConditionalExpression":return this.getType(t.consequent);case"FunctionDeclaration":case"FunctionExpression":const s=this.findLastReturn(t.body);return s?this.getType(s):null;case"IfStatement":return this.getType(t.consequent);default:throw this.astErrorOutput(`Unhandled getType Type "${t.type}"`,t)}}inferArgumentTypesIfNeeded(t,e){for(let r=0;r<e.length;r++){if(!this.needsArgumentType(t,r))continue;const n=this.getType(e[r]);if(!n)throw this.astErrorOutput(`Unable to infer argument ${r}`,e[r]);this.assignArgumentType(t,r,n)}}isAstMathVariable(t){return"MemberExpression"===t.type&&t.object&&"Identifier"===t.object.type&&"Math"===t.object.name&&t.property&&"Identifier"===t.property.type&&["E","PI","SQRT2","SQRT1_2","LN2","LN10","LOG2E","LOG10E"].indexOf(t.property.name)>-1}isAstMathFunction(t){return"CallExpression"===t.type&&t.callee&&"MemberExpression"===t.callee.type&&t.callee.object&&"Identifier"===t.callee.object.type&&"Math"===t.callee.object.name&&t.callee.property&&"Identifier"===t.callee.property.type&&["abs","acos","asin","atan","atan2","ceil","cos","exp","floor","log","log2","max","min","pow","random","round","sign","sin","sqrt","tan"].indexOf(t.callee.property.name)>-1}isAstVariable(t){return"Identifier"===t.type||"MemberExpression"===t.type}isSafe(t){return this.isSafeDependencies(this.getDependencies(t))}isSafeDependencies(t){return!t||!t.every||t.every(t=>t.isSafe)}getDependencies(t,e,r){if(e||(e=[]),!t)return null;if(Array.isArray(t)){for(let n=0;n<t.length;n++)this.getDependencies(t[n],e,r);return e}switch(t.type){case"AssignmentExpression":return this.getDependencies(t.left,e,r),this.getDependencies(t.right,e,r),e;case"ConditionalExpression":return this.getDependencies(t.test,e,r),this.getDependencies(t.alternate,e,r),this.getDependencies(t.consequent,e,r),e;case"Literal":e.push({origin:"literal",value:t.value,isSafe:!0!==r&&(t.value>-1/0&&t.value<1/0&&!isNaN(t.value))});break;case"VariableDeclarator":return this.getDependencies(t.init,e,r);case"Identifier":const n=this.getDeclaration(t);if(n)e.push({name:t.name,origin:"declaration",isSafe:!r&&this.isSafeDependencies(n.dependencies)});else if(this.argumentNames.indexOf(t.name)>-1)e.push({name:t.name,origin:"argument",isSafe:!1});else if(this.strictTypingChecking)throw new Error(`Cannot find identifier origin "${t.name}"`);break;case"FunctionDeclaration":return this.getDependencies(t.body.body[t.body.body.length-1],e,r);case"ReturnStatement":return this.getDependencies(t.argument,e);case"BinaryExpression":return r="/"===t.operator||"*"===t.operator,this.getDependencies(t.left,e,r),this.getDependencies(t.right,e,r),e;case"UnaryExpression":case"UpdateExpression":return this.getDependencies(t.argument,e,r);case"VariableDeclaration":return this.getDependencies(t.declarations,e,r);case"ArrayExpression":return e.push({origin:"declaration",isSafe:!0}),e;case"CallExpression":return e.push({origin:"function",isSafe:!0}),e;case"MemberExpression":const i=this.getMemberExpressionDetails(t);switch(i.signature){case"value[]":this.getDependencies(t.object,e,r);break;case"value[][]":this.getDependencies(t.object.object,e,r);break;case"value[][][]":this.getDependencies(t.object.object.object,e,r);break;case"this.output.value":this.dynamicOutput&&e.push({name:i.name,origin:"output",isSafe:!1})}if(i)return i.property&&this.getDependencies(i.property,e,r),i.xProperty&&this.getDependencies(i.xProperty,e,r),i.yProperty&&this.getDependencies(i.yProperty,e,r),i.zProperty&&this.getDependencies(i.zProperty,e,r),e;default:throw this.astErrorOutput(`Unhandled type ${t.type} in getDependencies`,t)}return e}getVariableSignature(t){if(!this.isAstVariable(t))throw new Error(`ast of type "${t.type}" is not a variable signature`);if("Identifier"===t.type)return"value";const e=[];for(;t;)t.computed?e.push("[]"):"ThisExpression"===t.type?e.unshift("this"):t.property&&t.property.name?"x"===t.property.name||"y"===t.property.name||"z"===t.property.name?e.unshift(".value"):"constants"===t.property.name||"thread"===t.property.name||"output"===t.property.name?e.unshift("."+t.property.name):e.unshift(".value"):t.name?e.unshift("value"):t.callee&&t.callee.name?e.unshift("fn()"):t.elements?e.unshift("[]"):e.unshift("unknown"),t=t.object;const r=e.join("");return["value","value[]","value[][]","value[][][]","value[][][][]","value.value","value.thread.value","this.thread.value","this.output.value","this.constants.value","this.constants.value[]","this.constants.value[][]","this.constants.value[][][]","this.constants.value[][][][]","fn()[]","fn()[][]","fn()[][][]","[][]"].indexOf(r)>-1?r:null}build(){return this.toString().length>0}astGeneric(t,e){if(null===t)throw this.astErrorOutput("NULL ast",t);if(Array.isArray(t)){for(let r=0;r<t.length;r++)this.astGeneric(t[r],e);return e}switch(t.type){case"FunctionDeclaration":return this.astFunctionDeclaration(t,e);case"FunctionExpression":return this.astFunctionExpression(t,e);case"ReturnStatement":return this.astReturnStatement(t,e);case"Literal":return this.astLiteral(t,e);case"BinaryExpression":return this.astBinaryExpression(t,e);case"Identifier":return this.astIdentifierExpression(t,e);case"AssignmentExpression":return this.astAssignmentExpression(t,e);case"ExpressionStatement":return this.astExpressionStatement(t,e);case"EmptyStatement":return this.astEmptyStatement(t,e);case"BlockStatement":return this.astBlockStatement(t,e);case"IfStatement":return this.astIfStatement(t,e);case"SwitchStatement":return this.astSwitchStatement(t,e);case"BreakStatement":return this.astBreakStatement(t,e);case"ContinueStatement":return this.astContinueStatement(t,e);case"ForStatement":return this.astForStatement(t,e);case"WhileStatement":return this.astWhileStatement(t,e);case"DoWhileStatement":return this.astDoWhileStatement(t,e);case"VariableDeclaration":return this.astVariableDeclaration(t,e);case"VariableDeclarator":return this.astVariableDeclarator(t,e);case"ThisExpression":return this.astThisExpression(t,e);case"SequenceExpression":return this.astSequenceExpression(t,e);case"UnaryExpression":return this.astUnaryExpression(t,e);case"UpdateExpression":return this.astUpdateExpression(t,e);case"LogicalExpression":return this.astLogicalExpression(t,e);case"MemberExpression":return this.astMemberExpression(t,e);case"CallExpression":return this.astCallExpression(t,e);case"ArrayExpression":return this.astArrayExpression(t,e);case"DebuggerStatement":return this.astDebuggerStatement(t,e);case"ConditionalExpression":return this.astConditionalExpression(t,e)}throw this.astErrorOutput("Unknown ast type : "+t.type,t)}astErrorOutput(t,e){if("string"!=typeof this.source)return new Error(t);const r=A(this.source,e),n=this.source.substr(e.start).split(/\n/),i=n.length>0?n[n.length-1]:0;return new Error(`${t} on line ${n.length}, position ${i.length}:\n ${r}`)}astDebuggerStatement(t,e){return e}astConditionalExpression(t,e){if("ConditionalExpression"!==t.type)throw this.astErrorOutput("Not a conditional expression",t);return e.push("("),this.astGeneric(t.test,e),e.push("?"),this.astGeneric(t.consequent,e),e.push(":"),this.astGeneric(t.alternate,e),e.push(")"),e}astFunction(t,e){throw new Error(`"astFunction" not defined on ${this.constructor.name}`)}astFunctionDeclaration(t,e){return this.isChildFunction(t)?e:this.astFunction(t,e)}astFunctionExpression(t,e){return this.isChildFunction(t)?e:this.astFunction(t,e)}isChildFunction(t){for(let e=0;e<this.functions.length;e++)if(this.functions[e]===t)return!0;return!1}astReturnStatement(t,e){return e}astLiteral(t,e){return this.literalTypes[`${t.start},${t.end}`]="Number",e}astBinaryExpression(t,e){return e}astIdentifierExpression(t,e){return e}astAssignmentExpression(t,e){return e}astExpressionStatement(t,e){return this.astGeneric(t.expression,e),e.push(";"),e}astEmptyStatement(t,e){return e}astBlockStatement(t,e){return e}astIfStatement(t,e){return e}astSwitchStatement(t,e){return e}astBreakStatement(t,e){return e.push("break;"),e}astContinueStatement(t,e){return e.push("continue;\n"),e}astForStatement(t,e){return e}astWhileStatement(t,e){return e}astDoWhileStatement(t,e){return e}astVariableDeclaration(t,e){const r=t.declarations;if(!r||!r[0]||!r[0].init)throw this.astErrorOutput("Unexpected expression",t);const n=r[0],i=n.init;let s=this.isState("in-for-loop-init")?"Integer":this.getType(i);"LiteralInteger"===s&&(s="Number");const a=typeMap[s];if(!a)throw this.astErrorOutput(`Markup type ${a} not handled`,t);this.getDependencies(n.init);throw new Error("remove me")}astVariableDeclarator(t,e){return this.astGeneric(t.id,e),null!==t.init&&(e.push("="),this.astGeneric(t.init,e)),e}astThisExpression(t,e){return e}astSequenceExpression(t,e){for(let r=0;r<t.expressions.length;r++)r>0&&e.push(","),this.astGeneric(t.expressions,e);return e}astUnaryExpression(t,e){return this.checkAndUpconvertBitwiseUnary(t,e)?e:(t.prefix?(e.push(t.operator),this.astGeneric(t.argument,e)):(this.astGeneric(t.argument,e),e.push(t.operator)),e)}checkAndUpconvertBitwiseUnary(t,e){}astUpdateExpression(t,e){return t.prefix?(e.push(t.operator),this.astGeneric(t.argument,e)):(this.astGeneric(t.argument,e),e.push(t.operator)),e}astLogicalExpression(t,e){return e.push("("),this.astGeneric(t.left,e),e.push(t.operator),this.astGeneric(t.right,e),e.push(")"),e}astMemberExpression(t,e){return e}astCallExpression(t,e){return e}astArrayExpression(t,e){return e}getMemberExpressionDetails(t){if("MemberExpression"!==t.type)throw this.astErrorOutput(`Expression ${t.type} not a MemberExpression`,t);let e=null,r=null;const n=this.getVariableSignature(t);switch(n){case"value":return null;case"value.thread.value":case"this.thread.value":case"this.output.value":return{signature:n,type:"Integer",name:t.property.name};case"value[]":if("string"!=typeof t.object.name)throw this.astErrorOutput("Unexpected expression",t);return{name:e=t.object.name,origin:"user",signature:n,type:this.getVariableType(t.object),xProperty:t.property};case"value[][]":if("string"!=typeof t.object.object.name)throw this.astErrorOutput("Unexpected expression",t);return{name:e=t.object.object.name,origin:"user",signature:n,type:this.getVariableType(t.object.object),yProperty:t.object.property,xProperty:t.property};case"value[][][]":if("string"!=typeof t.object.object.object.name)throw this.astErrorOutput("Unexpected expression",t);return{name:e=t.object.object.object.name,origin:"user",signature:n,type:this.getVariableType(t.object.object.object),zProperty:t.object.object.property,yProperty:t.object.property,xProperty:t.property};case"value[][][][]":if("string"!=typeof t.object.object.object.object.name)throw this.astErrorOutput("Unexpected expression",t);return{name:e=t.object.object.object.object.name,origin:"user",signature:n,type:this.getVariableType(t.object.object.object.object),zProperty:t.object.object.property,yProperty:t.object.property,xProperty:t.property};case"value.value":if("string"!=typeof t.property.name)throw this.astErrorOutput("Unexpected expression",t);if(this.isAstMathVariable(t))return{name:e=t.property.name,origin:"Math",type:"Number",signature:n};switch(t.property.name){case"r":case"g":case"b":case"a":return{name:e=t.object.name,property:t.property.name,origin:"user",signature:n,type:"Number"};default:throw this.astErrorOutput("Unexpected expression",t)}case"this.constants.value":if("string"!=typeof t.property.name)throw this.astErrorOutput("Unexpected expression",t);if(e=t.property.name,!(r=this.getConstantType(e)))throw this.astErrorOutput("Constant has no type",t);return{name:e,type:r,origin:"constants",signature:n};case"this.constants.value[]":if("string"!=typeof t.object.property.name)throw this.astErrorOutput("Unexpected expression",t);if(e=t.object.property.name,!(r=this.getConstantType(e)))throw this.astErrorOutput("Constant has no type",t);return{name:e,type:r,origin:"constants",signature:n,xProperty:t.property};case"this.constants.value[][]":if("string"!=typeof t.object.object.property.name)throw this.astErrorOutput("Unexpected expression",t);if(e=t.object.object.property.name,!(r=this.getConstantType(e)))throw this.astErrorOutput("Constant has no type",t);return{name:e,type:r,origin:"constants",signature:n,yProperty:t.object.property,xProperty:t.property};case"this.constants.value[][][]":if("string"!=typeof t.object.object.object.property.name)throw this.astErrorOutput("Unexpected expression",t);if(e=t.object.object.object.property.name,!(r=this.getConstantType(e)))throw this.astErrorOutput("Constant has no type",t);return{name:e,type:r,origin:"constants",signature:n,zProperty:t.object.object.property,yProperty:t.object.property,xProperty:t.property};case"fn()[]":case"[][]":return{signature:n,property:t.property};default:throw this.astErrorOutput("Unexpected expression",t)}}findIdentifierOrigin(t){const e=[this.ast];for(;e.length>0;){const r=e[0];if("VariableDeclarator"===r.type&&r.id&&r.id.name&&r.id.name===t.name)return r;if(e.shift(),r.argument)e.push(r.argument);else if(r.body)e.push(r.body);else if(r.declarations)e.push(r.declarations);else if(Array.isArray(r))for(let t=0;t<r.length;t++)e.push(r[t])}return null}findLastReturn(t){const e=[t||this.ast];for(;e.length>0;){const t=e.pop();if("ReturnStatement"===t.type)return t;if("FunctionDeclaration"!==t.type)if(t.argument)e.push(t.argument);else if(t.body)e.push(t.body);else if(t.declarations)e.push(t.declarations);else if(Array.isArray(t))for(let r=0;r<t.length;r++)e.push(t[r]);else t.consequent?e.push(t.consequent):t.cases&&e.push(t.cases)}return null}getInternalVariableName(t){return this._internalVariableNames.hasOwnProperty(t)||(this._internalVariableNames[t]=0),this._internalVariableNames[t]++,1===this._internalVariableNames[t]?t:t+this._internalVariableNames[t]}varWarn(){console.warn("var declarations are deprecated, weird things happen when falling back to CPU because var scope differs in javascript than in most languages.  Use const or let")}}const Jt={Number:"Number",Float:"Float",Integer:"Integer",Array:"Number","Array(2)":"Number","Array(3)":"Number","Array(4)":"Number",Array2D:"Number",Array3D:"Number",Input:"Number",HTMLImage:"Array(4)",HTMLVideo:"Array(4)",HTMLImageArray:"Array(4)",NumberTexture:"Number",MemoryOptimizedNumberTexture:"Number","Array1D(2)":"Array(2)","Array1D(3)":"Array(3)","Array1D(4)":"Array(4)","Array2D(2)":"Array(2)","Array2D(3)":"Array(3)","Array2D(4)":"Array(4)","Array3D(2)":"Array(2)","Array3D(3)":"Array(3)","Array3D(4)":"Array(4)","ArrayTexture(1)":"Number","ArrayTexture(2)":"Array(2)","ArrayTexture(3)":"Array(3)","ArrayTexture(4)":"Array(4)"};class Qt extends Zt{astFunction(t,e){if(!this.isRootKernel){e.push("function"),e.push(" "),e.push(this.name),e.push("(");for(let t=0;t<this.argumentNames.length;++t){const r=this.argumentNames[t];t>0&&e.push(", "),e.push("user_"),e.push(r)}e.push(") {\n")}for(let r=0;r<t.body.body.length;++r)this.astGeneric(t.body.body[r],e),e.push("\n");return this.isRootKernel||e.push("}\n"),e}astReturnStatement(t,e){const r=this.returnType||this.getType(t.argument);return this.returnType||(this.returnType=r),this.isRootKernel?(e.push(this.leadingReturnStatement),this.astGeneric(t.argument,e),e.push(";\n"),e.push(this.followingReturnStatement),e.push("continue;\n")):this.isSubKernel?(e.push(`subKernelResult_${this.name} = `),this.astGeneric(t.argument,e),e.push(";"),e.push(`return subKernelResult_${this.name};`)):(e.push("return "),this.astGeneric(t.argument,e),e.push(";")),e}astLiteral(t,e){if(isNaN(t.value))throw this.astErrorOutput("Non-numeric literal not supported : "+t.value,t);return e.push(t.value),e}astBinaryExpression(t,e){return e.push("("),this.astGeneric(t.left,e),e.push(t.operator),this.astGeneric(t.right,e),e.push(")"),e}astIdentifierExpression(t,e){if("Identifier"!==t.type)throw this.astErrorOutput("IdentifierExpression - not an Identifier",t);switch(t.name){case"Infinity":e.push("Infinity");break;default:this.constants&&this.constants.hasOwnProperty(t.name)?e.push("constants_"+t.name):e.push("user_"+t.name)}return e}astForStatement(t,e){if("ForStatement"!==t.type)throw this.astErrorOutput("Invalid for statement",t);const r=[],n=[],i=[],s=[];let a=null;if(t.init){this.pushState("in-for-loop-init"),this.astGeneric(t.init,r);for(let t=0;t<r.length;t++)r[t].includes&&r[t].includes(",")&&(a=!1);this.popState("in-for-loop-init")}else a=!1;if(t.test?this.astGeneric(t.test,n):a=!1,t.update?this.astGeneric(t.update,i):a=!1,t.body&&(this.pushState("loop-body"),this.astGeneric(t.body,s),this.popState("loop-body")),null===a&&(a=this.isSafe(t.init)&&this.isSafe(t.test)),a)e.push(`for (${r.join("")};${n.join("")};${i.join("")}){\n`),e.push(s.join("")),e.push("}\n");else{const t=this.getInternalVariableName("safeI");r.length>0&&e.push(r.join(""),";\n"),e.push(`for (let ${t}=0;${t}<LOOP_MAX;${t}++){\n`),n.length>0&&e.push(`if (!${n.join("")}) break;\n`),e.push(s.join("")),e.push(`\n${i.join("")};`),e.push("}\n")}return e}astWhileStatement(t,e){if("WhileStatement"!==t.type)throw this.astErrorOutput("Invalid while statement",t);return e.push("for (let i = 0; i < LOOP_MAX; i++) {"),e.push("if ("),this.astGeneric(t.test,e),e.push(") {\n"),this.astGeneric(t.body,e),e.push("} else {\n"),e.push("break;\n"),e.push("}\n"),e.push("}\n"),e}astDoWhileStatement(t,e){if("DoWhileStatement"!==t.type)throw this.astErrorOutput("Invalid while statement",t);return e.push("for (let i = 0; i < LOOP_MAX; i++) {"),this.astGeneric(t.body,e),e.push("if (!"),this.astGeneric(t.test,e),e.push(") {\n"),e.push("break;\n"),e.push("}\n"),e.push("}\n"),e}astAssignmentExpression(t,e){const r=this.getDeclaration(t.left);if(r&&!r.assignable)throw new this.astErrorOutput(`Variable ${t.left.name} is not assignable here`,t);return this.astGeneric(t.left,e),e.push(t.operator),this.astGeneric(t.right,e),e}astBlockStatement(t,e){if(this.isState("loop-body")){this.pushState("block-body");for(let r=0;r<t.body.length;r++)this.astGeneric(t.body[r],e);this.popState("block-body")}else{e.push("{\n");for(let r=0;r<t.body.length;r++)this.astGeneric(t.body[r],e);e.push("}\n")}return e}astVariableDeclaration(t,e){"var"===t.kind&&this.warnVarUsage&&this.varWarn(),e.push(`${t.kind} `);const{declarations:r}=t;for(let t=0;t<r.length;t++)t>0&&e.push(","),this.astGeneric(r[t],e);return this.isState("in-for-loop-init")||e.push(";"),e}astIfStatement(t,e){return e.push("if ("),this.astGeneric(t.test,e),e.push(")"),"BlockStatement"===t.consequent.type?this.astGeneric(t.consequent,e):(e.push(" {\n"),this.astGeneric(t.consequent,e),e.push("\n}\n")),t.alternate&&(e.push("else "),"BlockStatement"===t.alternate.type?this.astGeneric(t.alternate,e):(e.push(" {\n"),this.astGeneric(t.alternate,e),e.push("\n}\n"))),e}astSwitchStatement(t,e){const{discriminant:r,cases:n}=t;e.push("switch ("),this.astGeneric(r,e),e.push(") {\n");for(let t=0;t<n.length;t++)null!==n[t].test?(e.push("case "),this.astGeneric(n[t].test,e),e.push(":\n"),n[t].consequent&&n[t].consequent.length>0&&(this.astGeneric(n[t].consequent,e),e.push("break;\n"))):(e.push("default:\n"),this.astGeneric(n[t].consequent,e),n[t].consequent&&n[t].consequent.length>0&&e.push("break;\n"));e.push("\n}")}astThisExpression(t,e){return e.push("_this"),e}astMemberExpression(t,e){const{signature:r,type:n,property:i,xProperty:s,yProperty:a,zProperty:o,name:u,origin:h}=this.getMemberExpressionDetails(t);switch(r){case"this.thread.value":return e.push(`_this.thread.${u}`),e;case"this.output.value":switch(u){case"x":e.push("outputX");break;case"y":e.push("outputY");break;case"z":e.push("outputZ");break;default:throw this.astErrorOutput("Unexpected expression",t)}return e;case"value":throw this.astErrorOutput("Unexpected expression",t);case"value[]":case"value[][]":case"value[][][]":case"value.value":if("Math"===h)return e.push(Math[u]),e;switch(i){case"r":return e.push(`user_${u}[0]`),e;case"g":return e.push(`user_${u}[1]`),e;case"b":return e.push(`user_${u}[2]`),e;case"a":return e.push(`user_${u}[3]`),e}break;case"this.constants.value":case"this.constants.value[]":case"this.constants.value[][]":case"this.constants.value[][][]":break;case"fn()[]":return this.astGeneric(t.object,e),e.push("["),this.astGeneric(t.property,e),e.push("]"),e;default:throw this.astErrorOutput("Unexpected expression",t)}if(!t.computed)switch(n){case"Number":case"Integer":case"Float":case"Boolean":return e.push(`${h}_${u}`),e}const l=`${h}_${u}`;switch(n){case"Array(2)":case"Array(3)":case"Array(4)":case"HTMLImageArray":case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":case"HTMLImage":default:let t,r;if("constants"===h){const e=this.constants[u];t=(r="Input"===this.constantTypes[u])?e.size:null}else t=(r=this.isInput(u))?this.argumentSizes[this.argumentNames.indexOf(u)]:null;e.push(`${l}`),o&&a?r?(e.push("[("),this.astGeneric(o,e),e.push(`*${this.dynamicArguments?"(outputY * outputX)":t[1]*t[0]})+(`),this.astGeneric(a,e),e.push(`*${this.dynamicArguments?"outputX":t[0]})+`),this.astGeneric(s,e),e.push("]")):(e.push("["),this.astGeneric(o,e),e.push("]"),e.push("["),this.astGeneric(a,e),e.push("]"),e.push("["),this.astGeneric(s,e),e.push("]")):a?r?(e.push("[("),this.astGeneric(a,e),e.push(`*${this.dynamicArguments?"outputX":t[0]})+`),this.astGeneric(s,e),e.push("]")):(e.push("["),this.astGeneric(a,e),e.push("]"),e.push("["),this.astGeneric(s,e),e.push("]")):void 0!==s&&(e.push("["),this.astGeneric(s,e),e.push("]"))}return e}astCallExpression(t,e){if("CallExpression"!==t.type)throw this.astErrorOutput("Unknown CallExpression",t);let r=this.astMemberExpressionUnroll(t.callee);this.calledFunctions.indexOf(r)<0&&this.calledFunctions.push(r);this.isAstMathFunction(t);this.onFunctionCall&&this.onFunctionCall(this.name,r,t.arguments),e.push(r),e.push("(");const n=this.lookupFunctionArgumentTypes(r)||[];for(let i=0;i<t.arguments.length;++i){const s=t.arguments[i];let a=this.getType(s);n[i]||this.triggerImplyArgumentType(r,i,a,this),i>0&&e.push(", "),this.astGeneric(s,e)}return e.push(")"),e}astArrayExpression(t,e){const r=t.elements.length;e.push("new Float32Array([");for(let n=0;n<r;++n){n>0&&e.push(", ");const r=t.elements[n];this.astGeneric(r,e)}return e.push("])"),e}astDebuggerStatement(t,e){return e.push("debugger;"),e}}function te(t,e){const r=[],n=[],i=[],s=!/^function/.test(t.color.toString());if(r.push("  const { context, canvas, constants: incomingConstants } = settings;",`  const output = new Int32Array(${JSON.stringify(Array.from(t.output))});`,`  const _constantTypes = ${JSON.stringify(t.constantTypes)};`,`  const _constants = ${function(t,e){const r=[];for(const n in e){if(!e.hasOwnProperty(n))continue;const i=e[n],s=t[n];switch(i){case"Number":case"Integer":case"Float":case"Boolean":r.push(`${n}:${s}`);break;case"Array(2)":case"Array(3)":case"Array(4)":r.push(`${n}:new ${s.constructor.name}(${JSON.stringify(Array.from(s))})`)}}return`{ ${r.join()} }`}(t.constants,t.constantTypes)};`),n.push("    constants: _constants,","    context,","    output,","    thread: {x: 0, y: 0, z: 0},"),t.graphical){r.push(`  const _imageData = context.createImageData(${t.output[0]}, ${t.output[1]});`),r.push(`  const _colorData = new Uint8ClampedArray(${t.output[0]} * ${t.output[1]} * 4);`);const e=Ht.flattenFunctionToString((s?"function ":"")+t.color.toString(),{thisLookup:e=>{switch(e){case"_colorData":return"_colorData";case"_imageData":return"_imageData";case"output":return"output";case"thread":return"this.thread"}return JSON.stringify(t[e])},findDependency:(t,e)=>null}),a=Ht.flattenFunctionToString((s?"function ":"")+t.getPixels.toString(),{thisLookup:e=>{switch(e){case"_colorData":return"_colorData";case"_imageData":return"_imageData";case"output":return"output";case"thread":return"this.thread"}return JSON.stringify(t[e])},findDependency:()=>null});n.push("    _imageData,","    _colorData,",`    color: ${e},`),i.push(`  kernel.getPixels = ${a};`)}const a=[],o=Object.keys(t.constantTypes);for(let e=0;e<o.length;e++)a.push(t.constantTypes[o]);if(-1!==t.argumentTypes.indexOf("HTMLImageArray")||-1!==a.indexOf("HTMLImageArray")){const e=Ht.flattenFunctionToString((s?"function ":"")+t._imageTo3DArray.toString(),{doNotDefine:["canvas"],findDependency:(e,r)=>"this"===e?(s?"function ":"")+t[r].toString():null,thisLookup:t=>{switch(t){case"canvas":return;case"context":return"context"}}});i.push(e),n.push("    _mediaTo2DArray,"),n.push("    _imageTo3DArray,")}else if(-1!==t.argumentTypes.indexOf("HTMLImage")||-1!==a.indexOf("HTMLImage")){const e=Ht.flattenFunctionToString((s?"function ":"")+t._mediaTo2DArray.toString(),{findDependency:(t,e)=>null,thisLookup:t=>{switch(t){case"canvas":return"settings.canvas";case"context":return"settings.context"}throw new Error("unhandled thisLookup")}});i.push(e),n.push("    _mediaTo2DArray,")}return`function(settings) {\n${r.join("\n")}\n  for (const p in _constantTypes) {\n    if (!_constantTypes.hasOwnProperty(p)) continue;\n    const type = _constantTypes[p];\n    switch (type) {\n      case 'Number':\n      case 'Integer':\n      case 'Float':\n      case 'Boolean':\n      case 'Array(2)':\n      case 'Array(3)':\n      case 'Array(4)':\n        if (incomingConstants.hasOwnProperty(p)) {\n          console.warn('constant ' + p + ' of type ' + type + ' cannot be resigned');\n        }\n        continue;\n    }\n    if (!incomingConstants.hasOwnProperty(p)) {\n      throw new Error('constant ' + p + ' not found');\n    }\n    _constants[p] = incomingConstants[p];\n  }\n  const kernel = (function() {\n${t._kernelString}\n  })\n    .apply({ ${n.join("\n")} });\n  ${i.join("\n")}\n  return kernel;\n}`}class ee extends Wt{static getFeatures(){return this.features}static get features(){return Object.freeze({kernelMap:!0,isIntegerDivisionAccurate:!0})}static get isSupported(){return!0}static isContextMatch(t){return!1}static get mode(){return"cpu"}static nativeFunctionArguments(){return null}static nativeFunctionReturnType(){return null}static combineKernels(t){return t}constructor(t,e){super(t,e),this.mergeSettings(t.settings||e),this._imageData=null,this._colorData=null,this._kernelString=null,this.thread={x:0,y:0,z:0},this.translatedSources=null}initCanvas(){return"undefined"!=typeof document?document.createElement("canvas"):"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(0,0):void 0}initContext(){return this.canvas?this.canvas.getContext("2d"):null}initPlugins(t){return[]}validateSettings(t){if(!this.output||0===this.output.length){if(1!==t.length)throw new Error("Auto output only supported for kernels with only one input");const e=Ht.getVariableType(t[0],this.strictIntegers);if("Array"===e)this.output=Ht.getDimensions(e);else{if("NumberTexture"!==e&&"ArrayTexture(4)"!==e)throw new Error("Auto output not supported for input type: "+e);this.output=t[0].output}}if(this.graphical&&2!==this.output.length)throw new Error("Output must have 2 dimensions on graphical mode");this.checkOutput()}translateSource(){if(this.leadingReturnStatement=this.output.length>1?"resultX[x] = ":"result[x] = ",this.subKernels){const t=[];for(let e=0;e<this.subKernels.length;e++){const{name:r}=this.subKernels[e];t.push(this.output.length>1?`resultX_${r}[x] = subKernelResult_${r};\n`:`result_${r}[x] = subKernelResult_${r};\n`)}this.followingReturnStatement=t.join("")}const t=qt.fromKernel(this,Qt);this.translatedSources=t.getPrototypes("kernel"),this.graphical||this.returnType||(this.returnType=t.getKernelResultType())}build(){if(this.setupConstants(),this.setupArguments(arguments),this.validateSettings(arguments),this.translateSource(),this.graphical){const{canvas:t,output:e}=this;if(!t)throw new Error("no canvas available for using graphical output");const r=e[0],n=e[1]||1;t.width=r,t.height=n,this._imageData=this.context.createImageData(r,n),this._colorData=new Uint8ClampedArray(r*n*4)}const t=this.getKernelString();this.kernelString=t,this.debug&&(console.log("Function output:"),console.log(t));try{this.run=new Function([],t).bind(this)()}catch(t){console.error("An error occurred compiling the javascript: ",t)}}color(t,e,r,n){void 0===n&&(n=1),t=Math.floor(255*t),e=Math.floor(255*e),r=Math.floor(255*r),n=Math.floor(255*n);const i=this.output[0],s=this.output[1],a=this.thread.x+(s-this.thread.y-1)*i;this._colorData[4*a+0]=t,this._colorData[4*a+1]=e,this._colorData[4*a+2]=r,this._colorData[4*a+3]=n}getKernelString(){if(null!==this._kernelString)return this._kernelString;let t=null,{translatedSources:e}=this;return e.length>1?e=e.filter(e=>/^function/.test(e)?e:(t=e,!1)):t=e.shift(),this._kernelString=`  const LOOP_MAX = ${this._getLoopMaxString()};\n  ${this.injectedNative||""}\n  const _this = this;\n  ${this._processConstants()}\n  return (${this.argumentNames.map(t=>"user_"+t).join(", ")}) => {\n    ${this._processArguments()}\n    ${this.graphical?this._graphicalKernelBody(t):this._resultKernelBody(t)}\n    ${e.length>0?e.join("\n"):""}\n  };`}toString(){return te(this)}_getLoopMaxString(){return this.loopMaxIterations?` ${parseInt(this.loopMaxIterations)};`:" 1000;"}_processConstants(){if(!this.constants)return"";const t=[];for(let e in this.constants){switch(this.constantTypes[e]){case"HTMLImage":case"HTMLVideo":t.push(`    const constants_${e} = this._mediaTo2DArray(this.constants.${e});\n`);break;case"HTMLImageArray":t.push(`    const constants_${e} = this._imageTo3DArray(this.constants.${e});\n`);break;case"Input":t.push(`    const constants_${e} = this.constants.${e}.value;\n`);break;default:t.push(`    const constants_${e} = this.constants.${e};\n`)}}return t.join("")}_processArguments(){const t=[];for(let e=0;e<this.argumentTypes.length;e++){const r=`user_${this.argumentNames[e]}`;switch(this.argumentTypes[e]){case"HTMLImage":case"HTMLVideo":t.push(`    ${r} = this._mediaTo2DArray(${r});\n`);break;case"HTMLImageArray":t.push(`    ${r} = this._imageTo3DArray(${r});\n`);break;case"Input":t.push(`    ${r} = ${r}.value;\n`);break;case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":case"NumberTexture":case"MemoryOptimizedNumberTexture":t.push(`\n    if (${r}.toArray) {\n      if (!_this.textureCache) {\n        _this.textureCache = [];\n        _this.arrayCache = [];\n      }\n      const textureIndex = _this.textureCache.indexOf(${r});\n      if (textureIndex !== -1) {\n        ${r} = _this.arrayCache[textureIndex];\n      } else {\n        _this.textureCache.push(${r});\n        ${r} = ${r}.toArray();\n        _this.arrayCache.push(${r});\n      }\n    }`)}}return t.join("")}_mediaTo2DArray(t){const e=this.canvas,r=t.width>0?t.width:t.videoWidth,n=t.height>0?t.height:t.videoHeight;e.width<r&&(e.width=r),e.height<n&&(e.height=n);const i=this.context;i.drawImage(t,0,0,r,n);const s=i.getImageData(0,0,r,n).data,a=new Array(n);let o=0;for(let t=n-1;t>=0;t--){const e=a[t]=new Array(r);for(let t=0;t<r;t++){const r=new Float32Array(4);r[0]=s[o++]/255,r[1]=s[o++]/255,r[2]=s[o++]/255,r[3]=s[o++]/255,e[t]=r}}return a}getPixels(t){const[e,r]=this.output;return t?Ht.flipPixels(this._imageData.data,e,r):this._imageData.data.slice(0)}_imageTo3DArray(t){const e=new Array(t.length);for(let r=0;r<t.length;r++)e[r]=this._mediaTo2DArray(t[r]);return e}_resultKernelBody(t){switch(this.output.length){case 1:return this._resultKernel1DLoop(t)+this._kernelOutput();case 2:return this._resultKernel2DLoop(t)+this._kernelOutput();case 3:return this._resultKernel3DLoop(t)+this._kernelOutput();default:throw new Error("unsupported size kernel")}}_graphicalKernelBody(t){switch(this.output.length){case 2:return this._graphicalKernel2DLoop(t)+this._graphicalOutput();default:throw new Error("unsupported size kernel")}}_graphicalOutput(){return"\n    this._imageData.data.set(this._colorData);\n    this.context.putImageData(this._imageData, 0, 0);\n    return;"}_getKernelResultTypeConstructorString(){switch(this.returnType){case"LiteralInteger":case"Number":case"Integer":case"Float":return"Float32Array";case"Array(2)":case"Array(3)":case"Array(4)":return"Array";default:if(this.graphical)return"Float32Array";throw new Error(`unhandled returnType ${this.returnType}`)}}_resultKernel1DLoop(t){const e=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];\n    const result = new ${e}(outputX);\n    ${this._mapSubKernels(t=>`const result_${t.name} = new ${e}(outputX);\n`).join("    ")}\n    ${this._mapSubKernels(t=>`let subKernelResult_${t.name};\n`).join("    ")}\n    for (let x = 0; x < outputX; x++) {\n      this.thread.x = x;\n      this.thread.y = 0;\n      this.thread.z = 0;\n      ${t}\n    }`}_resultKernel2DLoop(t){const e=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];\n    const outputY = _this.output[1];\n    const result = new Array(outputY);\n    ${this._mapSubKernels(t=>`const result_${t.name} = new Array(outputY);\n`).join("    ")}\n    ${this._mapSubKernels(t=>`let subKernelResult_${t.name};\n`).join("    ")}\n    for (let y = 0; y < outputY; y++) {\n      this.thread.z = 0;\n      this.thread.y = y;\n      const resultX = result[y] = new ${e}(outputX);\n      ${this._mapSubKernels(t=>`const resultX_${t.name} = result_${t.name}[y] = new ${e}(outputX);\n`).join("")}\n      for (let x = 0; x < outputX; x++) {\n        this.thread.x = x;\n        ${t}\n      }\n    }`}_graphicalKernel2DLoop(t){const e=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];\n    const outputY = _this.output[1];\n    ${this._mapSubKernels(t=>`const result_${t.name} = new Array(outputY);\n`).join("    ")}\n    ${this._mapSubKernels(t=>`let subKernelResult_${t.name};\n`).join("    ")}\n    for (let y = 0; y < outputY; y++) {\n      this.thread.z = 0;\n      this.thread.y = y;\n      ${this._mapSubKernels(t=>`const resultX_${t.name} = result_${t.name}[y] = new ${e}(outputX);\n`).join("")}\n      for (let x = 0; x < outputX; x++) {\n        this.thread.x = x;\n        ${t}\n      }\n    }`}_resultKernel3DLoop(t){const e=this._getKernelResultTypeConstructorString();return`  const outputX = _this.output[0];\n    const outputY = _this.output[1];\n    const outputZ = _this.output[2];\n    const result = new Array(outputZ);\n    ${this._mapSubKernels(t=>`const result_${t.name} = new Array(outputZ);\n`).join("    ")}\n    ${this._mapSubKernels(t=>`let subKernelResult_${t.name};\n`).join("    ")}\n    for (let z = 0; z < outputZ; z++) {\n      this.thread.z = z;\n      const resultY = result[z] = new Array(outputY);\n      ${this._mapSubKernels(t=>`const resultY_${t.name} = result_${t.name}[z] = new Array(outputY);\n`).join("      ")}\n      for (let y = 0; y < outputY; y++) {\n        this.thread.y = y;\n        const resultX = resultY[y] = new ${e}(outputX);\n        ${this._mapSubKernels(t=>`const resultX_${t.name} = resultY_${t.name}[y] = new ${e}(outputX);\n`).join("        ")}\n        for (let x = 0; x < outputX; x++) {\n          this.thread.x = x;\n          ${t}\n        }\n      }\n    }`}_kernelOutput(){return this.subKernels?`\n    return {\n      result: result,\n      ${this.subKernels.map(t=>`${t.property}: result_${t.name}`).join(",\n      ")}\n    };`:"\n    return result;"}_mapSubKernels(t){return null===this.subKernels?[""]:this.subKernels.map(t)}destroy(t){t&&delete this.canvas}static destroyContext(t){}toJSON(){const t=super.toJSON();return t.functionNodes=qt.fromKernel(this,Qt).toJSON(),t}setOutput(t){super.setOutput(t);const[e,r]=this.output;this.graphical&&(this._imageData=this.context.createImageData(e,r),this._colorData=new Uint8ClampedArray(e*r*4))}}class re extends Bt{constructor(t){super(t),this.type="ArrayTexture(1)"}renderRawOutput(){const{context:t}=this,e=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,e),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0);const r=new Float32Array(this.size[0]*this.size[1]*4);return t.readPixels(0,0,this.size[0],this.size[1],t.RGBA,t.FLOAT,r),r}renderValues(){return this.renderRawOutput()}toArray(){return Ht.erectFloat(this.renderValues(),this.output[0])}}class ne extends re{constructor(t){super(t),this.type="ArrayTexture(2)"}toArray(){return Ht.erectArray2(this.renderValues(),this.output[0],this.output[1])}}class ie extends re{constructor(t){super(t),this.type="ArrayTexture(2)"}toArray(){return Ht.erect2DArray2(this.renderValues(),this.output[0],this.output[1])}}class se extends re{constructor(t){super(t),this.type="ArrayTexture(2)"}toArray(){return Ht.erect3DArray2(this.renderValues(),this.output[0],this.output[1],this.output[2])}}class ae extends re{constructor(t){super(t),this.type="ArrayTexture(3)"}toArray(){return Ht.erectArray3(this.renderValues(),this.output[0])}}class oe extends re{constructor(t){super(t),this.type="ArrayTexture(3)"}toArray(){return Ht.erect2DArray3(this.renderValues(),this.output[0],this.output[1])}}class ue extends re{constructor(t){super(t),this.type="ArrayTexture(3)"}toArray(){return Ht.erect3DArray3(this.renderValues(),this.output[0],this.output[1],this.output[2])}}class he extends re{constructor(t){super(t),this.type="ArrayTexture(4)"}toArray(){return Ht.erectArray4(this.renderValues(),this.output[0])}}class le extends re{constructor(t){super(t),this.type="ArrayTexture(4)"}toArray(){return Ht.erect2DArray4(this.renderValues(),this.output[0],this.output[1])}}class ce extends re{constructor(t){super(t),this.type="ArrayTexture(4)"}toArray(){return Ht.erect3DArray4(this.renderValues(),this.output[0],this.output[1],this.output[2])}}class pe extends re{constructor(t){super(t),this.type="ArrayTexture(1)"}toArray(){return Ht.erect2DFloat(this.renderValues(),this.output[0],this.output[1])}}class de extends re{constructor(t){super(t),this.type="ArrayTexture(1)"}toArray(){return Ht.erect3DFloat(this.renderValues(),this.output[0],this.output[1],this.output[2])}}class me extends re{constructor(t){super(t),this.type="MemoryOptimizedNumberTexture"}toArray(){return Ht.erectMemoryOptimizedFloat(this.renderValues(),this.output[0])}}class fe extends re{constructor(t){super(t),this.type="MemoryOptimizedNumberTexture"}toArray(){return Ht.erectMemoryOptimized2DFloat(this.renderValues(),this.output[0],this.output[1])}}class ge extends re{constructor(t){super(t),this.type="MemoryOptimizedNumberTexture"}toArray(){return Ht.erectMemoryOptimized3DFloat(this.renderValues(),this.output[0],this.output[1],this.output[2])}}class xe extends Bt{constructor(t){super(t),this.type="NumberTexture"}renderRawOutput(){const{context:t}=this,e=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,e),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,this.texture,0);const r=new Uint8Array(this.size[0]*this.size[1]*4);return t.readPixels(0,0,this.size[0],this.size[1],t.RGBA,t.UNSIGNED_BYTE,r),r}renderValues(){return new Float32Array(this.renderRawOutput().buffer)}toArray(){return Ht.erectPackedFloat(this.renderValues(),this.output[0])}}class ye extends xe{constructor(t){super(t),this.type="NumberTexture"}toArray(){return Ht.erect2DPackedFloat(this.renderValues(),this.output[0],this.output[1])}}class Te extends xe{constructor(t){super(t),this.type="NumberTexture"}toArray(){return Ht.erect3DPackedFloat(this.renderValues(),this.output[0],this.output[1],this.output[2])}}class be extends xe{constructor(t){super(t),this.type="ArrayTexture(4)"}toArray(){return this.renderValues()}}class Ae extends Wt{static get mode(){return"gpu"}static getIsFloatRead(){const t=new this("function kernelFunction() {\n      return 1;\n    }",{context:this.testContext,canvas:this.testCanvas,validate:!1,output:[1],precision:"single",returnType:"Number",tactic:"speed"});t.build(),t.run();const e=t.renderOutput();return t.destroy(!0),1===e[0]}static getIsIntegerDivisionAccurate(){const t=new this(function(t,e){return t[this.thread.x]/e[this.thread.x]}.toString(),{context:this.testContext,canvas:this.testCanvas,validate:!1,output:[2],returnType:"Number",precision:"unsigned",tactic:"speed"}),e=[[6,6030401],[3,3991]];t.build.apply(t,e),t.run.apply(t,e);const r=t.renderOutput();return t.destroy(!0),2===r[0]&&1511===r[1]}static get testCanvas(){throw new Error(`"testCanvas" not defined on ${this.name}`)}static get testContext(){throw new Error(`"testContext" not defined on ${this.name}`)}static get features(){throw new Error(`"features" not defined on ${this.name}`)}static setupFeatureChecks(){throw new Error(`"setupFeatureChecks" not defined on ${this.name}`)}setFixIntegerDivisionAccuracy(t){return this.fixIntegerDivisionAccuracy=t,this}setPrecision(t){return this.precision=t,this}setFloatTextures(t){return Ht.warnDeprecated("method","setFloatTextures","setOptimizeFloatMemory"),this.floatTextures=t,this}static nativeFunctionArguments(t){const e=[],r=[],n=[],i=/^[a-zA-Z_]/,s=/[a-zA-Z_0-9]/;let a=0,o=null,u=null;for(;a<t.length;){const h=t[a],l=t[a+1],c=n.length>0?n[n.length-1]:null;if("FUNCTION_ARGUMENTS"!==c||"/"!==h||"*"!==l)if("MULTI_LINE_COMMENT"!==c||"*"!==h||"/"!==l)if("FUNCTION_ARGUMENTS"!==c||"/"!==h||"/"!==l)if("COMMENT"!==c||"\n"!==h)if(null!==c||"("!==h){if("FUNCTION_ARGUMENTS"===c){if(")"===h){n.pop();break}if("f"===h&&"l"===l&&"o"===t[a+2]&&"a"===t[a+3]&&"t"===t[a+4]&&" "===t[a+5]){n.push("DECLARE_VARIABLE"),u="float",o="",a+=6;continue}if("i"===h&&"n"===l&&"t"===t[a+2]&&" "===t[a+3]){n.push("DECLARE_VARIABLE"),u="int",o="",a+=4;continue}if("v"===h&&"e"===l&&"c"===t[a+2]&&"2"===t[a+3]&&" "===t[a+4]){n.push("DECLARE_VARIABLE"),u="vec2",o="",a+=5;continue}if("v"===h&&"e"===l&&"c"===t[a+2]&&"3"===t[a+3]&&" "===t[a+4]){n.push("DECLARE_VARIABLE"),u="vec3",o="",a+=5;continue}if("v"===h&&"e"===l&&"c"===t[a+2]&&"4"===t[a+3]&&" "===t[a+4]){n.push("DECLARE_VARIABLE"),u="vec4",o="",a+=5;continue}}else if("DECLARE_VARIABLE"===c){if(""===o){if(" "===h){a++;continue}if(!i.test(h))throw new Error("variable name is not expected string")}o+=h,s.test(l)||(n.pop(),r.push(o),e.push(Ee[u]))}a++}else n.push("FUNCTION_ARGUMENTS"),a++;else n.pop(),a++;else n.push("COMMENT"),a+=2;else n.pop(),a+=2;else n.push("MULTI_LINE_COMMENT"),a+=2}if(n.length>0)throw new Error("GLSL function was not parsable");return{argumentNames:r,argumentTypes:e}}static nativeFunctionReturnType(t){return Ee[t.match(/int|float|vec[2-4]/)[0]]}static combineKernels(t,e){t.apply(null,arguments);const{texSize:r,context:n,threadDim:i}=e.texSize;let s;if("single"===e.precision){const t=r[0],e=Math.ceil(r[1]/4);s=new Float32Array(t*e*4*4),n.readPixels(0,0,t,4*e,n.RGBA,n.FLOAT,s)}else{const t=new Uint8Array(r[0]*r[1]*4);n.readPixels(0,0,r[0],r[1],n.RGBA,n.UNSIGNED_BYTE,t),s=new Float32Array(t.buffer)}if(s=s.subarray(0,i[0]*i[1]*i[2]),1===e.output.length)return s;if(2===e.output.length)return Ht.splitArray(s,e.output[0]);if(3===e.output.length){return Ht.splitArray(s,e.output[0]*e.output[1]).map((function(t){return Ht.splitArray(t,e.output[0])}))}}constructor(t,e){super(t,e),this.transferValues=null,this.formatValues=null,this.TextureConstructor=null,this.renderOutput=null,this.renderRawOutput=null,this.texSize=null,this.translatedSource=null,this.renderStrategy=null,this.compiledFragmentShader=null,this.compiledVertexShader=null}checkTextureSize(){const{features:t}=this.constructor;if(this.texSize[0]>t.maxTextureSize||this.texSize[1]>t.maxTextureSize)throw new Error(`Texture size [${this.texSize[0]},${this.texSize[1]}] generated by kernel is larger than supported size [${t.maxTextureSize},${t.maxTextureSize}]`)}translateSource(){throw new Error(`"translateSource" not defined on ${this.constructor.name}`)}pickRenderStrategy(t){if(this.graphical)return this.renderRawOutput=this.readPackedPixelsToUint8Array,this.transferValues=t=>t,this.TextureConstructor=be,null;if("unsigned"===this.precision)if(this.renderRawOutput=this.readPackedPixelsToUint8Array,this.transferValues=this.readPackedPixelsToFloat32Array,this.pipeline)switch(this.renderOutput=this.renderTexture,null!==this.subKernels&&(this.renderKernels=this.renderKernelsToTextures),this.returnType){case"LiteralInteger":case"Float":case"Number":case"Integer":return this.output[2]>0?(this.TextureConstructor=Te,this.renderStrategy=Se.PackedPixelTo3DFloat,null):this.output[1]>0?(this.TextureConstructor=ye,this.renderStrategy=Se.PackedPixelTo2DFloat,null):(this.TextureConstructor=xe,this.renderStrategy=Se.PackedPixelToFloat,null);case"Array(2)":case"Array(3)":case"Array(4)":return this.requestFallback(t)}else switch(null!==this.subKernels&&(this.renderKernels=this.renderKernelsToArrays),this.returnType){case"LiteralInteger":case"Float":case"Number":case"Integer":return this.renderOutput=this.renderValues,this.output[2]>0?(this.TextureConstructor=Te,this.renderStrategy=Se.PackedPixelTo3DFloat,this.formatValues=Ht.erect3DPackedFloat,null):this.output[1]>0?(this.TextureConstructor=ye,this.renderStrategy=Se.PackedPixelTo2DFloat,this.formatValues=Ht.erect2DPackedFloat,null):(this.TextureConstructor=xe,this.renderStrategy=Se.PackedPixelToFloat,this.formatValues=Ht.erectPackedFloat,null);case"Array(2)":case"Array(3)":case"Array(4)":return this.requestFallback(t)}else{if("single"!==this.precision)throw new Error(`unhandled precision of "${this.precision}"`);if(this.renderRawOutput=this.readFloatPixelsToFloat32Array,this.transferValues=this.readFloatPixelsToFloat32Array,this.pipeline)switch(this.renderStrategy=Se.FloatTexture,this.renderOutput=this.renderTexture,null!==this.subKernels&&(this.renderKernels=this.renderKernelsToTextures),this.returnType){case"LiteralInteger":case"Float":case"Number":case"Integer":return this.optimizeFloatMemory?this.output[2]>0?(this.TextureConstructor=ge,null):this.output[1]>0?(this.TextureConstructor=fe,null):(this.TextureConstructor=me,null):this.output[2]>0?(this.TextureConstructor=de,null):this.output[1]>0?(this.TextureConstructor=pe,null):(this.TextureConstructor=re,null);case"Array(2)":return this.output[2]>0?(this.TextureConstructor=se,null):this.output[1]>0?(this.TextureConstructor=ie,null):(this.TextureConstructor=ne,null);case"Array(3)":return this.output[2]>0?(this.TextureConstructor=ue,null):this.output[1]>0?(this.TextureConstructor=oe,null):(this.TextureConstructor=ae,null);case"Array(4)":return this.output[2]>0?(this.TextureConstructor=ce,null):this.output[1]>0?(this.TextureConstructor=le,null):(this.TextureConstructor=he,null)}if(this.renderOutput=this.renderValues,null!==this.subKernels&&(this.renderKernels=this.renderKernelsToArrays),this.optimizeFloatMemory)switch(this.returnType){case"LiteralInteger":case"Float":case"Number":case"Integer":return this.output[2]>0?(this.TextureConstructor=ge,this.renderStrategy=Se.MemoryOptimizedFloatPixelToMemoryOptimized3DFloat,this.formatValues=Ht.erectMemoryOptimized3DFloat,null):this.output[1]>0?(this.TextureConstructor=fe,this.renderStrategy=Se.MemoryOptimizedFloatPixelToMemoryOptimized2DFloat,this.formatValues=Ht.erectMemoryOptimized2DFloat,null):(this.TextureConstructor=me,this.renderStrategy=Se.MemoryOptimizedFloatPixelToMemoryOptimizedFloat,this.formatValues=Ht.erectMemoryOptimizedFloat,null);case"Array(2)":return this.output[2]>0?(this.TextureConstructor=se,this.renderStrategy=Se.FloatPixelTo3DArray2,this.formatValues=Ht.erect3DArray2,null):this.output[1]>0?(this.TextureConstructor=ie,this.renderStrategy=Se.FloatPixelTo2DArray2,this.formatValues=Ht.erect2DArray2,null):(this.TextureConstructor=ne,this.renderStrategy=Se.FloatPixelToArray2,this.formatValues=Ht.erectArray2,null);case"Array(3)":return this.output[2]>0?(this.TextureConstructor=ue,this.renderStrategy=Se.FloatPixelTo3DArray3,this.formatValues=Ht.erect3DArray3,null):this.output[1]>0?(this.TextureConstructor=oe,this.renderStrategy=Se.FloatPixelTo2DArray3,this.formatValues=Ht.erect2DArray3,null):(this.TextureConstructor=ae,this.renderStrategy=Se.FloatPixelToArray3,this.formatValues=Ht.erectArray3,null);case"Array(4)":return this.output[2]>0?(this.TextureConstructor=ce,this.renderStrategy=Se.FloatPixelTo3DArray4,this.formatValues=Ht.erect3DArray4,null):this.output[1]>0?(this.TextureConstructor=le,this.renderStrategy=Se.FloatPixelTo2DArray4,this.formatValues=Ht.erect2DArray4,null):(this.TextureConstructor=he,this.renderStrategy=Se.FloatPixelToArray4,this.formatValues=Ht.erectArray4,null)}else switch(this.returnType){case"LiteralInteger":case"Float":case"Number":case"Integer":return this.output[2]>0?(this.TextureConstructor=de,this.renderStrategy=Se.FloatPixelTo3DFloat,this.formatValues=Ht.erect3DFloat,null):this.output[1]>0?(this.TextureConstructor=pe,this.renderStrategy=Se.FloatPixelTo2DFloat,this.formatValues=Ht.erect2DFloat,null):(this.TextureConstructor=re,this.renderStrategy=Se.FloatPixelToFloat,this.formatValues=Ht.erectFloat,null);case"Array(2)":return this.output[2]>0?(this.TextureConstructor=se,this.renderStrategy=Se.FloatPixelTo3DArray2,this.formatValues=Ht.erect3DArray2,null):this.output[1]>0?(this.TextureConstructor=ie,this.renderStrategy=Se.FloatPixelTo2DArray2,this.formatValues=Ht.erect2DArray2,null):(this.TextureConstructor=ne,this.renderStrategy=Se.FloatPixelToArray2,this.formatValues=Ht.erectArray2,null);case"Array(3)":return this.output[2]>0?(this.TextureConstructor=ue,this.renderStrategy=Se.FloatPixelTo3DArray3,this.formatValues=Ht.erect3DArray3,null):this.output[1]>0?(this.TextureConstructor=oe,this.renderStrategy=Se.FloatPixelTo2DArray3,this.formatValues=Ht.erect2DArray3,null):(this.TextureConstructor=ae,this.renderStrategy=Se.FloatPixelToArray3,this.formatValues=Ht.erectArray3,null);case"Array(4)":return this.output[2]>0?(this.TextureConstructor=ce,this.renderStrategy=Se.FloatPixelTo3DArray4,this.formatValues=Ht.erect3DArray4,null):this.output[1]>0?(this.TextureConstructor=le,this.renderStrategy=Se.FloatPixelTo2DArray4,this.formatValues=Ht.erect2DArray4,null):(this.TextureConstructor=he,this.renderStrategy=Se.FloatPixelToArray4,this.formatValues=Ht.erectArray4,null)}}throw new Error(`unhandled return type "${this.returnType}"`)}getKernelString(){throw new Error("abstract method call")}getMainResultTexture(){switch(this.returnType){case"LiteralInteger":case"Float":case"Integer":case"Number":return this.getMainResultNumberTexture();case"Array(2)":return this.getMainResultArray2Texture();case"Array(3)":return this.getMainResultArray3Texture();case"Array(4)":return this.getMainResultArray4Texture();default:throw new Error(`unhandled returnType type ${this.returnType}`)}}getMainResultKernelNumberTexture(){throw new Error("abstract method call")}getMainResultSubKernelNumberTexture(){throw new Error("abstract method call")}getMainResultKernelArray2Texture(){throw new Error("abstract method call")}getMainResultSubKernelArray2Texture(){throw new Error("abstract method call")}getMainResultKernelArray3Texture(){throw new Error("abstract method call")}getMainResultSubKernelArray3Texture(){throw new Error("abstract method call")}getMainResultKernelArray4Texture(){throw new Error("abstract method call")}getMainResultSubKernelArray4Texture(){throw new Error("abstract method call")}getMainResultGraphical(){throw new Error("abstract method call")}getMainResultMemoryOptimizedFloats(){throw new Error("abstract method call")}getMainResultPackedPixels(){throw new Error("abstract method call")}getMainResultString(){return this.graphical?this.getMainResultGraphical():"single"===this.precision?this.optimizeFloatMemory?this.getMainResultMemoryOptimizedFloats():this.getMainResultTexture():this.getMainResultPackedPixels()}getMainResultNumberTexture(){return Ht.linesToString(this.getMainResultKernelNumberTexture())+Ht.linesToString(this.getMainResultSubKernelNumberTexture())}getMainResultArray2Texture(){return Ht.linesToString(this.getMainResultKernelArray2Texture())+Ht.linesToString(this.getMainResultSubKernelArray2Texture())}getMainResultArray3Texture(){return Ht.linesToString(this.getMainResultKernelArray3Texture())+Ht.linesToString(this.getMainResultSubKernelArray3Texture())}getMainResultArray4Texture(){return Ht.linesToString(this.getMainResultKernelArray4Texture())+Ht.linesToString(this.getMainResultSubKernelArray4Texture())}getFloatTacticDeclaration(){switch(this.tactic){case"speed":return"precision lowp float;\n";case"performance":return"precision highp float;\n";case"balanced":default:return"precision mediump float;\n"}}getIntTacticDeclaration(){switch(this.tactic){case"speed":return"precision lowp int;\n";case"performance":return"precision highp int;\n";case"balanced":default:return"precision mediump int;\n"}}getSampler2DTacticDeclaration(){switch(this.tactic){case"speed":return"precision lowp sampler2D;\n";case"performance":return"precision highp sampler2D;\n";case"balanced":default:return"precision mediump sampler2D;\n"}}getSampler2DArrayTacticDeclaration(){switch(this.tactic){case"speed":return"precision lowp sampler2DArray;\n";case"performance":return"precision highp sampler2DArray;\n";case"balanced":default:return"precision mediump sampler2DArray;\n"}}renderTexture(){return new this.TextureConstructor({texture:this.outputTexture,size:this.texSize,dimensions:this.threadDim,output:this.output,context:this.context})}readPackedPixelsToUint8Array(){if("unsigned"!==this.precision)throw new Error('Requires this.precision to be "unsigned"');const{texSize:t,context:e}=this,r=new Uint8Array(t[0]*t[1]*4);return e.readPixels(0,0,t[0],t[1],e.RGBA,e.UNSIGNED_BYTE,r),r}readPackedPixelsToFloat32Array(){return new Float32Array(this.readPackedPixelsToUint8Array().buffer)}readFloatPixelsToFloat32Array(){if("single"!==this.precision)throw new Error('Requires this.precision to be "single"');const{texSize:t,context:e}=this,r=t[0],n=t[1],i=new Float32Array(r*n*4);return e.readPixels(0,0,r,n,e.RGBA,e.FLOAT,i),i}readMemoryOptimizedFloatPixelsToFloat32Array(){if("single"!==this.precision)throw new Error('Requires this.precision to be "single"');const{texSize:t,context:e}=this,r=t[0],n=t[1],i=new Float32Array(r*n*4);return e.readPixels(0,0,r,n,e.RGBA,e.FLOAT,i),i}getPixels(t){const{context:e,output:r}=this,[n,i]=r,s=new Uint8Array(n*i*4);return e.readPixels(0,0,n,i,e.RGBA,e.UNSIGNED_BYTE,s),new Uint8ClampedArray((t?s:Ht.flipPixels(s,n,i)).buffer)}renderKernelsToArrays(){const t={result:this.renderOutput()};for(let e=0;e<this.subKernels.length;e++)t[this.subKernels[e].property]=new this.TextureConstructor({texture:this.subKernelOutputTextures[e],size:this.texSize,dimensions:this.threadDim,output:this.output,context:this.context}).toArray();return t}renderKernelsToTextures(){const t={result:this.renderOutput()};for(let e=0;e<this.subKernels.length;e++)t[this.subKernels[e].property]=new this.TextureConstructor({texture:this.subKernelOutputTextures[e],size:this.texSize,dimensions:this.threadDim,output:this.output,context:this.context});return t}setOutput(t){if(super.setOutput(t),this.program){this.threadDim=[this.output[0],this.output[1]||1,this.output[2]||1],this.texSize=Ht.getKernelTextureSize({optimizeFloatMemory:this.optimizeFloatMemory,precision:this.precision},this.output);const{context:t}=this;t.bindFramebuffer(t.FRAMEBUFFER,this.framebuffer),this.updateMaxTexSize(),this.framebuffer.width=this.texSize[0],this.framebuffer.height=this.texSize[1],this.context.viewport(0,0,this.maxTexSize[0],this.maxTexSize[1]),this.canvas.width=this.maxTexSize[0],this.canvas.height=this.maxTexSize[1],this._setupOutputTexture(),this.subKernels&&this.subKernels.length>0&&this._setupSubOutputTextures()}return this}renderValues(){return this.formatValues(this.transferValues(),this.output[0],this.output[1],this.output[2])}}const Se=Object.freeze({PackedPixelToUint8Array:Symbol("PackedPixelToUint8Array"),PackedPixelToFloat:Symbol("PackedPixelToFloat"),PackedPixelTo2DFloat:Symbol("PackedPixelTo2DFloat"),PackedPixelTo3DFloat:Symbol("PackedPixelTo3DFloat"),PackedTexture:Symbol("PackedTexture"),FloatPixelToFloat32Array:Symbol("FloatPixelToFloat32Array"),FloatPixelToFloat:Symbol("FloatPixelToFloat"),FloatPixelTo2DFloat:Symbol("FloatPixelTo2DFloat"),FloatPixelTo3DFloat:Symbol("FloatPixelTo3DFloat"),FloatPixelToArray2:Symbol("FloatPixelToArray2"),FloatPixelTo2DArray2:Symbol("FloatPixelTo2DArray2"),FloatPixelTo3DArray2:Symbol("FloatPixelTo3DArray2"),FloatPixelToArray3:Symbol("FloatPixelToArray3"),FloatPixelTo2DArray3:Symbol("FloatPixelTo2DArray3"),FloatPixelTo3DArray3:Symbol("FloatPixelTo3DArray3"),FloatPixelToArray4:Symbol("FloatPixelToArray4"),FloatPixelTo2DArray4:Symbol("FloatPixelTo2DArray4"),FloatPixelTo3DArray4:Symbol("FloatPixelTo3DArray4"),FloatTexture:Symbol("FloatTexture"),MemoryOptimizedFloatPixelToMemoryOptimizedFloat:Symbol("MemoryOptimizedFloatPixelToFloat"),MemoryOptimizedFloatPixelToMemoryOptimized2DFloat:Symbol("MemoryOptimizedFloatPixelTo2DFloat"),MemoryOptimizedFloatPixelToMemoryOptimized3DFloat:Symbol("MemoryOptimizedFloatPixelTo3DFloat")}),Ee={int:"Integer",float:"Number",vec2:"Array(2)",vec3:"Array(3)",vec4:"Array(4)"};class _e extends Zt{constructor(t,e){super(t,e),e&&e.hasOwnProperty("fixIntegerDivisionAccuracy")&&(this.fixIntegerDivisionAccuracy=e.fixIntegerDivisionAccuracy)}astFunction(t,e){if(this.isRootKernel)e.push("void");else{if(!this.returnType){this.findLastReturn()&&(this.returnType=this.getType(t.body),"LiteralInteger"===this.returnType&&(this.returnType="Number"))}const{returnType:r}=this;if(r){const t=ve[r];if(!t)throw new Error(`unknown type ${r}`);e.push(t)}else e.push("void")}if(e.push(" "),e.push(this.name),e.push("("),!this.isRootKernel)for(let r=0;r<this.argumentNames.length;++r){const n=this.argumentNames[r];r>0&&e.push(", ");let i=this.argumentTypes[this.argumentNames.indexOf(n)];if(!i)throw this.astErrorOutput(`Unknown argument ${n} type`,t);"LiteralInteger"===i&&(this.argumentTypes[r]=i="Number");const s=ve[i];if(!s)throw this.astErrorOutput("Unexpected expression",t);e.push(s),e.push(" "),e.push("user_"),e.push(n)}e.push(") {\n");for(let r=0;r<t.body.body.length;++r)this.astGeneric(t.body.body[r],e),e.push("\n");return e.push("}\n"),e}astReturnStatement(t,e){if(!t.argument)throw this.astErrorOutput("Unexpected return statement",t);this.pushState("skip-literal-correction");const r=this.getType(t.argument);this.popState("skip-literal-correction");const n=[];switch(this.returnType||(this.returnType="LiteralInteger"===r||"Integer"===r?"Number":r),this.returnType){case"LiteralInteger":case"Number":case"Float":switch(r){case"Integer":n.push("float("),this.astGeneric(t.argument,n),n.push(")");break;case"LiteralInteger":this.castLiteralToFloat(t.argument,n),"Integer"===this.getType(t)&&(n.unshift("float("),n.push(")"));break;default:this.astGeneric(t.argument,n)}break;case"Integer":switch(r){case"Float":case"Number":this.castValueToInteger(t.argument,n);break;case"LiteralInteger":this.castLiteralToInteger(t.argument,n);break;default:this.astGeneric(t.argument,n)}break;case"Array(4)":case"Array(3)":case"Array(2)":case"Input":this.astGeneric(t.argument,n);break;default:throw this.astErrorOutput(`unhandled return type ${this.returnType}`,t)}return this.isRootKernel?(e.push(`kernelResult = ${n.join("")};`),e.push("return;")):this.isSubKernel?(e.push(`subKernelResult_${this.name} = ${n.join("")};`),e.push(`return subKernelResult_${this.name};`)):e.push(`return ${n.join("")};`),e}astLiteral(t,e){if(isNaN(t.value))throw this.astErrorOutput("Non-numeric literal not supported : "+t.value,t);const r=`${t.start},${t.end}`;return Number.isInteger(t.value)?this.isState("in-for-loop-init")||this.isState("casting-to-integer")||this.isState("building-integer")?(this.literalTypes[r]="Integer",e.push(`${t.value}`)):(this.isState("casting-to-float")||this.isState("building-float"),this.literalTypes[r]="Number",e.push(`${t.value}.0`)):this.isState("casting-to-integer")||this.isState("building-integer")?(this.literalTypes[r]="Integer",e.push(Math.round(t.value))):(this.literalTypes[r]="Number",e.push(`${t.value}`)),e}astBinaryExpression(t,e){if(this.checkAndUpconvertOperator(t,e))return e;if(this.fixIntegerDivisionAccuracy&&"/"===t.operator){switch(e.push("div_with_int_check("),this.pushState("building-float"),this.getType(t.left)){case"Integer":this.castValueToFloat(t.left,e);break;case"LiteralInteger":this.castLiteralToFloat(t.left,e);break;default:this.astGeneric(t.left,e)}switch(e.push(", "),this.getType(t.right)){case"Integer":this.castValueToFloat(t.right,e);break;case"LiteralInteger":this.castLiteralToFloat(t.right,e);break;default:this.astGeneric(t.right,e)}return this.popState("building-float"),e.push(")"),e}e.push("(");const r=this.getType(t.left)||"Number",n=this.getType(t.right)||"Number";if(!r||!n)throw this.astErrorOutput("Unhandled binary expression",t);const i=r+" & "+n;switch(i){case"Integer & Integer":this.pushState("building-integer"),this.astGeneric(t.left,e),e.push(we[t.operator]||t.operator),this.astGeneric(t.right,e),this.popState("building-integer");break;case"Number & Float":case"Float & Number":case"Float & Float":case"Number & Number":this.pushState("building-float"),this.astGeneric(t.left,e),e.push(we[t.operator]||t.operator),this.astGeneric(t.right,e),this.popState("building-float");break;case"LiteralInteger & LiteralInteger":this.isState("casting-to-integer")||this.isState("building-integer")?(this.pushState("building-integer"),this.astGeneric(t.left,e),e.push(we[t.operator]||t.operator),this.astGeneric(t.right,e),this.popState("building-integer")):(this.pushState("building-float"),this.castLiteralToFloat(t.left,e),e.push(we[t.operator]||t.operator),this.castLiteralToFloat(t.right,e),this.popState("building-float"));break;case"Integer & Float":case"Integer & Number":if((">"===t.operator||"<"===t.operator&&"Literal"===t.right.type)&&!Number.isInteger(t.right.value)){this.pushState("building-float"),this.castValueToFloat(t.left,e),e.push(we[t.operator]||t.operator),this.astGeneric(t.right,e),this.popState("building-float");break}if(this.pushState("building-integer"),this.astGeneric(t.left,e),e.push(we[t.operator]||t.operator),this.pushState("casting-to-integer"),"Literal"===t.right.type){const r=[];if(this.astGeneric(t.right,r),"Integer"!==this.getType(t.right))throw this.astErrorOutput("Unhandled binary expression with literal",t);e.push(r.join(""))}else e.push("int("),this.astGeneric(t.right,e),e.push(")");this.popState("casting-to-integer"),this.popState("building-integer");break;case"Integer & LiteralInteger":this.pushState("building-integer"),this.astGeneric(t.left,e),e.push(we[t.operator]||t.operator),this.castLiteralToInteger(t.right,e),this.popState("building-integer");break;case"Number & Integer":this.pushState("building-float"),this.astGeneric(t.left,e),e.push(we[t.operator]||t.operator),this.castValueToFloat(t.right,e),this.popState("building-float");break;case"Float & LiteralInteger":case"Number & LiteralInteger":this.isState("in-for-loop-test")?(this.pushState("building-integer"),e.push("int("),this.astGeneric(t.left,e),e.push(")"),e.push(we[t.operator]||t.operator),this.castLiteralToInteger(t.right,e),this.popState("building-integer")):(this.pushState("building-float"),this.astGeneric(t.left,e),e.push(we[t.operator]||t.operator),this.castLiteralToFloat(t.right,e),this.popState("building-float"));break;case"LiteralInteger & Float":case"LiteralInteger & Number":this.isState("in-for-loop-test")||this.isState("in-for-loop-init")||this.isState("casting-to-integer")?(this.pushState("building-integer"),this.castLiteralToInteger(t.left,e),e.push(we[t.operator]||t.operator),this.castValueToInteger(t.right,e),this.popState("building-integer")):(this.pushState("building-float"),this.astGeneric(t.left,e),e.push(we[t.operator]||t.operator),this.pushState("casting-to-float"),this.astGeneric(t.right,e),this.popState("casting-to-float"),this.popState("building-float"));break;case"LiteralInteger & Integer":this.pushState("building-integer"),this.castLiteralToInteger(t.left,e),e.push(we[t.operator]||t.operator),this.astGeneric(t.right,e),this.popState("building-integer");break;case"Boolean & Boolean":this.pushState("building-boolean"),this.astGeneric(t.left,e),e.push(we[t.operator]||t.operator),this.astGeneric(t.right,e),this.popState("building-boolean");break;case"Float & Integer":this.pushState("building-float"),this.astGeneric(t.left,e),e.push(we[t.operator]||t.operator),this.castValueToFloat(t.right,e),this.popState("building-float");break;default:throw this.astErrorOutput(`Unhandled binary expression between ${i}`,t)}return e.push(")"),e}checkAndUpconvertOperator(t,e){const r=this.checkAndUpconvertBitwiseOperators(t,e);if(r)return r;const n={"%":"mod","**":"pow"}[t.operator];if(!n)return null;switch(e.push(n),e.push("("),this.getType(t.left)){case"Integer":this.castValueToFloat(t.left,e);break;case"LiteralInteger":this.castLiteralToFloat(t.left,e);break;default:this.astGeneric(t.left,e)}switch(e.push(","),this.getType(t.right)){case"Integer":this.castValueToFloat(t.right,e);break;case"LiteralInteger":this.castLiteralToFloat(t.right,e);break;default:this.astGeneric(t.right,e)}return e.push(")"),e}checkAndUpconvertBitwiseOperators(t,e){const r={"&":"bitwiseAnd","|":"bitwiseOr","^":"bitwiseXOR","<<":"bitwiseZeroFillLeftShift",">>":"bitwiseSignedRightShift",">>>":"bitwiseZeroFillRightShift"}[t.operator];if(!r)return null;switch(e.push(r),e.push("("),this.getType(t.left)){case"Number":case"Float":this.castValueToInteger(t.left,e);break;case"LiteralInteger":this.castLiteralToInteger(t.left,e);break;default:this.astGeneric(t.left,e)}switch(e.push(","),this.getType(t.right)){case"Number":case"Float":this.castValueToInteger(t.right,e);break;case"LiteralInteger":this.castLiteralToInteger(t.right,e);break;default:this.astGeneric(t.right,e)}return e.push(")"),e}checkAndUpconvertBitwiseUnary(t,e){const r={"~":"bitwiseNot"}[t.operator];if(!r)return null;switch(e.push(r),e.push("("),this.getType(t.argument)){case"Number":case"Float":this.castValueToInteger(t.argument,e);break;case"LiteralInteger":this.castLiteralToInteger(t.argument,e);break;default:this.astGeneric(t.argument,e)}return e.push(")"),e}castLiteralToInteger(t,e){return this.pushState("casting-to-integer"),this.astGeneric(t,e),this.popState("casting-to-integer"),e}castLiteralToFloat(t,e){return this.pushState("casting-to-float"),this.astGeneric(t,e),this.popState("casting-to-float"),e}castValueToInteger(t,e){return this.pushState("casting-to-integer"),e.push("int("),this.astGeneric(t,e),e.push(")"),this.popState("casting-to-integer"),e}castValueToFloat(t,e){return this.pushState("casting-to-float"),e.push("float("),this.astGeneric(t,e),e.push(")"),this.popState("casting-to-float"),e}astIdentifierExpression(t,e){if("Identifier"!==t.type)throw this.astErrorOutput("IdentifierExpression - not an Identifier",t);const r=this.getType(t);return"Infinity"===t.name?e.push("3.402823466e+38"):"Boolean"===r&&this.argumentNames.indexOf(t.name)>-1?e.push(`bool(user_${t.name})`):e.push(`user_${t.name}`),e}astForStatement(t,e){if("ForStatement"!==t.type)throw this.astErrorOutput("Invalid for statement",t);const r=[],n=[],i=[],s=[];let a=null;if(t.init){this.pushState("in-for-loop-init"),this.astGeneric(t.init,r);const{declarations:e}=t.init;for(let t=0;t<e.length;t++)e[t].init&&"Literal"!==e[t].init.type&&(a=!1);if(a)for(let t=0;t<r.length;t++)r[t].includes&&r[t].includes(",")&&(a=!1);this.popState("in-for-loop-init")}else a=!1;if(t.test?(this.pushState("in-for-loop-test"),this.astGeneric(t.test,n),this.popState("in-for-loop-test")):a=!1,t.update?this.astGeneric(t.update,i):a=!1,t.body&&(this.pushState("loop-body"),this.astGeneric(t.body,s),this.popState("loop-body")),null===a&&(a=this.isSafe(t.init)&&this.isSafe(t.test)),a)e.push(`for (${r.join("")};${n.join("")};${i.join("")}){\n`),e.push(s.join("")),e.push("}\n");else{const t=this.getInternalVariableName("safeI");r.length>0&&e.push(r.join(""),";\n"),e.push(`for (int ${t}=0;${t}<LOOP_MAX;${t}++){\n`),n.length>0&&e.push(`if (!${n.join("")}) break;\n`),e.push(s.join("")),e.push(`\n${i.join("")};`),e.push("}\n")}return e}astWhileStatement(t,e){if("WhileStatement"!==t.type)throw this.astErrorOutput("Invalid while statement",t);const r=this.getInternalVariableName("safeI");return e.push(`for (int ${r}=0;${r}<LOOP_MAX;${r}++){\n`),e.push("if (!"),this.astGeneric(t.test,e),e.push(") break;\n"),this.astGeneric(t.body,e),e.push("}\n"),e}astDoWhileStatement(t,e){if("DoWhileStatement"!==t.type)throw this.astErrorOutput("Invalid while statement",t);const r=this.getInternalVariableName("safeI");return e.push(`for (int ${r}=0;${r}<LOOP_MAX;${r}++){\n`),this.astGeneric(t.body,e),e.push("if (!"),this.astGeneric(t.test,e),e.push(") break;\n"),e.push("}\n"),e}astAssignmentExpression(t,e){if("%="===t.operator)this.astGeneric(t.left,e),e.push("="),e.push("mod("),this.astGeneric(t.left,e),e.push(","),this.astGeneric(t.right,e),e.push(")");else{if("**="!==t.operator){const r=this.getType(t.left),n=this.getType(t.right);return this.astGeneric(t.left,e),e.push(t.operator),"Integer"!==r&&"Integer"===n?(e.push("float("),this.astGeneric(t.right,e),e.push(")")):this.astGeneric(t.right,e),e}this.astGeneric(t.left,e),e.push("="),e.push("pow("),this.astGeneric(t.left,e),e.push(","),this.astGeneric(t.right,e),e.push(")")}}astBlockStatement(t,e){if(this.isState("loop-body")){this.pushState("block-body");for(let r=0;r<t.body.length;r++)this.astGeneric(t.body[r],e);this.popState("block-body")}else{e.push("{\n");for(let r=0;r<t.body.length;r++)this.astGeneric(t.body[r],e);e.push("}\n")}return e}astVariableDeclaration(t,e){"var"===t.kind&&this.warnVarUsage&&this.varWarn();const r=t.declarations;if(!r||!r[0]||!r[0].init)throw this.astErrorOutput("Unexpected expression",t);const n=[];let i=null;const s=this.isState("in-for-loop-init");for(let e=0;e<r.length;e++){const a=r[e],o=a.init,u=this.getDeclaration(a.id),h=(u.valueType,this.getType(a.init));u.dependencies;let l=s?"Integer":h;"LiteralInteger"===l&&(l="Number");const c=ve[l];if(!c)throw this.astErrorOutput(`Markup type ${c} not handled`,t);const p=[];if("Integer"!==h||"Integer"!==l||s)u.valueType=l,0===e||null===i?p.push(`${c} `):l!==i?(n.push(";"),p.push(`${c} `)):p.push(","),i=l,p.push(`user_${a.id.name}=`),"Number"===h&&"Integer"===l?o.left&&"Literal"===o.left.type?this.astGeneric(o,p):(p.push("int("),this.astGeneric(o,p),p.push(")")):this.astGeneric(o,p);else{if(u.valueType="Number",0===e||null===i)p.push("float ");else{if(l!==i)throw new Error("Unhandled declaration");p.push(",")}i=l,p.push(`user_${a.id.name}=`),p.push("float("),this.astGeneric(o,p),p.push(")")}n.push(p.join(""))}return e.push(n.join("")),s||e.push(";"),e}astIfStatement(t,e){return e.push("if ("),this.astGeneric(t.test,e),e.push(")"),"BlockStatement"===t.consequent.type?this.astGeneric(t.consequent,e):(e.push(" {\n"),this.astGeneric(t.consequent,e),e.push("\n}\n")),t.alternate&&(e.push("else "),"BlockStatement"===t.alternate.type?this.astGeneric(t.alternate,e):(e.push(" {\n"),this.astGeneric(t.alternate,e),e.push("\n}\n"))),e}astSwitchStatement(t,e){if("SwitchStatement"!==t.type)throw this.astErrorOutput("Invalid switch statement",t);const{discriminant:r,cases:n}=t,i=this.getType(r),s=`switchDiscriminant${t.start}_${t.end}`;switch(i){case"Float":case"Number":e.push(`float ${s} = `),this.astGeneric(r,e),e.push(";\n");break;case"Integer":e.push(`int ${s} = `),this.astGeneric(r,e),e.push(";\n")}if(1===n.length&&!n[0].test)return this.astGeneric(n[0].consequent,e),e;let a=!1,o=[],u=!1,h=!1;for(let t=0;t<n.length;t++){if(n[t].test){if(0!==t&&h?a?(e.push(`${s} == `),a=!1):e.push(` else if (${s} == `):(h=!0,e.push(`if (${s} == `)),"Integer"===i){switch(this.getType(n[t].test)){case"Number":case"Float":this.castValueToInteger(n[t].test,e);break;case"LiteralInteger":this.castLiteralToInteger(n[t].test,e)}}else{if("Float"!==i)throw new Error("unhanlded");switch(this.getType(n[t].test)){case"LiteralInteger":this.castLiteralToFloat(n[t].test,e);break;case"Integer":this.castValueToFloat(n[t].test,e)}}if(!n[t].consequent||0===n[t].consequent.length){a=!0,e.push(" || ");continue}e.push(") {\n")}else{if(n.length>t+1){u=!0,this.astGeneric(n[t].consequent,o);continue}e.push(" else {\n")}this.astGeneric(n[t].consequent,e),e.push("\n}")}return u&&(e.push(" else {"),e.push(o.join("")),e.push("}")),e}astThisExpression(t,e){return e.push("this"),e}astMemberExpression(t,e){const{property:r,name:n,signature:i,origin:s,type:a,xProperty:o,yProperty:u,zProperty:h}=this.getMemberExpressionDetails(t);switch(i){case"value.thread.value":case"this.thread.value":if("x"!==n&&"y"!==n&&"z"!==n)throw this.astErrorOutput("Unexpected expression, expected `this.thread.x`, `this.thread.y`, or `this.thread.z`",t);return e.push(`threadId.${n}`),e;case"this.output.value":if(this.dynamicOutput)switch(n){case"x":this.isState("casting-to-float")?e.push("float(uOutputDim.x)"):e.push("uOutputDim.x");break;case"y":this.isState("casting-to-float")?e.push("float(uOutputDim.y)"):e.push("uOutputDim.y");break;case"z":this.isState("casting-to-float")?e.push("float(uOutputDim.z)"):e.push("uOutputDim.z");break;default:throw this.astErrorOutput("Unexpected expression",t)}else switch(n){case"x":this.isState("casting-to-integer")?e.push(this.output[0]):e.push(this.output[0],".0");break;case"y":this.isState("casting-to-integer")?e.push(this.output[1]):e.push(this.output[1],".0");break;case"z":this.isState("casting-to-integer")?e.push(this.output[2]):e.push(this.output[2],".0");break;default:throw this.astErrorOutput("Unexpected expression",t)}return e;case"value":throw this.astErrorOutput("Unexpected expression",t);case"value[]":case"value[][]":case"value[][][]":case"value[][][][]":case"value.value":if("Math"===s)return e.push(Math[n]),e;switch(r){case"r":return e.push(`user_${n}.r`),e;case"g":return e.push(`user_${n}.g`),e;case"b":return e.push(`user_${n}.b`),e;case"a":return e.push(`user_${n}.a`),e}break;case"this.constants.value":if(void 0===o)switch(a){case"Array(2)":case"Array(3)":case"Array(4)":return e.push(`constants_${n}`),e}case"this.constants.value[]":case"this.constants.value[][]":case"this.constants.value[][][]":case"this.constants.value[][][][]":break;case"fn()[]":return this.astCallExpression(t.object,e),e.push("["),e.push(this.memberExpressionPropertyMarkup(r)),e.push("]"),e;case"[][]":return this.astArrayExpression(t.object,e),e.push("["),e.push(this.memberExpressionPropertyMarkup(r)),e.push("]"),e;default:throw this.astErrorOutput("Unexpected expression",t)}if(!1===t.computed)switch(a){case"Number":case"Integer":case"Float":case"Boolean":return e.push(`${s}_${n}`),e}const l=`${s}_${n}`;switch(a){case"Array(2)":case"Array(3)":case"Array(4)":this.astGeneric(t.object,e),e.push("["),e.push(this.memberExpressionPropertyMarkup(o)),e.push("]");break;case"HTMLImageArray":e.push(`getImage3D(${l}, ${l}Size, ${l}Dim, `),this.memberExpressionXYZ(o,u,h,e),e.push(")");break;case"ArrayTexture(1)":e.push(`getFloatFromSampler2D(${l}, ${l}Size, ${l}Dim, `),this.memberExpressionXYZ(o,u,h,e),e.push(")");break;case"Array1D(2)":case"Array2D(2)":case"Array3D(2)":e.push(`getMemoryOptimizedVec2(${l}, ${l}Size, ${l}Dim, `),this.memberExpressionXYZ(o,u,h,e),e.push(")");break;case"ArrayTexture(2)":e.push(`getVec2FromSampler2D(${l}, ${l}Size, ${l}Dim, `),this.memberExpressionXYZ(o,u,h,e),e.push(")");break;case"Array1D(3)":case"Array2D(3)":case"Array3D(3)":e.push(`getMemoryOptimizedVec3(${l}, ${l}Size, ${l}Dim, `),this.memberExpressionXYZ(o,u,h,e),e.push(")");break;case"ArrayTexture(3)":e.push(`getVec3FromSampler2D(${l}, ${l}Size, ${l}Dim, `),this.memberExpressionXYZ(o,u,h,e),e.push(")");break;case"Array1D(4)":case"Array2D(4)":case"Array3D(4)":e.push(`getMemoryOptimizedVec4(${l}, ${l}Size, ${l}Dim, `),this.memberExpressionXYZ(o,u,h,e),e.push(")");break;case"ArrayTexture(4)":case"HTMLImage":case"HTMLVideo":e.push(`getVec4FromSampler2D(${l}, ${l}Size, ${l}Dim, `),this.memberExpressionXYZ(o,u,h,e),e.push(")");break;case"NumberTexture":case"Array":case"Array2D":case"Array3D":case"Array4D":case"Input":case"Number":case"Float":case"Integer":if("single"===this.precision)e.push(`getMemoryOptimized32(${l}, ${l}Size, ${l}Dim, `),this.memberExpressionXYZ(o,u,h,e),e.push(")");else{const t="user"===s?this.lookupFunctionArgumentBitRatio(this.name,n):this.constantBitRatios[n];switch(t){case 1:e.push(`get8(${l}, ${l}Size, ${l}Dim, `);break;case 2:e.push(`get16(${l}, ${l}Size, ${l}Dim, `);break;case 4:case 0:e.push(`get32(${l}, ${l}Size, ${l}Dim, `);break;default:throw new Error(`unhandled bit ratio of ${t}`)}this.memberExpressionXYZ(o,u,h,e),e.push(")")}break;case"MemoryOptimizedNumberTexture":e.push(`getMemoryOptimized32(${l}, ${l}Size, ${l}Dim, `),this.memberExpressionXYZ(o,u,h,e),e.push(")");break;default:throw new Error(`unhandled member expression "${a}"`)}return e}astCallExpression(t,e){if(!t.callee)throw this.astErrorOutput("Unknown CallExpression",t);let r=null;const n=this.isAstMathFunction(t);if(!(r=n||t.callee.object&&"ThisExpression"===t.callee.object.type?t.callee.property.name:"SequenceExpression"!==t.callee.type||"Literal"!==t.callee.expressions[0].type||isNaN(t.callee.expressions[0].raw)?t.callee.name:t.callee.expressions[1].property.name))throw this.astErrorOutput("Unhandled function, couldn't find name",t);if("atan2"===r&&(r="atan"),this.calledFunctions.indexOf(r)<0&&this.calledFunctions.push(r),"random"===r&&this.plugins&&this.plugins.length>0)for(let t=0;t<this.plugins.length;t++){const r=this.plugins[t];if("Math.random()"===r.functionMatch&&r.functionReplace)return e.push(r.functionReplace),e}if(this.onFunctionCall&&this.onFunctionCall(this.name,r,t.arguments),e.push(r),e.push("("),n)for(let r=0;r<t.arguments.length;++r){const n=t.arguments[r],i=this.getType(n);switch(r>0&&e.push(", "),i){case"Integer":this.castValueToFloat(n,e);break;default:this.astGeneric(n,e)}}else{const n=this.lookupFunctionArgumentTypes(r)||[];for(let i=0;i<t.arguments.length;++i){const s=t.arguments[i];let a=n[i];i>0&&e.push(", ");const o=this.getType(s);switch(a||(this.triggerImplyArgumentType(r,i,o,this),a=o),o){case"Number":case"Float":if("Integer"===a){e.push("int("),this.astGeneric(s,e),e.push(")");continue}if("Number"===a||"Float"===a){this.astGeneric(s,e);continue}if("LiteralInteger"===a){this.castLiteralToFloat(s,e);continue}break;case"Integer":if("Number"===a||"Float"===a){e.push("float("),this.astGeneric(s,e),e.push(")");continue}if("Integer"===a){this.astGeneric(s,e);continue}break;case"LiteralInteger":if("Integer"===a){this.castLiteralToInteger(s,e);continue}if("Number"===a||"Float"===a){this.castLiteralToFloat(s,e);continue}if("LiteralInteger"===a){this.astGeneric(s,e);continue}break;case"Array(2)":case"Array(3)":case"Array(4)":if(a===o){if("Identifier"!==s.type)throw this.astErrorOutput(`Unhandled argument type ${s.type}`,t);this.triggerImplyArgumentBitRatio(this.name,s.name,r,i),e.push(`user_${s.name}`);continue}break;case"HTMLImage":case"HTMLImageArray":case"HTMLVideo":case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":case"Array":case"Input":if(a===o){if("Identifier"!==s.type)throw this.astErrorOutput(`Unhandled argument type ${s.type}`,t);this.triggerImplyArgumentBitRatio(this.name,s.name,r,i),e.push(`user_${s.name},user_${s.name}Size,user_${s.name}Dim`);continue}}throw this.astErrorOutput(`Unhandled argument combination of ${o} and ${a} for argument named "${s.name}"`,t)}}return e.push(")"),e}astArrayExpression(t,e){const r=t.elements.length;e.push("vec"+r+"(");for(let n=0;n<r;++n){n>0&&e.push(", ");const r=t.elements[n];this.astGeneric(r,e)}return e.push(")"),e}memberExpressionXYZ(t,e,r,n){return r?n.push(this.memberExpressionPropertyMarkup(r),", "):n.push("0, "),e?n.push(this.memberExpressionPropertyMarkup(e),", "):n.push("0, "),n.push(this.memberExpressionPropertyMarkup(t)),n}memberExpressionPropertyMarkup(t){if(!t)throw new Error("Property not set");const e=[];switch(this.getType(t)){case"Number":case"Float":this.castValueToInteger(t,e);break;case"LiteralInteger":this.castLiteralToInteger(t,e);break;default:this.astGeneric(t,e)}return e.join("")}}const ve={Array:"sampler2D","Array(2)":"vec2","Array(3)":"vec3","Array(4)":"vec4",Array2D:"sampler2D",Array3D:"sampler2D",Boolean:"bool",Float:"float",Input:"sampler2D",Integer:"int",Number:"float",LiteralInteger:"float",NumberTexture:"sampler2D",MemoryOptimizedNumberTexture:"sampler2D","ArrayTexture(1)":"sampler2D","ArrayTexture(2)":"sampler2D","ArrayTexture(3)":"sampler2D","ArrayTexture(4)":"sampler2D",HTMLVideo:"sampler2D",HTMLImage:"sampler2D",HTMLImageArray:"sampler2DArray"},we={"===":"==","!==":"!="};var Ie={name:"triangle-noise-noise",onBeforeRun:t=>{t.setUniform1f("triangle_noise_seed",Math.random())},functionMatch:"Math.random()",functionReplace:"n4rand(vTexCoord)",functionReturnType:"Number",source:"\n\nuniform highp float triangle_noise_seed;\nhighp float triangle_noise_shift = 0.000001;\n\n//https://www.shadertoy.com/view/4t2SDh\n//note: uniformly distributed, normalized rand, [0;1[\nfloat nrand( vec2 n )\n{\n  return fract(sin(dot(n.xy, vec2(12.9898, 78.233)))* 43758.5453);\n}\n//note: remaps v to [0;1] in interval [a;b]\nfloat remap( float a, float b, float v )\n{\n  return clamp( (v-a) / (b-a), 0.0, 1.0 );\n}\n\nfloat n4rand( vec2 n )\n{\n  float t = fract( triangle_noise_seed + triangle_noise_shift );\n  float nrnd0 = nrand( n + 0.07*t );\n  float nrnd1 = nrand( n + 0.11*t );\n  float nrnd2 = nrand( n + 0.13*t );\n  float nrnd3 = nrand( n + 0.17*t );\n  float result = (nrnd0+nrnd1+nrnd2+nrnd3) / 4.0;\n  triangle_noise_shift = result + 0.000001;\n  return result;\n}"};const De="__HEADER__;\n__FLOAT_TACTIC_DECLARATION__;\n__INT_TACTIC_DECLARATION__;\n__SAMPLER_2D_TACTIC_DECLARATION__;\n\nconst int LOOP_MAX = __LOOP_MAX__;\n\n__PLUGINS__;\n__CONSTANTS__;\n\nvarying vec2 vTexCoord;\n\nvec4 round(vec4 x) {\n  return floor(x + 0.5);\n}\n\nfloat round(float x) {\n  return floor(x + 0.5);\n}\n\nconst int BIT_COUNT = 32;\nint modi(int x, int y) {\n  return x - y * (x / y);\n}\n\nint bitwiseOr(int a, int b) {\n  int result = 0;\n  int n = 1;\n\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if ((modi(a, 2) == 1) || (modi(b, 2) == 1)) {\n      result += n;\n    }\n    a = a / 2;\n    b = b / 2;\n    n = n * 2;\n    if(!(a > 0 || b > 0)) {\n      break;\n    }\n  }\n  return result;\n}\nint bitwiseXOR(int a, int b) {\n  int result = 0;\n  int n = 1;\n\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if ((modi(a, 2) == 1) != (modi(b, 2) == 1)) {\n      result += n;\n    }\n    a = a / 2;\n    b = b / 2;\n    n = n * 2;\n    if(!(a > 0 || b > 0)) {\n      break;\n    }\n  }\n  return result;\n}\nint bitwiseAnd(int a, int b) {\n  int result = 0;\n  int n = 1;\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if ((modi(a, 2) == 1) && (modi(b, 2) == 1)) {\n      result += n;\n    }\n    a = a / 2;\n    b = b / 2;\n    n = n * 2;\n    if(!(a > 0 && b > 0)) {\n      break;\n    }\n  }\n  return result;\n}\nint bitwiseNot(int a) {\n  int result = 0;\n  int n = 1;\n\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (modi(a, 2) == 0) {\n      result += n;\n    }\n    a = a / 2;\n    n = n * 2;\n  }\n  return result;\n}\nint bitwiseZeroFillLeftShift(int n, int shift) {\n  int maxBytes = BIT_COUNT;\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (maxBytes >= n) {\n      break;\n    }\n    maxBytes *= 2;\n  }\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (i >= shift) {\n      break;\n    }\n    n *= 2;\n  }\n\n  int result = 0;\n  int byteVal = 1;\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (i >= maxBytes) break;\n    if (modi(n, 2) > 0) { result += byteVal; }\n    n = int(n / 2);\n    byteVal *= 2;\n  }\n  return result;\n}\n\nint bitwiseSignedRightShift(int num, int shifts) {\n  return int(floor(float(num) / pow(2.0, float(shifts))));\n}\n\nint bitwiseZeroFillRightShift(int n, int shift) {\n  int maxBytes = BIT_COUNT;\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (maxBytes >= n) {\n      break;\n    }\n    maxBytes *= 2;\n  }\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (i >= shift) {\n      break;\n    }\n    n /= 2;\n  }\n  int result = 0;\n  int byteVal = 1;\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (i >= maxBytes) break;\n    if (modi(n, 2) > 0) { result += byteVal; }\n    n = int(n / 2);\n    byteVal *= 2;\n  }\n  return result;\n}\n\nvec2 integerMod(vec2 x, float y) {\n  vec2 res = floor(mod(x, y));\n  return res * step(1.0 - floor(y), -res);\n}\n\nvec3 integerMod(vec3 x, float y) {\n  vec3 res = floor(mod(x, y));\n  return res * step(1.0 - floor(y), -res);\n}\n\nvec4 integerMod(vec4 x, vec4 y) {\n  vec4 res = floor(mod(x, y));\n  return res * step(1.0 - floor(y), -res);\n}\n\nfloat integerMod(float x, float y) {\n  float res = floor(mod(x, y));\n  return res * (res > floor(y) - 1.0 ? 0.0 : 1.0);\n}\n\nint integerMod(int x, int y) {\n  return x - (y * int(x / y));\n}\n\n__DIVIDE_WITH_INTEGER_CHECK__;\n\n// Here be dragons!\n// DO NOT OPTIMIZE THIS CODE\n// YOU WILL BREAK SOMETHING ON SOMEBODY'S MACHINE\n// LEAVE IT AS IT IS, LEST YOU WASTE YOUR OWN TIME\nconst vec2 MAGIC_VEC = vec2(1.0, -256.0);\nconst vec4 SCALE_FACTOR = vec4(1.0, 256.0, 65536.0, 0.0);\nconst vec4 SCALE_FACTOR_INV = vec4(1.0, 0.00390625, 0.0000152587890625, 0.0); // 1, 1/256, 1/65536\nfloat decode32(vec4 texel) {\n  __DECODE32_ENDIANNESS__;\n  texel *= 255.0;\n  vec2 gte128;\n  gte128.x = texel.b >= 128.0 ? 1.0 : 0.0;\n  gte128.y = texel.a >= 128.0 ? 1.0 : 0.0;\n  float exponent = 2.0 * texel.a - 127.0 + dot(gte128, MAGIC_VEC);\n  float res = exp2(round(exponent));\n  texel.b = texel.b - 128.0 * gte128.x;\n  res = dot(texel, SCALE_FACTOR) * exp2(round(exponent-23.0)) + res;\n  res *= gte128.y * -2.0 + 1.0;\n  return res;\n}\n\nfloat decode16(vec4 texel, int index) {\n  int channel = integerMod(index, 2);\n  if (channel == 0) return texel.r * 255.0 + texel.g * 65280.0;\n  if (channel == 1) return texel.b * 255.0 + texel.a * 65280.0;\n  return 0.0;\n}\n\nfloat decode8(vec4 texel, int index) {\n  int channel = integerMod(index, 4);\n  if (channel == 0) return texel.r * 255.0;\n  if (channel == 1) return texel.g * 255.0;\n  if (channel == 2) return texel.b * 255.0;\n  if (channel == 3) return texel.a * 255.0;\n  return 0.0;\n}\n\nvec4 legacyEncode32(float f) {\n  float F = abs(f);\n  float sign = f < 0.0 ? 1.0 : 0.0;\n  float exponent = floor(log2(F));\n  float mantissa = (exp2(-exponent) * F);\n  // exponent += floor(log2(mantissa));\n  vec4 texel = vec4(F * exp2(23.0-exponent)) * SCALE_FACTOR_INV;\n  texel.rg = integerMod(texel.rg, 256.0);\n  texel.b = integerMod(texel.b, 128.0);\n  texel.a = exponent*0.5 + 63.5;\n  texel.ba += vec2(integerMod(exponent+127.0, 2.0), sign) * 128.0;\n  texel = floor(texel);\n  texel *= 0.003921569; // 1/255\n  __ENCODE32_ENDIANNESS__;\n  return texel;\n}\n\n// https://github.com/gpujs/gpu.js/wiki/Encoder-details\nvec4 encode32(float value) {\n  if (value == 0.0) return vec4(0, 0, 0, 0);\n\n  float exponent;\n  float mantissa;\n  vec4  result;\n  float sgn;\n\n  sgn = step(0.0, -value);\n  value = abs(value);\n\n  exponent = floor(log2(value));\n\n  mantissa = value*pow(2.0, -exponent)-1.0;\n  exponent = exponent+127.0;\n  result   = vec4(0,0,0,0);\n\n  result.a = floor(exponent/2.0);\n  exponent = exponent - result.a*2.0;\n  result.a = result.a + 128.0*sgn;\n\n  result.b = floor(mantissa * 128.0);\n  mantissa = mantissa - result.b / 128.0;\n  result.b = result.b + exponent*128.0;\n\n  result.g = floor(mantissa*32768.0);\n  mantissa = mantissa - result.g/32768.0;\n\n  result.r = floor(mantissa*8388608.0);\n  return result/255.0;\n}\n// Dragons end here\n\nint index;\nivec3 threadId;\n\nivec3 indexTo3D(int idx, ivec3 texDim) {\n  int z = int(idx / (texDim.x * texDim.y));\n  idx -= z * int(texDim.x * texDim.y);\n  int y = int(idx / texDim.x);\n  int x = int(integerMod(idx, texDim.x));\n  return ivec3(x, y, z);\n}\n\nfloat get32(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture2D(tex, st / vec2(texSize));\n  return decode32(texel);\n}\n\nfloat get16(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int w = texSize.x * 2;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture2D(tex, st / vec2(texSize.x * 2, texSize.y));\n  return decode16(texel, index);\n}\n\nfloat get8(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int w = texSize.x * 4;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture2D(tex, st / vec2(texSize.x * 4, texSize.y));\n  return decode8(texel, index);\n}\n\nfloat getMemoryOptimized32(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int channel = integerMod(index, 4);\n  index = index / 4;\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture2D(tex, st / vec2(texSize));\n  if (channel == 0) return texel.r;\n  if (channel == 1) return texel.g;\n  if (channel == 2) return texel.b;\n  if (channel == 3) return texel.a;\n  return 0.0;\n}\n\nvec4 getImage2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  return texture2D(tex, st / vec2(texSize));\n}\n\nfloat getFloatFromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);\n  return result[0];\n}\n\nvec2 getVec2FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);\n  return vec2(result[0], result[1]);\n}\n\nvec2 getMemoryOptimizedVec2(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + (texDim.x * (y + (texDim.y * z)));\n  int channel = integerMod(index, 2);\n  index = index / 2;\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture2D(tex, st / vec2(texSize));\n  if (channel == 0) return vec2(texel.r, texel.g);\n  if (channel == 1) return vec2(texel.b, texel.a);\n  return vec2(0.0, 0.0);\n}\n\nvec3 getVec3FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);\n  return vec3(result[0], result[1], result[2]);\n}\n\nvec3 getMemoryOptimizedVec3(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int fieldIndex = 3 * (x + texDim.x * (y + texDim.y * z));\n  int vectorIndex = fieldIndex / 4;\n  int vectorOffset = fieldIndex - vectorIndex * 4;\n  int readY = vectorIndex / texSize.x;\n  int readX = vectorIndex - readY * texSize.x;\n  vec4 tex1 = texture2D(tex, (vec2(readX, readY) + 0.5) / vec2(texSize));\n\n  if (vectorOffset == 0) {\n    return tex1.xyz;\n  } else if (vectorOffset == 1) {\n    return tex1.yzw;\n  } else {\n    readX++;\n    if (readX >= texSize.x) {\n      readX = 0;\n      readY++;\n    }\n    vec4 tex2 = texture2D(tex, vec2(readX, readY) / vec2(texSize));\n    if (vectorOffset == 2) {\n      return vec3(tex1.z, tex1.w, tex2.x);\n    } else {\n      return vec3(tex1.w, tex2.x, tex2.y);\n    }\n  }\n}\n\nvec4 getVec4FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  return getImage2D(tex, texSize, texDim, z, y, x);\n}\n\nvec4 getMemoryOptimizedVec4(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int channel = integerMod(index, 2);\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture2D(tex, st / vec2(texSize));\n  return vec4(texel.r, texel.g, texel.b, texel.a);\n}\n\nvec4 actualColor;\nvoid color(float r, float g, float b, float a) {\n  actualColor = vec4(r,g,b,a);\n}\n\nvoid color(float r, float g, float b) {\n  color(r,g,b,1.0);\n}\n\nvoid color(sampler2D image) {\n  actualColor = texture2D(image, vTexCoord);\n}\n\n__INJECTED_NATIVE__;\n__MAIN_CONSTANTS__;\n__MAIN_ARGUMENTS__;\n__KERNEL__;\n\nvoid main(void) {\n  index = int(vTexCoord.s * float(uTexSize.x)) + int(vTexCoord.t * float(uTexSize.y)) * uTexSize.x;\n  __MAIN_RESULT__;\n}",Re="__FLOAT_TACTIC_DECLARATION__;\n__INT_TACTIC_DECLARATION__;\n__SAMPLER_2D_TACTIC_DECLARATION__;\n\nattribute vec2 aPos;\nattribute vec2 aTexCoord;\n\nvarying vec2 vTexCoord;\nuniform vec2 ratio;\n\nvoid main(void) {\n  gl_Position = vec4((aPos + vec2(1)) * ratio + vec2(-1), 0, 1);\n  vTexCoord = aTexCoord;\n}";var ke=function(t,e){return t(e={exports:{}},e.exports),e.exports}((function(t){function e(t,e={}){const{contextName:s="gl",throwGetError:a,useTrackablePrimitives:o,readPixelsFile:u,recording:h=[],variables:l={},onReadPixels:c,onUnrecognizedArgumentLookup:p}=e,d=new Proxy(t,{get:function(e,d){switch(d){case"addComment":return w;case"checkThrowError":return I;case"getReadPixelsVariableName":return g;case"insertVariable":return A;case"reset":return b;case"setIndent":return E;case"toString":return T;case"getContextVariableName":return k}if("function"==typeof t[d])return function(){switch(d){case"getError":return a?h.push(`${y}if (${s}.getError() !== ${s}.NONE) throw new Error('error');`):h.push(`${y}${s}.getError();`),t.getError();case"getExtension":{const e=`${s}Variables${m.length}`;h.push(`${y}const ${e} = ${s}.getExtension('${arguments[0]}');`);const n=t.getExtension(arguments[0]);if(n&&"object"==typeof n){const t=r(n,{getEntity:S,useTrackablePrimitives:o,recording:h,contextName:e,contextVariables:m,variables:l,indent:y,onUnrecognizedArgumentLookup:p});return m.push(t),t}return m.push(null),n}case"readPixels":const e=m.indexOf(arguments[6]);let i;if(-1===e){const t=R(arguments[6]);t?(i=t,h.push(`${y}${t}`)):(i=`${s}Variable${m.length}`,m.push(arguments[6]),h.push(`${y}const ${i} = new ${arguments[6].constructor.name}(${arguments[6].length});`))}else i=`${s}Variable${e}`;g=i;const d=[arguments[0],arguments[1],arguments[2],arguments[3],S(arguments[4]),S(arguments[5]),i];return h.push(`${y}${s}.readPixels(${d.join(", ")});`),u&&v(arguments[2],arguments[3]),c&&c(i,d),t.readPixels.apply(t,arguments);case"drawBuffers":return h.push(`${y}${s}.drawBuffers([${n(arguments[0],{contextName:s,contextVariables:m,getEntity:S,addVariable:_,variables:l,onUnrecognizedArgumentLookup:p})}]);`),t.drawBuffers(arguments[0])}let e=t[d].apply(t,arguments);switch(typeof e){case"undefined":return void h.push(`${y}${D(d,arguments)};`);case"number":case"boolean":if(o&&-1===m.indexOf(i(e))){h.push(`${y}const ${s}Variable${m.length} = ${D(d,arguments)};`),m.push(e=i(e));break}default:null===e?h.push(`${D(d,arguments)};`):h.push(`${y}const ${s}Variable${m.length} = ${D(d,arguments)};`),m.push(e)}return e};return f[t[d]]=d,t[d]}}),m=[],f={};let g,x=0,y="";return d;function T(){return h.join("\n")}function b(){for(;h.length>0;)h.pop()}function A(t,e){l[t]=e}function S(t){const e=f[t];return e?s+"."+e:t}function E(t){y=" ".repeat(t)}function _(t,e){const r=`${s}Variable${m.length}`;return h.push(`${y}const ${r} = ${e};`),m.push(t),r}function v(t,e){const r=`${s}Variable${m.length}`,n=`imageDatum${x}`;h.push(`${y}let ${n} = ["P3\\n# ${u}.ppm\\n", ${t}, ' ', ${e}, "\\n255\\n"].join("");`),h.push(`${y}for (let i = 0; i < ${n}.length; i += 4) {`),h.push(`${y}  ${n} += ${r}[i] + ' ' + ${r}[i + 1] + ' ' + ${r}[i + 2] + ' ';`),h.push(`${y}}`),h.push(`${y}if (typeof require !== "undefined") {`),h.push(`${y}  require('fs').writeFileSync('./${u}.ppm', ${n});`),h.push(`${y}}`),x++}function w(t){h.push(`${y}// ${t}`)}function I(){h.push(`${y}(() => {\n${y}const error = ${s}.getError();\n${y}if (error !== ${s}.NONE) {\n${y}  const names = Object.getOwnPropertyNames(gl);\n${y}  for (let i = 0; i < names.length; i++) {\n${y}    const name = names[i];\n${y}    if (${s}[name] === error) {\n${y}      throw new Error('${s} threw ' + name);\n${y}    }\n${y}  }\n${y}}\n${y}})();`)}function D(t,e){return`${s}.${t}(${n(e,{contextName:s,contextVariables:m,getEntity:S,addVariable:_,variables:l,onUnrecognizedArgumentLookup:p})})`}function R(t){if(l)for(const e in l)if(l[e]===t)return e;return null}function k(t){const e=m.indexOf(t);return-1!==e?`${s}Variable${e}`:null}}function r(t,e){const r=new Proxy(t,{get:function(e,r){if("function"==typeof e[r])return function(){switch(r){case"drawBuffersWEBGL":return l.push(`${p}${a}.drawBuffersWEBGL([${n(arguments[0],{contextName:a,contextVariables:o,getEntity:m,addVariable:g,variables:c,onUnrecognizedArgumentLookup:d})}]);`),t.drawBuffersWEBGL(arguments[0])}let e=t[r].apply(t,arguments);switch(typeof e){case"undefined":return void l.push(`${p}${f(r,arguments)};`);case"number":case"boolean":h&&-1===o.indexOf(i(e))?(l.push(`${p}const ${a}Variable${o.length} = ${f(r,arguments)};`),o.push(e=i(e))):(l.push(`${p}const ${a}Variable${o.length} = ${f(r,arguments)};`),o.push(e));break;default:null===e?l.push(`${f(r,arguments)};`):l.push(`${p}const ${a}Variable${o.length} = ${f(r,arguments)};`),o.push(e)}return e};return s[t[r]]=r,t[r]}}),s={},{contextName:a,contextVariables:o,getEntity:u,useTrackablePrimitives:h,recording:l,variables:c,indent:p,onUnrecognizedArgumentLookup:d}=e;return r;function m(t){return s.hasOwnProperty(t)?`${a}.${s[t]}`:u(t)}function f(t,e){return`${a}.${t}(${n(e,{contextName:a,contextVariables:o,getEntity:m,addVariable:g,variables:c,onUnrecognizedArgumentLookup:d})})`}function g(t,e){const r=`${a}Variable${o.length}`;return o.push(t),l.push(`${p}const ${r} = ${e};`),r}}function n(t,e){const{variables:r,onUnrecognizedArgumentLookup:n}=e;return Array.from(t).map(t=>{const i=function(t){if(r)for(const e in r)if(r.hasOwnProperty(e)&&r[e]===t)return e;if(n)return n(t);return null}(t);return i||function(t,e){const{contextName:r,contextVariables:n,getEntity:i,addVariable:s,onUnrecognizedArgumentLookup:a}=e;if(void 0===t)return"undefined";if(null===t)return"null";const o=n.indexOf(t);if(o>-1)return`${r}Variable${o}`;switch(t.constructor.name){case"String":const e=/\n/.test(t),r=/'/.test(t),n=/"/.test(t);return e?"`"+t+"`":r&&!n?'"'+t+'"':"'"+t+"'";case"Number":case"Boolean":return i(t);case"Array":return s(t,`new ${t.constructor.name}([${Array.from(t).join(",")}])`);case"Float32Array":case"Uint8Array":case"Uint16Array":case"Int32Array":return s(t,`new ${t.constructor.name}(${JSON.stringify(Array.from(t))})`);default:if(a){const e=a(t);if(e)return e}throw new Error(`unrecognized argument type ${t.constructor.name}`)}}(t,e)}).join(", ")}function i(t){return new t.constructor(t)}t.exports={glWiretap:e,glExtensionWiretap:r},"undefined"!=typeof window&&(e.glExtensionWiretap=r,window.glWiretap=e)})),$e=ke.glWiretap;ke.glExtensionWiretap;function Ce(t){return t.toString().replace("=>","").replace(/^function /,"").replace(/utils[.]/g,"/*utils.*/")}function Fe(t,e,r,n,i){e=e?Array.from(e).map(t=>{switch(typeof t){case"boolean":return new Boolean(t);case"number":return new Number(t);default:return t}}):null;const s=[],a=$e(r.context,{useTrackablePrimitives:!0,onReadPixels:t=>{if(I.subKernels){if(o){const e=I.subKernels[u++].property;s.push(`    result${isNaN(e)?"."+e:`[${e}]`} = ${Ne(t,I)};`)}else s.push(`    const result = { result: ${Ne(t,I)} };`),o=!0;u===I.subKernels.length&&s.push("    return result;")}else t?s.push(`    return ${Ne(t,I)};`):s.push("    return null;")},onUnrecognizedArgumentLookup:t=>{const e=Pe(t,I.kernelArguments,[],a);if(e)return e;const r=Pe(t,I.kernelConstants,f?Object.keys(f).map(t=>f[t]):[],a);return r||null}});let o=!1,u=0;const{source:h,canvas:l,output:c,pipeline:p,graphical:d,loopMaxIterations:m,constants:f,optimizeFloatMemory:g,precision:x,fixIntegerDivisionAccuracy:y,functions:T,nativeFunctions:b,subKernels:A,immutable:S,argumentTypes:E,constantTypes:_,kernelArguments:v,kernelConstants:w}=r,I=new t(h,{canvas:l,context:a,checkContext:!1,output:c,pipeline:p,graphical:d,loopMaxIterations:m,constants:f,optimizeFloatMemory:g,precision:x,fixIntegerDivisionAccuracy:y,functions:T,nativeFunctions:b,subKernels:A,immutable:S,argumentTypes:E,constantTypes:_});let D=[];if(a.setIndent(2),I.build.apply(I,e),D.push(a.toString()),a.reset(),I.kernelArguments.forEach((t,r)=>{switch(t.type){case"Integer":case"Boolean":case"Number":case"Float":case"Array":case"Array(2)":case"Array(3)":case"Array(4)":case"HTMLImage":case"HTMLVideo":a.insertVariable(`uploadValue_${t.name}`,t.uploadValue);break;case"HTMLImageArray":for(let n=0;n<e[r].length;n++){const i=e[r];a.insertVariable(`uploadValue_${t.name}[${n}]`,i[n])}break;case"Input":a.insertVariable(`uploadValue_${t.name}`,t.uploadValue);break;case"MemoryOptimizedNumberTexture":case"NumberTexture":case"Array1D(2)":case"Array1D(3)":case"Array1D(4)":case"Array2D(2)":case"Array2D(3)":case"Array2D(4)":case"Array3D(2)":case"Array3D(3)":case"Array3D(4)":case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":a.insertVariable(`uploadValue_${t.name}`,e[r].texture);break;default:throw new Error(`unhandled kernelArgumentType insertion for glWiretap of type ${t.type}`)}}),D.push("/** start of injected functions **/"),D.push(`function ${Ce(Ht.flattenTo)}`),D.push(`function ${Ce(Ht.flatten2dArrayTo)}`),D.push(`function ${Ce(Ht.flatten3dArrayTo)}`),D.push(`function ${Ce(Ht.flatten4dArrayTo)}`),D.push(`function ${Ce(Ht.isArray)}`),I.renderOutput!==I.renderTexture&&I.formatValues&&D.push(`  const renderOutput = function ${Ce(I.formatValues)};`),D.push("/** end of injected functions **/"),D.push(`  const innerKernel = function (${I.kernelArguments.map(t=>t.varName).join(", ")}) {`),a.setIndent(4),I.run.apply(I,e),I.renderKernels?I.renderKernels():I.renderOutput&&I.renderOutput(),D.push("    /** start setup uploads for kernel values **/"),I.kernelArguments.forEach(t=>{D.push("    "+t.getStringValueHandler().split("\n").join("\n    "))}),D.push("    /** end setup uploads for kernel values **/"),D.push(a.toString()),I.renderOutput===I.renderTexture){a.reset();const t=I.renderKernels(),e=a.getContextVariableName(I.outputTexture);D.push(`    return {\n      result: {\n        texture: ${e},\n        type: '${t.result.type}',\n        toArray: ${Oe(t.result,e)}\n      },`);const{subKernels:r,subKernelOutputTextures:n}=I;for(let e=0;e<r.length;e++){const i=n[e],s=r[e],o=t[s.property],u=a.getContextVariableName(i);D.push(`\n      ${s.property}: {\n        texture: ${u},\n        type: '${o.type}',\n        toArray: ${Oe(o,u)}\n      },`)}D.push("    };")}D.push(`    ${i?"\n"+i+"    ":""}`),D.push(s.join("\n")),D.push("  };"),I.graphical&&(D.push(function(t){const e=t.getPixels.toString(),r=!/^function/.test(e);return Ht.flattenFunctionToString(`${r?"function ":""}${e}`,{findDependency:(t,e)=>"utils"===t?`const ${e} = ${Ht[e].toString()};`:null,thisLookup:e=>{if("context"===e)return null;if(t.hasOwnProperty(e))return JSON.stringify(t[e]);throw new Error(`unhandled thisLookup ${e}`)}})}(I)),D.push("  innerKernel.getPixels = getPixels;")),D.push("  return innerKernel;");let R=[];return w.forEach(t=>{R.push(`${t.getStringValueHandler()}`)}),`function kernel(settings) {\n  const { context, constants } = settings;\n  ${R.join("")}\n  ${n||""}\n${D.join("\n")}\n}`}function Ne(t,e){const r="single"===e.precision?t:`new Float32Array(${t}.buffer)`;return e.output[2]?`renderOutput(${r}, ${e.output[0]}, ${e.output[1]}, ${e.output[2]})`:e.output[1]?`renderOutput(${r}, ${e.output[0]}, ${e.output[1]})`:`renderOutput(${r}, ${e.output[0]})`}function Oe(t,e){const r=t.toArray.toString(),n=!/^function/.test(r);return`() => {\n  ${Ht.flattenFunctionToString(`${n?"function ":""}${r}`,{findDependency:(e,r)=>{if("utils"===e)return`const ${r} = ${Ht[r].toString()};`;if("this"===e)return`${n?"function ":""}${t[r].toString()}`;throw new Error("unhandled fromObject")},thisLookup:r=>{if("texture"===r)return e;if(t.hasOwnProperty(r))return JSON.stringify(t[r]);throw new Error(`unhandled thisLookup ${r}`)}})}\n  return toArray();\n  }`}function Pe(t,e,r,n,i){if(null===t)return null;switch(typeof t){case"boolean":case"number":return null}if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement){for(let i=0;i<e.length;i++){const s=e[i];if("HTMLImageArray"!==s.type)continue;if(s.uploadValue!==t)continue;const a=r[i].indexOf(t);if(-1===a)continue;const o=`uploadValue_${s.name}[${a}]`;return n.insertVariable(o,t),o}return null}for(let r=0;r<e.length;r++){const i=e[r];if(t!==i.uploadValue)continue;const s=`uploadValue_${i.name}`;return n.insertVariable(s,i),s}return null}class ze{constructor(t,e){const{name:r,kernel:n,context:i,checkContext:s,onRequestContextHandle:a,onUpdateValueMismatch:o,origin:u,strictIntegers:h,type:l,tactic:c}=e;if(!r)throw new Error("name not set");if(!l)throw new Error("type not set");if(!u)throw new Error("origin not set");if(!c)throw new Error("tactic not set");if("user"!==u&&"constants"!==u)throw new Error(`origin must be "user" or "constants" value is "${u}"`);if(!a)throw new Error("onRequestContextHandle is not set");this.name=r,this.origin=u,this.tactic=c,this.id=`${this.origin}_${r}`,this.varName="constants"===u?`constants.${r}`:r,this.kernel=n,this.strictIntegers=h,this.type=t.type||l,this.size=t.size||null,this.index=null,this.context=i,this.checkContext=null==s||s,this.contextHandle=null,this.onRequestContextHandle=a,this.onUpdateValueMismatch=o,this.forceUploadEachRun=null}getSource(){throw new Error(`"getSource" not defined on ${this.constructor.name}`)}updateValue(t){throw new Error(`"updateValue" not defined on ${this.constructor.name}`)}}class Le extends ze{constructor(t,e){super(t,e),this.dimensionsId=null,this.sizeId=null,this.initialValueConstructor=t.constructor,this.onRequestTexture=e.onRequestTexture,this.onRequestIndex=e.onRequestIndex,this.uploadValue=null,this.textureSize=null,this.bitRatio=null}checkSize(t,e){if(!this.kernel.validate)return;const{maxTextureSize:r}=this.kernel.constructor.features;if(t>r||e>r)throw t>e?new Error(`Argument width of ${t} larger than maximum size of ${r} for your GPU`):new Error(`Argument height of ${e} larger than maximum size of ${r} for your GPU`)}requestTexture(){this.texture=this.onRequestTexture(),this.setupTexture()}setupTexture(){this.contextHandle=this.onRequestContextHandle(),this.index=this.onRequestIndex(),this.dimensionsId=this.id+"Dim",this.sizeId=this.id+"Size"}getTransferArrayType(t){if(Array.isArray(t[0]))return this.getTransferArrayType(t[0]);switch(t.constructor){case Array:case Int32Array:case Int16Array:case Int8Array:return Float32Array;case Uint8ClampedArray:case Uint8Array:case Uint16Array:case Uint32Array:case Float32Array:case Float64Array:return t.constructor}return console.warn("Unfamiliar constructor type.  Will go ahead and use, but likley this may result in a transfer of zeros"),t.constructor}formatArrayTransfer(t,e,r){if(Ht.isArray(t[0])||this.optimizeFloatMemory){const r=new Float32Array(e);return Ht.flattenTo(t,r),r}switch(t.constructor){case Uint8ClampedArray:case Uint8Array:case Int8Array:case Uint16Array:case Int16Array:case Float32Array:case Int32Array:{const n=new(r||t.constructor)(e);return Ht.flattenTo(t,n),n}default:{const r=new Float32Array(e);return Ht.flattenTo(t,r),r}}}getBitRatio(t){if(Array.isArray(t[0]))return this.getBitRatio(t[0]);if(t.constructor===E)return this.getBitRatio(t.value);switch(t.constructor){case Uint8ClampedArray:case Uint8Array:case Int8Array:return 1;case Uint16Array:case Int16Array:return 2;case Float32Array:case Int32Array:default:return 4}}getStringValueHandler(){throw new Error(`"getStringValueHandler" not implemented on ${this.constructor.name}`)}getVariablePrecisionString(){switch(this.tactic){case"speed":return"lowp";case"performance":return"highp";case"balanced":default:return"mediump"}}}class Me extends Le{constructor(t,e){super(t,e),this.uploadValue=t}getSource(t){return"constants"===this.origin?`const bool ${this.id} = ${t};\n`:`uniform bool ${this.id};\n`}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName};\n`}updateValue(t){"constants"!==this.origin&&this.kernel.setUniform1i(this.id,this.uploadValue=t)}}class Ve extends Le{constructor(t,e){super(t,e),this.uploadValue=t}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName};\n`}getSource(t){return"constants"===this.origin?Number.isInteger(t)?`const float ${this.id} = ${t}.0;\n`:`const float ${this.id} = ${t};\n`:`uniform float ${this.id};\n`}updateValue(t){"constants"!==this.origin&&this.kernel.setUniform1f(this.id,this.uploadValue=t)}}class Ue extends Le{constructor(t,e){super(t,e),this.uploadValue=t}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName};\n`}getSource(t){return"constants"===this.origin?`const int ${this.id} = ${parseInt(t)};\n`:`uniform int ${this.id};\n`}updateValue(t){"constants"!==this.origin&&this.kernel.setUniform1i(this.id,this.uploadValue=t)}}class Ke extends Le{constructor(t,e){super(t,e);const{width:r,height:n}=t;this.checkSize(r,n),this.dimensions=[r,n,1],this.requestTexture(),this.textureSize=[r,n],this.uploadValue=t}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName};\n`}getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.uploadValue=t),this.kernel.setUniform1i(this.id,this.index)}}class Be extends Ke{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(t){const{width:e,height:r}=t;this.checkSize(e,r),this.dimensions=[e,r,1],this.textureSize=[e,r],this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class Ge extends Ke{}class je extends Be{}class Xe extends Le{constructor(t,e){super(t,e),this.requestTexture(),this.bitRatio=4;let[r,n,i]=t.size;this.dimensions=new Int32Array([r||1,n||1,i||1]),this.textureSize=Ht.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0]*this.bitRatio,this.textureSize[1]*this.bitRatio),this.uploadValue=new Float32Array(this.uploadArrayLength)}getStringValueHandler(){return Ht.linesToString([`const uploadValue_${this.name} = new Float32Array(${this.uploadArrayLength})`,`flattenTo(${this.varName}.value, uploadValue_${this.name})`])}getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flattenTo(t.value,this.uploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class He extends Le{constructor(t,e){super(t,e),this.requestTexture(),this.bitRatio=this.getBitRatio(t);const[r,n,i]=t.size;this.dimensions=new Int32Array([r||1,n||1,i||1]),this.textureSize=Ht.getMemoryOptimizedPackedTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*(4/this.bitRatio),this.checkSize(this.textureSize[0]*(4/this.bitRatio),this.textureSize[1]*(4/this.bitRatio)),this.TranserArrayType=this.getTransferArrayType(t.value),this.preUploadValue=new this.TranserArrayType(this.uploadArrayLength),this.uploadValue=new Uint8Array(this.preUploadValue.buffer)}getStringValueHandler(){return Ht.linesToString([`const preUploadValue_${this.name} = new ${this.TranserArrayType.name}(${this.uploadArrayLength})`,`const uploadValue_${this.name} = new Uint8Array(preUploadValue_${this.name}.buffer)`,`flattenTo(${this.varName}.value, preUploadValue_${this.name})`])}getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flattenTo(t.value,this.preUploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.UNSIGNED_BYTE,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class We extends He{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(t){let[e,r,n]=t.size;this.dimensions=new Int32Array([e||1,r||1,n||1]),this.textureSize=Ht.getMemoryOptimizedPackedTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*(4/this.bitRatio),this.checkSize(this.textureSize[0]*(4/this.bitRatio),this.textureSize[1]*(4/this.bitRatio));const i=this.getTransferArrayType(t.value);this.preUploadValue=new i(this.uploadArrayLength),this.uploadValue=new Uint8Array(this.preUploadValue.buffer),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class qe extends Le{constructor(t,e){super(t,e);const[r,n]=t.size;this.checkSize(r,n),this.setupTexture(),this.dimensions=t.dimensions,this.textureSize=t.size,this.uploadValue=t.texture,this.forceUploadEachRun=!0}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName}.texture;\n`}getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();if(this.checkContext&&t.context!==this.context)throw new Error(`Value ${this.name} (${this.type}) must be from same context`);const{context:e}=this;e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.uploadValue=t.texture),this.kernel.setUniform1i(this.id,this.index)}}class Ye extends qe{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(t){this.checkSize(t.size[0],t.size[1]),this.dimensions=t.dimensions,this.textureSize=t.size,this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class Ze extends Le{constructor(t,e){super(t,e);const[r,n]=t.size;this.checkSize(r,n),this.setupTexture();const{size:i,dimensions:s}=t;this.bitRatio=this.getBitRatio(t),this.dimensions=s,this.textureSize=i,this.uploadValue=t.texture,this.forceUploadEachRun=!0}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName}.texture;\n`}getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();if(this.checkContext&&t.context!==this.context)throw new Error(`Value ${this.name} (${this.type}) must be from same context`);const{context:e}=this;e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.uploadValue=t.texture),this.kernel.setUniform1i(this.id,this.index)}}class Je extends Ze{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(t){this.dimensions=t.dimensions,this.checkSize(t.size[0],t.size[1]),this.textureSize=t.size,this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class Qe extends Le{constructor(t,e){super(t,e),this.requestTexture(),this.bitRatio=4,this.dimensions=Ht.getDimensions(t,!0),this.textureSize=Ht.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0]*this.bitRatio,this.textureSize[1]*this.bitRatio),this.uploadValue=new Float32Array(this.uploadArrayLength)}getStringValueHandler(){return Ht.linesToString([`const uploadValue_${this.name} = new Float32Array(${this.uploadArrayLength})`,`flattenTo(${this.varName}, uploadValue_${this.name})`])}getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flattenTo(t,this.uploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class tr extends Le{constructor(t,e){super(t,e),this.requestTexture(),this.bitRatio=4,this.setShape(t)}setShape(t){const e=Ht.getDimensions(t,!0);this.textureSize=Ht.getMemoryOptimizedFloatTextureSize(e,this.bitRatio),this.dimensions=new Int32Array([e[1],1,1]),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0]*this.bitRatio,this.textureSize[1]*this.bitRatio),this.uploadValue=new Float32Array(this.uploadArrayLength)}getStringValueHandler(){return Ht.linesToString([`const uploadValue_${this.name} = new Float32Array(${this.uploadArrayLength})`,`flattenTo(${this.varName}, uploadValue_${this.name})`])}getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flatten2dArrayTo(t,this.uploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class er extends tr{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(t){this.setShape(t),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class rr extends Le{constructor(t,e){super(t,e),this.requestTexture(),this.bitRatio=4,this.setShape(t)}setShape(t){const e=Ht.getDimensions(t,!0);this.textureSize=Ht.getMemoryOptimizedFloatTextureSize(e,this.bitRatio),this.dimensions=new Int32Array([e[1],e[2],1]),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0]*this.bitRatio,this.textureSize[1]*this.bitRatio),this.uploadValue=new Float32Array(this.uploadArrayLength)}getStringValueHandler(){return Ht.linesToString([`const uploadValue_${this.name} = new Float32Array(${this.uploadArrayLength})`,`flattenTo(${this.varName}, uploadValue_${this.name})`])}getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flatten3dArrayTo(t,this.uploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class nr extends rr{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(t){this.setShape(t),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class ir extends Le{constructor(t,e){super(t,e),this.requestTexture(),this.bitRatio=4,this.setShape(t)}setShape(t){const e=Ht.getDimensions(t,!0);this.textureSize=Ht.getMemoryOptimizedFloatTextureSize(e,this.bitRatio),this.dimensions=new Int32Array([e[1],e[2],e[3]]),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0]*this.bitRatio,this.textureSize[1]*this.bitRatio),this.uploadValue=new Float32Array(this.uploadArrayLength)}getStringValueHandler(){return Ht.linesToString([`const uploadValue_${this.name} = new Float32Array(${this.uploadArrayLength})`,`flattenTo(${this.varName}, uploadValue_${this.name})`])}getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flatten4dArrayTo(t,this.uploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class sr extends ir{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(t){this.setShape(t),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class ar extends Le{constructor(t,e){super(t,e),this.uploadValue=t}getSource(t){return"constants"===this.origin?`const vec2 ${this.id} = vec2(${t[0]},${t[1]});\n`:`uniform vec2 ${this.id};\n`}getStringValueHandler(){return"constants"===this.origin?"":`const uploadValue_${this.name} = ${this.varName};\n`}updateValue(t){"constants"!==this.origin&&this.kernel.setUniform2fv(this.id,this.uploadValue=t)}}class or extends Le{constructor(t,e){super(t,e),this.uploadValue=t}getSource(t){return"constants"===this.origin?`const vec3 ${this.id} = vec3(${t[0]},${t[1]},${t[2]});\n`:`uniform vec3 ${this.id};\n`}getStringValueHandler(){return"constants"===this.origin?"":`const uploadValue_${this.name} = ${this.varName};\n`}updateValue(t){"constants"!==this.origin&&this.kernel.setUniform3fv(this.id,this.uploadValue=t)}}class ur extends Le{constructor(t,e){super(t,e),this.uploadValue=t}getSource(t){return"constants"===this.origin?`const vec4 ${this.id} = vec4(${t[0]},${t[1]},${t[2]},${t[3]});\n`:`uniform vec4 ${this.id};\n`}getStringValueHandler(){return"constants"===this.origin?"":`const uploadValue_${this.name} = ${this.varName};\n`}updateValue(t){"constants"!==this.origin&&this.kernel.setUniform4fv(this.id,this.uploadValue=t)}}class hr extends Le{constructor(t,e){super(t,e),this.requestTexture(),this.bitRatio=this.getBitRatio(t),this.dimensions=Ht.getDimensions(t,!0),this.textureSize=Ht.getMemoryOptimizedPackedTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*(4/this.bitRatio),this.checkSize(this.textureSize[0]*(4/this.bitRatio),this.textureSize[1]*(4/this.bitRatio)),this.TranserArrayType=this.getTransferArrayType(t),this.preUploadValue=new this.TranserArrayType(this.uploadArrayLength),this.uploadValue=new Uint8Array(this.preUploadValue.buffer)}getStringValueHandler(){return Ht.linesToString([`const preUploadValue_${this.name} = new ${this.TranserArrayType.name}(${this.uploadArrayLength})`,`const uploadValue_${this.name} = new Uint8Array(preUploadValue_${this.name}.buffer)`,`flattenTo(${this.varName}, preUploadValue_${this.name})`])}getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flattenTo(t,this.preUploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.UNSIGNED_BYTE,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class lr extends hr{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(t){this.dimensions=Ht.getDimensions(t,!0),this.textureSize=Ht.getMemoryOptimizedPackedTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*(4/this.bitRatio),this.checkSize(this.textureSize[0]*(4/this.bitRatio),this.textureSize[1]*(4/this.bitRatio));const e=this.getTransferArrayType(t);this.preUploadValue=new e(this.uploadArrayLength),this.uploadValue=new Uint8Array(this.preUploadValue.buffer),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}const cr={unsigned:{dynamic:{Boolean:Me,Integer:Ue,Float:Ve,Array:lr,"Array(2)":!1,"Array(3)":!1,"Array(4)":!1,"Array1D(2)":!1,"Array1D(3)":!1,"Array1D(4)":!1,"Array2D(2)":!1,"Array2D(3)":!1,"Array2D(4)":!1,"Array3D(2)":!1,"Array3D(3)":!1,"Array3D(4)":!1,Input:We,NumberTexture:Je,"ArrayTexture(1)":Je,"ArrayTexture(2)":Je,"ArrayTexture(3)":Je,"ArrayTexture(4)":Je,MemoryOptimizedNumberTexture:qe,HTMLImage:Be,HTMLImageArray:!1,HTMLVideo:je},static:{Boolean:Me,Float:Ve,Integer:Ue,Array:hr,"Array(2)":!1,"Array(3)":!1,"Array(4)":!1,"Array1D(2)":!1,"Array1D(3)":!1,"Array1D(4)":!1,"Array2D(2)":!1,"Array2D(3)":!1,"Array2D(4)":!1,"Array3D(2)":!1,"Array3D(3)":!1,"Array3D(4)":!1,Input:He,NumberTexture:Ze,"ArrayTexture(1)":Ze,"ArrayTexture(2)":Ze,"ArrayTexture(3)":Ze,"ArrayTexture(4)":Ze,MemoryOptimizedNumberTexture:Ye,HTMLImage:Ke,HTMLImageArray:!1,HTMLVideo:Ge}},single:{dynamic:{Boolean:Me,Integer:Ue,Float:Ve,Array:class extends Qe{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(t){this.dimensions=Ht.getDimensions(t,!0),this.textureSize=Ht.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0]*this.bitRatio,this.textureSize[1]*this.bitRatio),this.uploadValue=new Float32Array(this.uploadArrayLength),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}},"Array(2)":ar,"Array(3)":or,"Array(4)":ur,"Array1D(2)":er,"Array1D(3)":er,"Array1D(4)":er,"Array2D(2)":nr,"Array2D(3)":nr,"Array2D(4)":nr,"Array3D(2)":sr,"Array3D(3)":sr,"Array3D(4)":sr,Input:class extends Xe{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}updateValue(t){let[e,r,n]=t.size;this.dimensions=new Int32Array([e||1,r||1,n||1]),this.textureSize=Ht.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0]*this.bitRatio,this.textureSize[1]*this.bitRatio),this.uploadValue=new Float32Array(this.uploadArrayLength),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}},NumberTexture:Je,"ArrayTexture(1)":Je,"ArrayTexture(2)":Je,"ArrayTexture(3)":Je,"ArrayTexture(4)":Je,MemoryOptimizedNumberTexture:Ye,HTMLImage:Be,HTMLImageArray:!1,HTMLVideo:je},static:{Boolean:Me,Float:Ve,Integer:Ue,Array:Qe,"Array(2)":ar,"Array(3)":or,"Array(4)":ur,"Array1D(2)":tr,"Array1D(3)":tr,"Array1D(4)":tr,"Array2D(2)":rr,"Array2D(3)":rr,"Array2D(4)":rr,"Array3D(2)":ir,"Array3D(3)":ir,"Array3D(4)":ir,Input:Xe,NumberTexture:Ze,"ArrayTexture(1)":Ze,"ArrayTexture(2)":Ze,"ArrayTexture(3)":Ze,"ArrayTexture(4)":Ze,MemoryOptimizedNumberTexture:qe,HTMLImage:Ke,HTMLImageArray:!1,HTMLVideo:Ge}}};let pr=null,dr=null,mr=null,fr=null,gr=null;const xr=[Ie],yr=[],Tr={};class br extends Ae{static get isSupported(){return null!==pr?pr:(this.setupFeatureChecks(),pr=this.isContextMatch(mr))}static setupFeatureChecks(){"undefined"!=typeof document?dr=document.createElement("canvas"):"undefined"!=typeof OffscreenCanvas&&(dr=new OffscreenCanvas(0,0)),dr&&(mr=dr.getContext("webgl")||dr.getContext("experimental-webgl"))&&mr.getExtension&&(fr={OES_texture_float:mr.getExtension("OES_texture_float"),OES_texture_float_linear:mr.getExtension("OES_texture_float_linear"),OES_element_index_uint:mr.getExtension("OES_element_index_uint"),WEBGL_draw_buffers:mr.getExtension("WEBGL_draw_buffers")},gr=this.getFeatures())}static isContextMatch(t){return"undefined"!=typeof WebGLRenderingContext&&t instanceof WebGLRenderingContext}static getFeatures(){const t=this.getIsDrawBuffers();return Object.freeze({isFloatRead:this.getIsFloatRead(),isIntegerDivisionAccurate:this.getIsIntegerDivisionAccurate(),isTextureFloat:this.getIsTextureFloat(),isDrawBuffers:t,kernelMap:t,channelCount:this.getChannelCount()})}static getIsTextureFloat(){return Boolean(fr.OES_texture_float)}static getIsDrawBuffers(){return Boolean(fr.WEBGL_draw_buffers)}static getChannelCount(){return fr.WEBGL_draw_buffers?mr.getParameter(fr.WEBGL_draw_buffers.MAX_DRAW_BUFFERS_WEBGL):1}static lookupKernelValueType(t,e,r,n){return function(t,e,r,n){if(!t)throw new Error("type missing");if(!e)throw new Error("dynamic missing");if(!r)throw new Error("precision missing");n.type&&(t=n.type);const i=cr[r][e];if(!1===i[t])return null;if(void 0===i[t])throw new Error(`Could not find a KernelValue for ${t}`);return i[t]}(t,e,r,n)}static get testCanvas(){return dr}static get testContext(){return mr}static get features(){return gr}static get fragmentShader(){return De}static get vertexShader(){return Re}constructor(t,e){super(t,e),this.program=null,this.pipeline=e.pipeline,this.endianness=Ht.systemEndianness(),this.extensions={},this.subKernelOutputTextures=null,this.kernelArguments=null,this.argumentTextureCount=0,this.constantTextureCount=0,this.compiledFragmentShader=null,this.compiledVertexShader=null,this.fragShader=null,this.vertShader=null,this.drawBuffersMap=null,this.outputTexture=null,this.maxTexSize=null,this.switchingKernels=!1,this.onRequestSwitchKernel=null,this.mergeSettings(t.settings||e),this.threadDim=null,this.framebuffer=null,this.buffer=null,this.textureCache={},this.programUniformLocationCache={},this.uniform1fCache={},this.uniform1iCache={},this.uniform2fCache={},this.uniform2fvCache={},this.uniform2ivCache={},this.uniform3fvCache={},this.uniform3ivCache={},this.uniform4fvCache={},this.uniform4ivCache={}}initCanvas(){if("undefined"!=typeof document){const t=document.createElement("canvas");return t.width=2,t.height=2,t}if("undefined"!=typeof OffscreenCanvas)return new OffscreenCanvas(0,0)}initContext(){const t={alpha:!1,depth:!1,antialias:!1};return this.canvas.getContext("webgl",t)||this.canvas.getContext("experimental-webgl",t)}initPlugins(t){const e=[],{source:r}=this;if("string"==typeof r)for(let t=0;t<xr.length;t++){const n=xr[t];r.match(n.functionMatch)&&e.push(n)}else if("object"==typeof r&&t.pluginNames)for(let r=0;r<xr.length;r++){const n=xr[r];t.pluginNames.some(t=>t===n.name)&&e.push(n)}return e}initExtensions(){this.extensions={OES_texture_float:this.context.getExtension("OES_texture_float"),OES_texture_float_linear:this.context.getExtension("OES_texture_float_linear"),OES_element_index_uint:this.context.getExtension("OES_element_index_uint"),WEBGL_draw_buffers:this.context.getExtension("WEBGL_draw_buffers"),WEBGL_color_buffer_float:this.context.getExtension("WEBGL_color_buffer_float")}}validateSettings(t){if(!this.validate)return void(this.texSize=Ht.getKernelTextureSize({optimizeFloatMemory:this.optimizeFloatMemory,precision:this.precision},this.output));const{features:e}=this.constructor;if(!0===this.optimizeFloatMemory&&!e.isTextureFloat)throw new Error("Float textures are not supported");if("single"===this.precision&&!e.isFloatRead)throw new Error("Single precision not supported");if(!this.graphical&&null===this.precision&&e.isTextureFloat&&(this.precision=e.isFloatRead?"single":"unsigned"),this.subKernels&&this.subKernels.length>0&&!this.extensions.WEBGL_draw_buffers)throw new Error("could not instantiate draw buffers extension");if(null===this.fixIntegerDivisionAccuracy?this.fixIntegerDivisionAccuracy=!e.isIntegerDivisionAccurate:this.fixIntegerDivisionAccuracy&&e.isIntegerDivisionAccurate&&(this.fixIntegerDivisionAccuracy=!1),this.checkOutput(),!this.output||0===this.output.length){if(1!==t.length)throw new Error("Auto output only supported for kernels with only one input");const e=Ht.getVariableType(t[0],this.strictIntegers);if("Array"===e)this.output=Ht.getDimensions(e);else{if("NumberTexture"!==e&&"ArrayTexture(4)"!==e)throw new Error("Auto output not supported for input type: "+e);this.output=t[0].output}}if(this.graphical){if(2!==this.output.length)throw new Error("Output must have 2 dimensions on graphical mode");return"precision"===this.precision&&(this.precision="unsigned",console.warn("Cannot use graphical mode and single precision at the same time")),void(this.texSize=Ht.clone(this.output))}null===this.precision&&e.isTextureFloat&&(this.precision="single"),this.texSize=Ht.getKernelTextureSize({optimizeFloatMemory:this.optimizeFloatMemory,precision:this.precision},this.output),this.checkTextureSize()}updateMaxTexSize(){const{texSize:t,canvas:e}=this;if(null===this.maxTexSize){let r=yr.indexOf(e);-1===r&&(r=yr.length,yr.push(e),Tr[r]=[t[0],t[1]]),this.maxTexSize=Tr[r]}this.maxTexSize[0]<t[0]&&(this.maxTexSize[0]=t[0]),this.maxTexSize[1]<t[1]&&(this.maxTexSize[1]=t[1])}_oldtranslateSource(){const t=qt.fromKernel(this,_e,{fixIntegerDivisionAccuracy:this.fixIntegerDivisionAccuracy}),e=t.getPrototypeString("kernel");this.returnType||(this.returnType=t.getKernelResultType());let r=0;const n=t.getReturnTypes();for(let t=0;t<n.length;t++)switch(n[t]){case"Float":case"Number":case"Integer":r++;break;case"Array(2)":r+=2;break;case"Array(3)":r+=3;break;case"Array(4)":r+=4}if(gr&&r>gr.channelCount)throw new Error("Too many channels!");return this.translatedSource=e}setupArguments(t){this.kernelArguments=[],this.argumentTextureCount=0;const e=null===this.argumentTypes;if(e&&(this.argumentTypes=[]),this.argumentSizes=[],this.argumentBitRatios=[],t.length<this.argumentNames.length)throw new Error("not enough arguments for kernel");if(t.length>this.argumentNames.length)throw new Error("too many arguments for kernel");const{context:r}=this;let n=0;for(let i=0;i<t.length;i++){const s=t[i],a=this.argumentNames[i];let o;e?(o=Ht.getVariableType(s,this.strictIntegers),this.argumentTypes.push(o)):o=this.argumentTypes[i];const u=this.constructor.lookupKernelValueType(o,this.dynamicArguments?"dynamic":"static",this.precision,t[i]);if(null===u)return this.requestFallback(t);const h=new u(s,{name:a,type:o,tactic:this.tactic,origin:"user",context:r,checkContext:this.checkContext,kernel:this,strictIntegers:this.strictIntegers,onRequestTexture:()=>this.context.createTexture(),onRequestIndex:()=>n++,onUpdateValueMismatch:()=>{this.switchingKernels=!0},onRequestContextHandle:()=>r.TEXTURE0+this.constantTextureCount+this.argumentTextureCount++});this.kernelArguments.push(h),this.argumentSizes.push(h.textureSize),this.argumentBitRatios[i]=h.bitRatio}}setupConstants(t){const{context:e}=this;this.kernelConstants=[],this.forceUploadKernelConstants=[];let r=null===this.constantTypes;r&&(this.constantTypes={}),this.constantBitRatios={};let n=0;for(const i in this.constants){const s=this.constants[i];let a;r?(a=Ht.getVariableType(s,this.strictIntegers),this.constantTypes[i]=a):a=this.constantTypes[i];const o=this.constructor.lookupKernelValueType(a,"static",this.precision,s);if(null===o)return this.requestFallback(t);const u=new o(s,{name:i,type:a,tactic:this.tactic,origin:"constants",context:this.context,checkContext:this.checkContext,kernel:this,strictIntegers:this.strictIntegers,onRequestTexture:()=>this.context.createTexture(),onRequestIndex:()=>n++,onRequestContextHandle:()=>e.TEXTURE0+this.constantTextureCount++});this.constantBitRatios[i]=u.bitRatio,this.kernelConstants.push(u),u.forceUploadEachRun&&this.forceUploadKernelConstants.push(u)}}build(){if(this.initExtensions(),this.validateSettings(arguments),this.setupConstants(arguments),this.fallbackRequested)return;if(this.setupArguments(arguments),this.fallbackRequested)return;this.updateMaxTexSize(),this.translateSource();const t=this.pickRenderStrategy(arguments);if(t)return t;const{texSize:e,context:r,canvas:n}=this;r.enable(r.SCISSOR_TEST),this.pipeline&&this.precision,r.viewport(0,0,this.maxTexSize[0],this.maxTexSize[1]),n.width=this.maxTexSize[0],n.height=this.maxTexSize[1];const i=this.threadDim=Array.from(this.output);for(;i.length<3;)i.push(1);const s=this.getVertexShader(arguments),a=r.createShader(r.VERTEX_SHADER);r.shaderSource(a,s),r.compileShader(a),this.vertShader=a;const o=this.getFragmentShader(arguments),u=r.createShader(r.FRAGMENT_SHADER);if(r.shaderSource(u,o),r.compileShader(u),this.fragShader=u,this.debug&&(console.log("GLSL Shader Output:"),console.log(o)),!r.getShaderParameter(a,r.COMPILE_STATUS))throw new Error("Error compiling vertex shader: "+r.getShaderInfoLog(a));if(!r.getShaderParameter(u,r.COMPILE_STATUS))throw new Error("Error compiling fragment shader: "+r.getShaderInfoLog(u));const h=this.program=r.createProgram();r.attachShader(h,a),r.attachShader(h,u),r.linkProgram(h),this.framebuffer=r.createFramebuffer(),this.framebuffer.width=e[0],this.framebuffer.height=e[1];const l=new Float32Array([-1,-1,1,-1,-1,1,1,1]),c=new Float32Array([0,0,1,0,0,1,1,1]),p=l.byteLength;let d=this.buffer;d?r.bindBuffer(r.ARRAY_BUFFER,d):(d=this.buffer=r.createBuffer(),r.bindBuffer(r.ARRAY_BUFFER,d),r.bufferData(r.ARRAY_BUFFER,l.byteLength+c.byteLength,r.STATIC_DRAW)),r.bufferSubData(r.ARRAY_BUFFER,0,l),r.bufferSubData(r.ARRAY_BUFFER,p,c);const m=r.getAttribLocation(this.program,"aPos");r.enableVertexAttribArray(m),r.vertexAttribPointer(m,2,r.FLOAT,!1,0,0);const f=r.getAttribLocation(this.program,"aTexCoord");r.enableVertexAttribArray(f),r.vertexAttribPointer(f,2,r.FLOAT,!1,0,p),r.bindFramebuffer(r.FRAMEBUFFER,this.framebuffer);let g=0;r.useProgram(this.program);for(let t in this.constants)this.kernelConstants[g++].updateValue(this.constants[t]);this.immutable||(this._setupOutputTexture(),null!==this.subKernels&&this.subKernels.length>0&&this._setupSubOutputTextures())}translateSource(){const t=qt.fromKernel(this,_e,{fixIntegerDivisionAccuracy:this.fixIntegerDivisionAccuracy});if(this.translatedSource=t.getPrototypeString("kernel"),this.graphical||this.returnType||(this.returnType=t.getKernelResultType()),this.subKernels&&this.subKernels.length>0)for(let e=0;e<this.subKernels.length;e++){const r=this.subKernels[e];r.returnType||(r.returnType=t.getSubKernelResultType(e))}}run(){const{kernelArguments:t,forceUploadKernelConstants:e}=this,r=this.texSize,n=this.context;n.useProgram(this.program),n.scissor(0,0,r[0],r[1]),this.dynamicOutput&&(this.setUniform3iv("uOutputDim",new Int32Array(this.threadDim)),this.setUniform2iv("uTexSize",r)),this.setUniform2f("ratio",r[0]/this.maxTexSize[0],r[1]/this.maxTexSize[1]),this.switchingKernels=!1;for(let t=0;t<e.length;t++){const r=e[t];if(r.updateValue(this.constants[r.name]),this.switchingKernels)return}for(let e=0;e<t.length;e++)if(t[e].updateValue(arguments[e]),this.switchingKernels)return;if(this.plugins)for(let t=0;t<this.plugins.length;t++){const e=this.plugins[t];e.onBeforeRun&&e.onBeforeRun(this)}if(this.graphical)return this.pipeline?(n.bindRenderbuffer(n.RENDERBUFFER,null),n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer),this.outputTexture&&!this.immutable||this._setupOutputTexture(),n.drawArrays(n.TRIANGLE_STRIP,0,4),new this.TextureConstructor({texture:this.outputTexture,size:r,dimensions:this.threadDim,output:this.output,context:this.context})):(n.bindRenderbuffer(n.RENDERBUFFER,null),n.bindFramebuffer(n.FRAMEBUFFER,null),void n.drawArrays(n.TRIANGLE_STRIP,0,4));n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer),this.immutable&&this._setupOutputTexture(),null!==this.subKernels&&(this.immutable&&this._setupSubOutputTextures(),this.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(this.drawBuffersMap)),n.drawArrays(n.TRIANGLE_STRIP,0,4)}getOutputTexture(){return this.outputTexture}_setupOutputTexture(){const t=this.context,e=this.texSize,r=this.outputTexture=this.context.createTexture();if(t.activeTexture(t.TEXTURE0+this.constantTextureCount+this.argumentTextureCount),t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),"single"===this.precision)if(this.pipeline)switch(this.returnType){case"Number":case"Float":case"Integer":this.optimizeFloatMemory,t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e[0],e[1],0,t.RGBA,t.FLOAT,null);break;case"Array(2)":case"Array(3)":case"Array(4)":t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e[0],e[1],0,t.RGBA,t.FLOAT,null);break;default:if(!this.graphical)throw new Error("Unhandled return type")}else t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e[0],e[1],0,t.RGBA,t.FLOAT,null);else t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e[0],e[1],0,t.RGBA,t.UNSIGNED_BYTE,null);t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r,0)}_setupSubOutputTextures(){const t=this.context,e=this.texSize;this.drawBuffersMap=[t.COLOR_ATTACHMENT0],this.subKernelOutputTextures=[];for(let r=0;r<this.subKernels.length;r++){const n=this.context.createTexture();this.subKernelOutputTextures.push(n),this.drawBuffersMap.push(t.COLOR_ATTACHMENT0+r+1),t.activeTexture(t.TEXTURE0+this.constantTextureCount+this.argumentTextureCount+r),t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),"single"===this.precision?t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e[0],e[1],0,t.RGBA,t.FLOAT,null):t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e[0],e[1],0,t.RGBA,t.UNSIGNED_BYTE,null),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+r+1,t.TEXTURE_2D,n,0)}}getTextureCache(t){return this.textureCache.hasOwnProperty(t)?this.textureCache[t]:this.textureCache[t]=this.context.createTexture()}detachTextureCache(t){delete this.textureCache[t]}setUniform1f(t,e){if(this.uniform1fCache.hasOwnProperty(t)){if(e===this.uniform1fCache[t])return}this.uniform1fCache[t]=e;const r=this.getUniformLocation(t);this.context.uniform1f(r,e)}setUniform1i(t,e){if(this.uniform1iCache.hasOwnProperty(t)){if(e===this.uniform1iCache[t])return}this.uniform1iCache[t]=e;const r=this.getUniformLocation(t);this.context.uniform1i(r,e)}setUniform2f(t,e,r){if(this.uniform2fCache.hasOwnProperty(t)){const n=this.uniform2fCache[t];if(e===n[0]&&r===n[1])return}this.uniform2fCache[t]=[e,r];const n=this.getUniformLocation(t);this.context.uniform2f(n,e,r)}setUniform2fv(t,e){if(this.uniform2fvCache.hasOwnProperty(t)){const r=this.uniform2fvCache[t];if(e[0]===r[0]&&e[1]===r[1])return}this.uniform2fvCache[t]=e;const r=this.getUniformLocation(t);this.context.uniform2fv(r,e)}setUniform2iv(t,e){if(this.uniform2ivCache.hasOwnProperty(t)){const r=this.uniform2ivCache[t];if(e[0]===r[0]&&e[1]===r[1])return}this.uniform2ivCache[t]=e;const r=this.getUniformLocation(t);this.context.uniform2iv(r,e)}setUniform3fv(t,e){if(this.uniform3fvCache.hasOwnProperty(t)){const r=this.uniform3fvCache[t];if(e[0]===r[0]&&e[1]===r[1]&&e[2]===r[2])return}this.uniform3fvCache[t]=e;const r=this.getUniformLocation(t);this.context.uniform3fv(r,e)}setUniform3iv(t,e){if(this.uniform3ivCache.hasOwnProperty(t)){const r=this.uniform3ivCache[t];if(e[0]===r[0]&&e[1]===r[1]&&e[2]===r[2])return}this.uniform3ivCache[t]=e;const r=this.getUniformLocation(t);this.context.uniform3iv(r,e)}setUniform3fv(t,e){if(this.uniform3fvCache.hasOwnProperty(t)){const r=this.uniform3fvCache[t];if(e[0]===r[0]&&e[1]===r[1]&&e[2]===r[2])return}this.uniform3fvCache[t]=e;const r=this.getUniformLocation(t);this.context.uniform3fv(r,e)}setUniform4iv(t,e){if(this.uniform4ivCache.hasOwnProperty(t)){const r=this.uniform4ivCache[t];if(e[0]===r[0]&&e[1]===r[1]&&e[2]===r[2]&&e[3]===r[3])return}this.uniform4ivCache[t]=e;const r=this.getUniformLocation(t);this.context.uniform4iv(r,e)}setUniform4fv(t,e){if(this.uniform4fvCache.hasOwnProperty(t)){const r=this.uniform4fvCache[t];if(e[0]===r[0]&&e[1]===r[1]&&e[2]===r[2]&&e[3]===r[3])return}this.uniform4fvCache[t]=e;const r=this.getUniformLocation(t);this.context.uniform4fv(r,e)}getUniformLocation(t){return this.programUniformLocationCache.hasOwnProperty(t)?this.programUniformLocationCache[t]:this.programUniformLocationCache[t]=this.context.getUniformLocation(this.program,t)}_getFragShaderArtifactMap(t){return{HEADER:this._getHeaderString(),LOOP_MAX:this._getLoopMaxString(),PLUGINS:this._getPluginsString(),CONSTANTS:this._getConstantsString(),DECODE32_ENDIANNESS:this._getDecode32EndiannessString(),ENCODE32_ENDIANNESS:this._getEncode32EndiannessString(),DIVIDE_WITH_INTEGER_CHECK:this._getDivideWithIntegerCheckString(),INJECTED_NATIVE:this._getInjectedNative(),MAIN_CONSTANTS:this._getMainConstantsString(),MAIN_ARGUMENTS:this._getMainArgumentsString(t),KERNEL:this.getKernelString(),MAIN_RESULT:this.getMainResultString(),FLOAT_TACTIC_DECLARATION:this.getFloatTacticDeclaration(),INT_TACTIC_DECLARATION:this.getIntTacticDeclaration(),SAMPLER_2D_TACTIC_DECLARATION:this.getSampler2DTacticDeclaration(),SAMPLER_2D_ARRAY_TACTIC_DECLARATION:this.getSampler2DArrayTacticDeclaration()}}_getVertShaderArtifactMap(t){return{FLOAT_TACTIC_DECLARATION:this.getFloatTacticDeclaration(),INT_TACTIC_DECLARATION:this.getIntTacticDeclaration(),SAMPLER_2D_TACTIC_DECLARATION:this.getSampler2DTacticDeclaration(),SAMPLER_2D_ARRAY_TACTIC_DECLARATION:this.getSampler2DArrayTacticDeclaration()}}_getHeaderString(){return null!==this.subKernels?"#extension GL_EXT_draw_buffers : require\n":""}_getLoopMaxString(){return this.loopMaxIterations?` ${parseInt(this.loopMaxIterations)};\n`:" 1000;\n"}_getPluginsString(){return this.plugins?this.plugins.map(t=>t.source&&this.source.match(t.functionMatch)?t.source:"").join("\n"):"\n"}_getConstantsString(){const t=[],{threadDim:e,texSize:r}=this;return this.dynamicOutput?t.push("uniform ivec3 uOutputDim","uniform ivec2 uTexSize"):t.push(`ivec3 uOutputDim = ivec3(${e[0]}, ${e[1]}, ${e[2]})`,`ivec2 uTexSize = ivec2(${r[0]}, ${r[1]})`),Ht.linesToString(t)}_getTextureCoordinate(){const t=this.subKernels;return null===t||t.length<1?"varying vec2 vTexCoord;\n":"out vec2 vTexCoord;\n"}_getDecode32EndiannessString(){return"LE"===this.endianness?"":"  texel.rgba = texel.abgr;\n"}_getEncode32EndiannessString(){return"LE"===this.endianness?"":"  texel.rgba = texel.abgr;\n"}_getDivideWithIntegerCheckString(){return this.fixIntegerDivisionAccuracy?"float div_with_int_check(float x, float y) {\n  if (floor(x) == x && floor(y) == y && integerMod(x, y) == 0.0) {\n    return float(int(x)/int(y));\n  }\n  return x / y;\n}":""}_getMainArgumentsString(t){const e=[],{argumentNames:r}=this;for(let n=0;n<r.length;n++)e.push(this.kernelArguments[n].getSource(t[n]));return e.join("")}_getInjectedNative(){return this.injectedNative||""}_getMainConstantsString(){const t=[],{constants:e}=this;if(e){let r=0;for(const n in e)t.push(this.kernelConstants[r++].getSource(this.constants[n]))}return t.join("")}getKernelString(){let t;switch(this.returnType){case"Array(2)":t="vec2 kernelResult";break;case"Array(3)":t="vec3 kernelResult";break;case"Array(4)":t="vec4 kernelResult";break;case"LiteralInteger":case"Float":case"Number":case"Integer":t="float kernelResult";break;default:if(!this.graphical)throw new Error(`unrecognized output type "${this.returnType}"`);t="float kernelResult"}const e=[],r=this.subKernels;if(null!==r)switch(e.push(t),this.returnType){case"Number":case"Float":case"Integer":for(let t=0;t<r.length;t++){const n=r[t];e.push("Integer"===n.returnType?`int subKernelResult_${n.name} = 0`:`float subKernelResult_${n.name} = 0.0`)}break;case"Array(2)":for(let t=0;t<r.length;t++)e.push(`vec2 subKernelResult_${r[t].name}`);break;case"Array(3)":for(let t=0;t<r.length;t++)e.push(`vec3 subKernelResult_${r[t].name}`);break;case"Array(4)":for(let t=0;t<r.length;t++)e.push(`vec4 subKernelResult_${r[t].name}`)}else e.push(t);return Ht.linesToString(e)+this.translatedSource}getMainResultGraphical(){return Ht.linesToString(["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  gl_FragColor = actualColor"])}getMainResultPackedPixels(){switch(this.returnType){case"LiteralInteger":case"Number":case"Integer":case"Float":return this.getMainResultKernelPackedPixels()+this.getMainResultSubKernelPackedPixels();default:throw new Error(`packed output only usable with Numbers, "${this.returnType}" specified`)}}getMainResultKernelPackedPixels(){return Ht.linesToString(["  threadId = indexTo3D(index, uOutputDim)","  kernel()",`  gl_FragData[0] = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(kernelResult)`])}getMainResultSubKernelPackedPixels(){const t=[];if(!this.subKernels)return"";for(let e=0;e<this.subKernels.length;e++){"Integer"===this.subKernels[e].returnType?t.push(`  gl_FragData[${e+1}] = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(float(subKernelResult_${this.subKernels[e].name}))`):t.push(`  gl_FragData[${e+1}] = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(subKernelResult_${this.subKernels[e].name})`)}return Ht.linesToString(t)}getMainResultMemoryOptimizedFloats(){const t=["  index *= 4"];switch(this.returnType){case"Number":case"Integer":case"Float":const e=["r","g","b","a"];for(let r=0;r<e.length;r++){const n=e[r];this.getMainResultKernelMemoryOptimizedFloats(t,n),this.getMainResultSubKernelMemoryOptimizedFloats(t,n),r+1<e.length&&t.push("  index += 1")}break;default:throw new Error(`optimized output only usable with Numbers, ${this.returnType} specified`)}return Ht.linesToString(t)}getMainResultKernelMemoryOptimizedFloats(t,e){t.push("  threadId = indexTo3D(index, uOutputDim)","  kernel()",`  gl_FragData[0].${e} = kernelResult`)}getMainResultSubKernelMemoryOptimizedFloats(t,e){if(!this.subKernels)return t;for(let r=0;r<this.subKernels.length;r++){"Integer"===this.subKernels[r].returnType?t.push(`  gl_FragData[${r+1}].${e} = float(subKernelResult_${this.subKernels[r].name})`):t.push(`  gl_FragData[${r+1}].${e} = subKernelResult_${this.subKernels[r].name}`)}}getMainResultKernelNumberTexture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  gl_FragData[0][0] = kernelResult"]}getMainResultSubKernelNumberTexture(){const t=[];if(!this.subKernels)return t;for(let e=0;e<this.subKernels.length;++e){const r=this.subKernels[e];"Integer"===r.returnType?t.push(`  gl_FragData[${e+1}][0] = float(subKernelResult_${r.name})`):t.push(`  gl_FragData[${e+1}][0] = subKernelResult_${r.name}`)}return t}getMainResultKernelArray2Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  gl_FragData[0][0] = kernelResult[0]","  gl_FragData[0][1] = kernelResult[1]"]}getMainResultSubKernelArray2Texture(){const t=[];if(!this.subKernels)return t;for(let e=0;e<this.subKernels.length;++e)t.push(`  gl_FragData[${e+1}][0] = subKernelResult_${this.subKernels[e].name}[0]`,`  gl_FragData[${e+1}][1] = subKernelResult_${this.subKernels[e].name}[1]`);return t}getMainResultKernelArray3Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  gl_FragData[0][0] = kernelResult[0]","  gl_FragData[0][1] = kernelResult[1]","  gl_FragData[0][2] = kernelResult[2]"]}getMainResultSubKernelArray3Texture(){const t=[];if(!this.subKernels)return t;for(let e=0;e<this.subKernels.length;++e)t.push(`  gl_FragData[${e+1}][0] = subKernelResult_${this.subKernels[e].name}[0]`,`  gl_FragData[${e+1}][1] = subKernelResult_${this.subKernels[e].name}[1]`,`  gl_FragData[${e+1}][2] = subKernelResult_${this.subKernels[e].name}[2]`);return t}getMainResultKernelArray4Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  gl_FragData[0] = kernelResult"]}getMainResultSubKernelArray4Texture(){const t=[];if(!this.subKernels)return t;switch(this.returnType){case"Number":case"Float":case"Integer":for(let e=0;e<this.subKernels.length;++e){"Integer"===this.subKernels[e].returnType?t.push(`  gl_FragData[${e+1}] = float(subKernelResult_${this.subKernels[e].name})`):t.push(`  gl_FragData[${e+1}] = subKernelResult_${this.subKernels[e].name}`)}break;case"Array(2)":for(let e=0;e<this.subKernels.length;++e)t.push(`  gl_FragData[${e+1}][0] = subKernelResult_${this.subKernels[e].name}[0]`,`  gl_FragData[${e+1}][1] = subKernelResult_${this.subKernels[e].name}[1]`);break;case"Array(3)":for(let e=0;e<this.subKernels.length;++e)t.push(`  gl_FragData[${e+1}][0] = subKernelResult_${this.subKernels[e].name}[0]`,`  gl_FragData[${e+1}][1] = subKernelResult_${this.subKernels[e].name}[1]`,`  gl_FragData[${e+1}][2] = subKernelResult_${this.subKernels[e].name}[2]`);break;case"Array(4)":for(let e=0;e<this.subKernels.length;++e)t.push(`  gl_FragData[${e+1}][0] = subKernelResult_${this.subKernels[e].name}[0]`,`  gl_FragData[${e+1}][1] = subKernelResult_${this.subKernels[e].name}[1]`,`  gl_FragData[${e+1}][2] = subKernelResult_${this.subKernels[e].name}[2]`,`  gl_FragData[${e+1}][3] = subKernelResult_${this.subKernels[e].name}[3]`)}return t}replaceArtifacts(t,e){return t.replace(/[ ]*__([A-Z]+[0-9]*([_]?[A-Z]*[0-9]?)*)__;\n/g,(t,r)=>{if(e.hasOwnProperty(r))return e[r];throw`unhandled artifact ${r}`})}getFragmentShader(t){return null!==this.compiledFragmentShader?this.compiledFragmentShader:this.compiledFragmentShader=this.replaceArtifacts(this.constructor.fragmentShader,this._getFragShaderArtifactMap(t))}getVertexShader(t){return null!==this.compiledVertexShader?this.compiledVertexShader:this.compiledVertexShader=this.replaceArtifacts(this.constructor.vertexShader,this._getVertShaderArtifactMap(t))}toString(){const t=Ht.linesToString(["const gl = context"]);return Fe(this.constructor,arguments,this,t)}destroy(t){this.outputTexture&&this.context.deleteTexture(this.outputTexture),this.buffer&&this.context.deleteBuffer(this.buffer),this.framebuffer&&this.context.deleteFramebuffer(this.framebuffer),this.vertShader&&this.context.deleteShader(this.vertShader),this.fragShader&&this.context.deleteShader(this.fragShader),this.program&&this.context.deleteProgram(this.program);const e=Object.keys(this.textureCache);for(let t=0;t<e.length;t++){const r=e[t];this.context.deleteTexture(this.textureCache[r])}if(this.subKernelOutputTextures)for(let t=0;t<this.subKernelOutputTextures.length;t++)this.context.deleteTexture(this.subKernelOutputTextures[t]);if(t){const t=yr.indexOf(this.canvas);t>=0&&(yr[t]=null,Tr[t]=null)}this.destroyExtensions(),delete this.context,delete this.canvas}destroyExtensions(){this.extensions.OES_texture_float=null,this.extensions.OES_texture_float_linear=null,this.extensions.OES_element_index_uint=null,this.extensions.WEBGL_draw_buffers=null}static destroyContext(t){const e=t.getExtension("WEBGL_lose_context");e&&e.loseContext()}toJSON(){const t=super.toJSON();return t.functionNodes=qt.fromKernel(this,_e).toJSON(),t}}class Ar extends _e{astIdentifierExpression(t,e){if("Identifier"!==t.type)throw this.astErrorOutput("IdentifierExpression - not an Identifier",t);const r=this.getType(t);return"Infinity"===t.name?e.push("intBitsToFloat(2139095039)"):"Boolean"===r&&this.argumentNames.indexOf(t.name)>-1?e.push(`bool(user_${t.name})`):e.push(`user_${t.name}`),e}}const Sr="#version 300 es\n__HEADER__;\n__FLOAT_TACTIC_DECLARATION__;\n__INT_TACTIC_DECLARATION__;\n__SAMPLER_2D_TACTIC_DECLARATION__;\n__SAMPLER_2D_ARRAY_TACTIC_DECLARATION__;\n\nconst int LOOP_MAX = __LOOP_MAX__;\n\n__PLUGINS__;\n__CONSTANTS__;\n\nin vec2 vTexCoord;\n\nconst int BIT_COUNT = 32;\nint modi(int x, int y) {\n  return x - y * (x / y);\n}\n\nint bitwiseOr(int a, int b) {\n  int result = 0;\n  int n = 1;\n\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if ((modi(a, 2) == 1) || (modi(b, 2) == 1)) {\n      result += n;\n    }\n    a = a / 2;\n    b = b / 2;\n    n = n * 2;\n    if(!(a > 0 || b > 0)) {\n      break;\n    }\n  }\n  return result;\n}\nint bitwiseXOR(int a, int b) {\n  int result = 0;\n  int n = 1;\n\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if ((modi(a, 2) == 1) != (modi(b, 2) == 1)) {\n      result += n;\n    }\n    a = a / 2;\n    b = b / 2;\n    n = n * 2;\n    if(!(a > 0 || b > 0)) {\n      break;\n    }\n  }\n  return result;\n}\nint bitwiseAnd(int a, int b) {\n  int result = 0;\n  int n = 1;\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if ((modi(a, 2) == 1) && (modi(b, 2) == 1)) {\n      result += n;\n    }\n    a = a / 2;\n    b = b / 2;\n    n = n * 2;\n    if(!(a > 0 && b > 0)) {\n      break;\n    }\n  }\n  return result;\n}\nint bitwiseNot(int a) {\n  int result = 0;\n  int n = 1;\n\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (modi(a, 2) == 0) {\n      result += n;\n    }\n    a = a / 2;\n    n = n * 2;\n  }\n  return result;\n}\nint bitwiseZeroFillLeftShift(int n, int shift) {\n  int maxBytes = BIT_COUNT;\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (maxBytes >= n) {\n      break;\n    }\n    maxBytes *= 2;\n  }\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (i >= shift) {\n      break;\n    }\n    n *= 2;\n  }\n\n  int result = 0;\n  int byteVal = 1;\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (i >= maxBytes) break;\n    if (modi(n, 2) > 0) { result += byteVal; }\n    n = int(n / 2);\n    byteVal *= 2;\n  }\n  return result;\n}\n\nint bitwiseSignedRightShift(int num, int shifts) {\n  return int(floor(float(num) / pow(2.0, float(shifts))));\n}\n\nint bitwiseZeroFillRightShift(int n, int shift) {\n  int maxBytes = BIT_COUNT;\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (maxBytes >= n) {\n      break;\n    }\n    maxBytes *= 2;\n  }\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (i >= shift) {\n      break;\n    }\n    n /= 2;\n  }\n  int result = 0;\n  int byteVal = 1;\n  for (int i = 0; i < BIT_COUNT; i++) {\n    if (i >= maxBytes) break;\n    if (modi(n, 2) > 0) { result += byteVal; }\n    n = int(n / 2);\n    byteVal *= 2;\n  }\n  return result;\n}\n\nvec2 integerMod(vec2 x, float y) {\n  vec2 res = floor(mod(x, y));\n  return res * step(1.0 - floor(y), -res);\n}\n\nvec3 integerMod(vec3 x, float y) {\n  vec3 res = floor(mod(x, y));\n  return res * step(1.0 - floor(y), -res);\n}\n\nvec4 integerMod(vec4 x, vec4 y) {\n  vec4 res = floor(mod(x, y));\n  return res * step(1.0 - floor(y), -res);\n}\n\nfloat integerMod(float x, float y) {\n  float res = floor(mod(x, y));\n  return res * (res > floor(y) - 1.0 ? 0.0 : 1.0);\n}\n\nint integerMod(int x, int y) {\n  return x - (y * int(x/y));\n}\n\n__DIVIDE_WITH_INTEGER_CHECK__;\n\n// Here be dragons!\n// DO NOT OPTIMIZE THIS CODE\n// YOU WILL BREAK SOMETHING ON SOMEBODY'S MACHINE\n// LEAVE IT AS IT IS, LEST YOU WASTE YOUR OWN TIME\nconst vec2 MAGIC_VEC = vec2(1.0, -256.0);\nconst vec4 SCALE_FACTOR = vec4(1.0, 256.0, 65536.0, 0.0);\nconst vec4 SCALE_FACTOR_INV = vec4(1.0, 0.00390625, 0.0000152587890625, 0.0); // 1, 1/256, 1/65536\nfloat decode32(vec4 texel) {\n  __DECODE32_ENDIANNESS__;\n  texel *= 255.0;\n  vec2 gte128;\n  gte128.x = texel.b >= 128.0 ? 1.0 : 0.0;\n  gte128.y = texel.a >= 128.0 ? 1.0 : 0.0;\n  float exponent = 2.0 * texel.a - 127.0 + dot(gte128, MAGIC_VEC);\n  float res = exp2(round(exponent));\n  texel.b = texel.b - 128.0 * gte128.x;\n  res = dot(texel, SCALE_FACTOR) * exp2(round(exponent-23.0)) + res;\n  res *= gte128.y * -2.0 + 1.0;\n  return res;\n}\n\nfloat decode16(vec4 texel, int index) {\n  int channel = integerMod(index, 2);\n  return texel[channel*2] * 255.0 + texel[channel*2 + 1] * 65280.0;\n}\n\nfloat decode8(vec4 texel, int index) {\n  int channel = integerMod(index, 4);\n  return texel[channel] * 255.0;\n}\n\nvec4 legacyEncode32(float f) {\n  float F = abs(f);\n  float sign = f < 0.0 ? 1.0 : 0.0;\n  float exponent = floor(log2(F));\n  float mantissa = (exp2(-exponent) * F);\n  // exponent += floor(log2(mantissa));\n  vec4 texel = vec4(F * exp2(23.0-exponent)) * SCALE_FACTOR_INV;\n  texel.rg = integerMod(texel.rg, 256.0);\n  texel.b = integerMod(texel.b, 128.0);\n  texel.a = exponent*0.5 + 63.5;\n  texel.ba += vec2(integerMod(exponent+127.0, 2.0), sign) * 128.0;\n  texel = floor(texel);\n  texel *= 0.003921569; // 1/255\n  __ENCODE32_ENDIANNESS__;\n  return texel;\n}\n\n// https://github.com/gpujs/gpu.js/wiki/Encoder-details\nvec4 encode32(float value) {\n  if (value == 0.0) return vec4(0, 0, 0, 0);\n\n  float exponent;\n  float mantissa;\n  vec4  result;\n  float sgn;\n\n  sgn = step(0.0, -value);\n  value = abs(value);\n\n  exponent = floor(log2(value));\n\n  mantissa = value*pow(2.0, -exponent)-1.0;\n  exponent = exponent+127.0;\n  result   = vec4(0,0,0,0);\n\n  result.a = floor(exponent/2.0);\n  exponent = exponent - result.a*2.0;\n  result.a = result.a + 128.0*sgn;\n\n  result.b = floor(mantissa * 128.0);\n  mantissa = mantissa - result.b / 128.0;\n  result.b = result.b + exponent*128.0;\n\n  result.g = floor(mantissa*32768.0);\n  mantissa = mantissa - result.g/32768.0;\n\n  result.r = floor(mantissa*8388608.0);\n  return result/255.0;\n}\n// Dragons end here\n\nint index;\nivec3 threadId;\n\nivec3 indexTo3D(int idx, ivec3 texDim) {\n  int z = int(idx / (texDim.x * texDim.y));\n  idx -= z * int(texDim.x * texDim.y);\n  int y = int(idx / texDim.x);\n  int x = int(integerMod(idx, texDim.x));\n  return ivec3(x, y, z);\n}\n\nfloat get32(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture(tex, st / vec2(texSize));\n  return decode32(texel);\n}\n\nfloat get16(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + (texDim.x * (y + (texDim.y * z)));\n  int w = texSize.x * 2;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture(tex, st / vec2(texSize.x * 2, texSize.y));\n  return decode16(texel, index);\n}\n\nfloat get8(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + (texDim.x * (y + (texDim.y * z)));\n  int w = texSize.x * 4;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture(tex, st / vec2(texSize.x * 4, texSize.y));\n  return decode8(texel, index);\n}\n\nfloat getMemoryOptimized32(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + (texDim.x * (y + (texDim.y * z)));\n  int channel = integerMod(index, 4);\n  index = index / 4;\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  index = index / 4;\n  vec4 texel = texture(tex, st / vec2(texSize));\n  return texel[channel];\n}\n\nvec4 getImage2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  return texture(tex, st / vec2(texSize));\n}\n\nvec4 getImage3D(sampler2DArray tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  return texture(tex, vec3(st / vec2(texSize), z));\n}\n\nfloat getFloatFromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);\n  return result[0];\n}\n\nvec2 getVec2FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);\n  return vec2(result[0], result[1]);\n}\n\nvec2 getMemoryOptimizedVec2(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int channel = integerMod(index, 2);\n  index = index / 2;\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture(tex, st / vec2(texSize));\n  if (channel == 0) return vec2(texel.r, texel.g);\n  if (channel == 1) return vec2(texel.b, texel.a);\n  return vec2(0.0, 0.0);\n}\n\nvec3 getVec3FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  vec4 result = getImage2D(tex, texSize, texDim, z, y, x);\n  return vec3(result[0], result[1], result[2]);\n}\n\nvec3 getMemoryOptimizedVec3(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int fieldIndex = 3 * (x + texDim.x * (y + texDim.y * z));\n  int vectorIndex = fieldIndex / 4;\n  int vectorOffset = fieldIndex - vectorIndex * 4;\n  int readY = vectorIndex / texSize.x;\n  int readX = vectorIndex - readY * texSize.x;\n  vec4 tex1 = texture(tex, (vec2(readX, readY) + 0.5) / vec2(texSize));\n\n  if (vectorOffset == 0) {\n    return tex1.xyz;\n  } else if (vectorOffset == 1) {\n    return tex1.yzw;\n  } else {\n    readX++;\n    if (readX >= texSize.x) {\n      readX = 0;\n      readY++;\n    }\n    vec4 tex2 = texture(tex, vec2(readX, readY) / vec2(texSize));\n    if (vectorOffset == 2) {\n      return vec3(tex1.z, tex1.w, tex2.x);\n    } else {\n      return vec3(tex1.w, tex2.x, tex2.y);\n    }\n  }\n}\n\nvec4 getVec4FromSampler2D(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  return getImage2D(tex, texSize, texDim, z, y, x);\n}\n\nvec4 getMemoryOptimizedVec4(sampler2D tex, ivec2 texSize, ivec3 texDim, int z, int y, int x) {\n  int index = x + texDim.x * (y + texDim.y * z);\n  int channel = integerMod(index, 2);\n  int w = texSize.x;\n  vec2 st = vec2(float(integerMod(index, w)), float(index / w)) + 0.5;\n  vec4 texel = texture(tex, st / vec2(texSize));\n  return vec4(texel.r, texel.g, texel.b, texel.a);\n}\n\nvec4 actualColor;\nvoid color(float r, float g, float b, float a) {\n  actualColor = vec4(r,g,b,a);\n}\n\nvoid color(float r, float g, float b) {\n  color(r,g,b,1.0);\n}\n\n__INJECTED_NATIVE__;\n__MAIN_CONSTANTS__;\n__MAIN_ARGUMENTS__;\n__KERNEL__;\n\nvoid main(void) {\n  index = int(vTexCoord.s * float(uTexSize.x)) + int(vTexCoord.t * float(uTexSize.y)) * uTexSize.x;\n  __MAIN_RESULT__;\n}",Er="#version 300 es\n__FLOAT_TACTIC_DECLARATION__;\n__INT_TACTIC_DECLARATION__;\n__SAMPLER_2D_TACTIC_DECLARATION__;\n\nin vec2 aPos;\nin vec2 aTexCoord;\n\nout vec2 vTexCoord;\nuniform vec2 ratio;\n\nvoid main(void) {\n  gl_Position = vec4((aPos + vec2(1)) * ratio + vec2(-1), 0, 1);\n  vTexCoord = aTexCoord;\n}";class _r extends Me{}class vr extends Ve{}class wr extends Ue{getSource(t){const e=this.getVariablePrecisionString();return"constants"===this.origin?`const ${e} int ${this.id} = ${parseInt(t)};\n`:`uniform ${e} int ${this.id};\n`}updateValue(t){"constants"!==this.origin&&this.kernel.setUniform1i(this.id,this.uploadValue=t)}}class Ir extends Ke{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`${t} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${t} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}}class Dr extends Be{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`uniform ${t} ivec2 ${this.sizeId}`,`uniform ${t} ivec3 ${this.dimensionsId}`])}}class Rr extends Le{constructor(t,e){super(t,e),this.checkSize(t[0].width,t[0].height),this.requestTexture(),this.dimensions=[t[0].width,t[0].height,t.length],this.textureSize=[t[0].width,t[0].height]}getStringValueHandler(){return`const uploadValue_${this.name} = ${this.varName};\n`}getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2DArray ${this.id}`,`${t} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${t} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){const{context:e}=this;e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D_ARRAY,this.texture),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D_ARRAY,e.TEXTURE_MIN_FILTER,e.NEAREST),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!0),e.texImage3D(e.TEXTURE_2D_ARRAY,0,e.RGBA,t[0].width,t[0].height,t.length,0,e.RGBA,e.UNSIGNED_BYTE,null);for(let r=0;r<t.length;r++){const n=0,i=0,s=1;e.texSubImage3D(e.TEXTURE_2D_ARRAY,0,n,i,r,t[r].width,t[r].height,s,e.RGBA,e.UNSIGNED_BYTE,this.uploadValue=t[r])}this.kernel.setUniform1i(this.id,this.index)}}class kr extends Rr{getSource(){const t=this.getVariablePrecisionString();return utils.linesToString([`uniform ${t} sampler2DArray ${this.id}`,`uniform ${t} ivec2 ${this.sizeId}`,`uniform ${t} ivec3 ${this.dimensionsId}`])}updateValue(t){const{width:e,height:r}=t[0];this.checkSize(e,r),this.dimensions=[e,r,t.length],this.textureSize=[e,r],this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class $r extends Ir{}class Cr extends Dr{}class Fr extends Xe{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`${t} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${t} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){const{context:e}=this;Ht.flattenTo(t.value,this.uploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class Nr extends Ye{getSource(){return Ht.linesToString([`uniform sampler2D ${this.id}`,`uniform ivec2 ${this.sizeId}`,`uniform ivec3 ${this.dimensionsId}`])}}class Or extends Ze{getSource(){const{id:t,sizeId:e,textureSize:r,dimensionsId:n,dimensions:i}=this,s=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${s} sampler2D ${t}`,`${s} ivec2 ${e} = ivec2(${r[0]}, ${r[1]})`,`${s} ivec3 ${n} = ivec3(${i[0]}, ${i[1]}, ${i[2]})`])}}class Pr extends Je{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`uniform ${t} ivec2 ${this.sizeId}`,`uniform ${t} ivec3 ${this.dimensionsId}`])}}class zr extends Qe{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`${t} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${t} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flattenTo(t,this.uploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class Lr extends tr{updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flattenTo(t,this.uploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class Mr extends Lr{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`uniform ${t} ivec2 ${this.sizeId}`,`uniform ${t} ivec3 ${this.dimensionsId}`])}updateValue(t){this.setShape(t),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class Vr extends rr{updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flattenTo(t,this.uploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class Ur extends Vr{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`uniform ${t} ivec2 ${this.sizeId}`,`uniform ${t} ivec3 ${this.dimensionsId}`])}updateValue(t){this.setShape(t),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class Kr extends ir{updateValue(t){if(t.constructor!==this.initialValueConstructor)return void this.onUpdateValueMismatch();const{context:e}=this;Ht.flattenTo(t,this.uploadValue),e.activeTexture(this.contextHandle),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,this.textureSize[0],this.textureSize[1],0,e.RGBA,e.FLOAT,this.uploadValue),this.kernel.setUniform1i(this.id,this.index)}}class Br extends Kr{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`uniform ${t} ivec2 ${this.sizeId}`,`uniform ${t} ivec3 ${this.dimensionsId}`])}updateValue(t){this.setShape(t),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}}class Gr extends ar{}class jr extends or{}class Xr extends ur{}const Hr={unsigned:{dynamic:{Boolean:_r,Integer:wr,Float:vr,Array:class extends lr{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`uniform ${t} ivec2 ${this.sizeId}`,`uniform ${t} ivec3 ${this.dimensionsId}`])}},"Array(2)":!1,"Array(3)":!1,"Array(4)":!1,"Array1D(2)":!1,"Array1D(3)":!1,"Array1D(4)":!1,"Array2D(2)":!1,"Array2D(3)":!1,"Array2D(4)":!1,"Array3D(2)":!1,"Array3D(3)":!1,"Array3D(4)":!1,Input:class extends We{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`uniform ${t} ivec2 ${this.sizeId}`,`uniform ${t} ivec3 ${this.dimensionsId}`])}},NumberTexture:Pr,"ArrayTexture(1)":Pr,"ArrayTexture(2)":Pr,"ArrayTexture(3)":Pr,"ArrayTexture(4)":Pr,MemoryOptimizedNumberTexture:Nr,HTMLImage:Dr,HTMLImageArray:kr,HTMLVideo:Cr},static:{Boolean:_r,Float:vr,Integer:wr,Array:class extends hr{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`${t} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${t} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}},"Array(2)":!1,"Array(3)":!1,"Array(4)":!1,"Array1D(2)":!1,"Array1D(3)":!1,"Array1D(4)":!1,"Array2D(2)":!1,"Array2D(3)":!1,"Array2D(4)":!1,"Array3D(2)":!1,"Array3D(3)":!1,"Array3D(4)":!1,Input:class extends He{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`${t} ivec2 ${this.sizeId} = ivec2(${this.textureSize[0]}, ${this.textureSize[1]})`,`${t} ivec3 ${this.dimensionsId} = ivec3(${this.dimensions[0]}, ${this.dimensions[1]}, ${this.dimensions[2]})`])}},NumberTexture:Or,"ArrayTexture(1)":Or,"ArrayTexture(2)":Or,"ArrayTexture(3)":Or,"ArrayTexture(4)":Or,MemoryOptimizedNumberTexture:Nr,HTMLImage:Ir,HTMLImageArray:Rr,HTMLVideo:$r}},single:{dynamic:{Boolean:_r,Integer:wr,Float:vr,Array:class extends zr{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`uniform ${t} ivec2 ${this.sizeId}`,`uniform ${t} ivec3 ${this.dimensionsId}`])}updateValue(t){this.dimensions=Ht.getDimensions(t,!0),this.textureSize=Ht.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0]*this.bitRatio,this.textureSize[1]*this.bitRatio),this.uploadValue=new Float32Array(this.uploadArrayLength),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}},"Array(2)":Gr,"Array(3)":jr,"Array(4)":Xr,"Array1D(2)":Mr,"Array1D(3)":Mr,"Array1D(4)":Mr,"Array2D(2)":Ur,"Array2D(3)":Ur,"Array2D(4)":Ur,"Array3D(2)":Br,"Array3D(3)":Br,"Array3D(4)":Br,Input:class extends Fr{getSource(){const t=this.getVariablePrecisionString();return Ht.linesToString([`uniform ${t} sampler2D ${this.id}`,`uniform ${t} ivec2 ${this.sizeId}`,`uniform ${t} ivec3 ${this.dimensionsId}`])}updateValue(t){let[e,r,n]=t.size;this.dimensions=new Int32Array([e||1,r||1,n||1]),this.textureSize=Ht.getMemoryOptimizedFloatTextureSize(this.dimensions,this.bitRatio),this.uploadArrayLength=this.textureSize[0]*this.textureSize[1]*this.bitRatio,this.checkSize(this.textureSize[0]*this.bitRatio,this.textureSize[1]*this.bitRatio),this.uploadValue=new Float32Array(this.uploadArrayLength),this.kernel.setUniform3iv(this.dimensionsId,this.dimensions),this.kernel.setUniform2iv(this.sizeId,this.textureSize),super.updateValue(t)}},NumberTexture:Pr,"ArrayTexture(1)":Pr,"ArrayTexture(2)":Pr,"ArrayTexture(3)":Pr,"ArrayTexture(4)":Pr,MemoryOptimizedNumberTexture:Nr,HTMLImage:Dr,HTMLImageArray:kr,HTMLVideo:Cr},static:{Boolean:_r,Float:vr,Integer:wr,Array:zr,"Array(2)":Gr,"Array(3)":jr,"Array(4)":Xr,"Array1D(2)":Lr,"Array1D(3)":Lr,"Array1D(4)":Lr,"Array2D(2)":Vr,"Array2D(3)":Vr,"Array2D(4)":Vr,"Array3D(2)":Kr,"Array3D(3)":Kr,"Array3D(4)":Kr,Input:Fr,NumberTexture:Or,"ArrayTexture(1)":Or,"ArrayTexture(2)":Or,"ArrayTexture(3)":Or,"ArrayTexture(4)":Or,MemoryOptimizedNumberTexture:class extends qe{getSource(){const{id:t,sizeId:e,textureSize:r,dimensionsId:n,dimensions:i}=this,s=this.getVariablePrecisionString();return Ht.linesToString([`uniform sampler2D ${t}`,`${s} ivec2 ${e} = ivec2(${r[0]}, ${r[1]})`,`${s} ivec3 ${n} = ivec3(${i[0]}, ${i[1]}, ${i[2]})`])}},HTMLImage:Ir,HTMLImageArray:Rr,HTMLVideo:$r}}};let Wr=null,qr=null,Yr=null,Zr=null,Jr=null;class Qr extends br{static get isSupported(){return null!==Wr?Wr:(this.setupFeatureChecks(),Wr=this.isContextMatch(Yr))}static setupFeatureChecks(){"undefined"!=typeof document?qr=document.createElement("canvas"):"undefined"!=typeof OffscreenCanvas&&(qr=new OffscreenCanvas(0,0)),qr&&(Yr=qr.getContext("webgl2"))&&Yr.getExtension&&(Zr={EXT_color_buffer_float:Yr.getExtension("EXT_color_buffer_float"),OES_texture_float_linear:Yr.getExtension("OES_texture_float_linear")},Jr=this.getFeatures())}static isContextMatch(t){return"undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext}static getFeatures(){return Object.freeze({isFloatRead:this.getIsFloatRead(),isIntegerDivisionAccurate:this.getIsIntegerDivisionAccurate(),kernelMap:!0,isTextureFloat:!0,channelCount:this.getChannelCount(),maxTextureSize:this.getMaxTextureSize()})}static getIsTextureFloat(){return!0}static getIsIntegerDivisionAccurate(){return super.getIsIntegerDivisionAccurate()}static getChannelCount(){return Yr.getParameter(Yr.MAX_DRAW_BUFFERS)}static getMaxTextureSize(){return Yr.getParameter(Yr.MAX_TEXTURE_SIZE)}static lookupKernelValueType(t,e,r,n){return function(t,e,r,n){if(!t)throw new Error("type missing");if(!e)throw new Error("dynamic missing");if(!r)throw new Error("precision missing");n.type&&(t=n.type);const i=Hr[r][e];if(!1===i[t])return null;if(void 0===i[t])throw new Error(`Could not find a KernelValue for ${t}`);return i[t]}(t,e,r,n)}static get testCanvas(){return qr}static get testContext(){return Yr}static get features(){return Jr}static get fragmentShader(){return Sr}static get vertexShader(){return Er}initContext(){return this.canvas.getContext("webgl2",{alpha:!1,depth:!1,antialias:!1})}initExtensions(){this.extensions={EXT_color_buffer_float:this.context.getExtension("EXT_color_buffer_float"),OES_texture_float_linear:this.context.getExtension("OES_texture_float_linear")}}validateSettings(t){if(!this.validate)return void(this.texSize=Ht.getKernelTextureSize({optimizeFloatMemory:this.optimizeFloatMemory,precision:this.precision},this.output));const e=this.constructor.features;if("single"===this.precision&&!e.isFloatRead)throw new Error("Float texture outputs are not supported");if(this.graphical||null!==this.precision||(this.precision=e.isFloatRead?"single":"unsigned"),null===this.fixIntegerDivisionAccuracy?this.fixIntegerDivisionAccuracy=!e.isIntegerDivisionAccurate:this.fixIntegerDivisionAccuracy&&e.isIntegerDivisionAccurate&&(this.fixIntegerDivisionAccuracy=!1),this.checkOutput(),!this.output||0===this.output.length){if(1!==t.length)throw new Error("Auto output only supported for kernels with only one input");const e=Ht.getVariableType(t[0],this.strictIntegers);switch(e){case"Array":this.output=Ht.getDimensions(e);break;case"NumberTexture":case"MemoryOptimizedNumberTexture":case"ArrayTexture(1)":case"ArrayTexture(2)":case"ArrayTexture(3)":case"ArrayTexture(4)":this.output=t[0].output;break;default:throw new Error("Auto output not supported for input type: "+e)}}if(this.graphical){if(2!==this.output.length)throw new Error("Output must have 2 dimensions on graphical mode");return"single"===this.precision&&(console.warn("Cannot use graphical mode and single precision at the same time"),this.precision="unsigned"),void(this.texSize=Ht.clone(this.output))}!this.graphical&&null===this.precision&&e.isTextureFloat&&(this.precision="single"),this.texSize=Ht.getKernelTextureSize({optimizeFloatMemory:this.optimizeFloatMemory,precision:this.precision},this.output),this.checkTextureSize()}translateSource(){const t=qt.fromKernel(this,Ar,{fixIntegerDivisionAccuracy:this.fixIntegerDivisionAccuracy});if(this.translatedSource=t.getPrototypeString("kernel"),this.graphical||this.returnType||(this.returnType=t.getKernelResultType()),this.subKernels&&this.subKernels.length>0)for(let e=0;e<this.subKernels.length;e++){const r=this.subKernels[e];r.returnType||(r.returnType=t.getSubKernelResultType(e))}}run(){const{kernelArguments:t,texSize:e,forceUploadKernelConstants:r}=this,n=this.context;n.useProgram(this.program),n.scissor(0,0,e[0],e[1]),this.dynamicOutput&&(this.setUniform3iv("uOutputDim",new Int32Array(this.threadDim)),this.setUniform2iv("uTexSize",e)),this.setUniform2f("ratio",e[0]/this.maxTexSize[0],e[1]/this.maxTexSize[1]),this.switchingKernels=!1;for(let t=0;t<r.length;t++){const e=r[t];if(e.updateValue(this.constants[e.name]),this.switchingKernels)return}for(let e=0;e<t.length;e++)if(t[e].updateValue(arguments[e]),this.switchingKernels)return;if(this.plugins)for(let t=0;t<this.plugins.length;t++){const e=this.plugins[t];e.onBeforeRun&&e.onBeforeRun(this)}if(this.graphical)return this.pipeline?(n.bindRenderbuffer(n.RENDERBUFFER,null),n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer),this.outputTexture&&!this.immutable||this._setupOutputTexture(),n.drawArrays(n.TRIANGLE_STRIP,0,4),new this.TextureConstructor({texture:this.outputTexture,size:e,dimensions:this.threadDim,output:this.output,context:this.context})):(n.bindRenderbuffer(n.RENDERBUFFER,null),n.bindFramebuffer(n.FRAMEBUFFER,null),void n.drawArrays(n.TRIANGLE_STRIP,0,4));n.bindFramebuffer(n.FRAMEBUFFER,this.framebuffer),this.immutable&&this._setupOutputTexture(),null!==this.subKernels&&(this.immutable&&this._setupSubOutputTextures(),n.drawBuffers(this.drawBuffersMap)),n.drawArrays(n.TRIANGLE_STRIP,0,4)}drawBuffers(){this.context.drawBuffers(this.drawBuffersMap)}getOutputTexture(){return this.outputTexture}_setupOutputTexture(){const{texSize:t}=this,e=this.context,r=this.outputTexture=e.createTexture();if(e.activeTexture(e.TEXTURE0+this.constantTextureCount+this.argumentTextureCount),e.bindTexture(e.TEXTURE_2D,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),"single"===this.precision)if(this.pipeline)switch(this.returnType){case"Number":case"Float":case"Integer":this.optimizeFloatMemory?e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,t[0],t[1]):e.texStorage2D(e.TEXTURE_2D,1,e.R32F,t[0],t[1]);break;case"Array(2)":e.texStorage2D(e.TEXTURE_2D,1,e.RG32F,t[0],t[1]);break;case"Array(3)":case"Array(4)":e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,t[0],t[1]);break;default:throw new Error("Unhandled return type")}else e.texStorage2D(e.TEXTURE_2D,1,e.RGBA32F,t[0],t[1]);else e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t[0],t[1],0,e.RGBA,e.UNSIGNED_BYTE,null);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,r,0)}_setupSubOutputTextures(){const{texSize:t}=this,e=this.context;this.drawBuffersMap=[e.COLOR_ATTACHMENT0],this.subKernelOutputTextures=[];for(let r=0;r<this.subKernels.length;r++){const n=this.context.createTexture();this.subKernelOutputTextures.push(n),this.drawBuffersMap.push(e.COLOR_ATTACHMENT0+r+1),e.activeTexture(e.TEXTURE0+this.constantTextureCount+this.argumentTextureCount+r),e.bindTexture(e.TEXTURE_2D,n),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),"single"===this.precision?e.texImage2D(e.TEXTURE_2D,0,e.RGBA32F,t[0],t[1],0,e.RGBA,e.FLOAT,null):e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t[0],t[1],0,e.RGBA,e.UNSIGNED_BYTE,null),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+r+1,e.TEXTURE_2D,n,0)}}_getHeaderString(){return""}_getTextureCoordinate(){const t=this.subKernels;if(null===t||t.length<1)switch(this.tactic){case"speed":return"in lowp vec2 vTexCoord;\n";case"performance":return"in highp vec2 vTexCoord;\n";case"balanced":default:return"in mediump vec2 vTexCoord;\n"}else switch(this.tactic){case"speed":return"out lowp vec2 vTexCoord;\n";case"performance":return"out highp vec2 vTexCoord;\n";case"balanced":default:return"out mediump vec2 vTexCoord;\n"}}_getMainArgumentsString(t){const e=[],r=this.argumentNames;for(let n=0;n<r.length;n++)e.push(this.kernelArguments[n].getSource(t[n]));return e.join("")}getKernelString(){let t;switch(this.returnType){case"Array(2)":t="vec2 kernelResult";break;case"Array(3)":t="vec3 kernelResult";break;case"Array(4)":t="vec4 kernelResult";break;case"LiteralInteger":case"Float":case"Number":case"Integer":t="float kernelResult";break;default:if(!this.graphical)throw new Error(`unrecognized output type "${this.returnType}"`);t="float kernelResult"}const e=[],r=this.subKernels;if(null!==r){e.push(t,"layout(location = 0) out vec4 data0");for(let t=0;t<r.length;t++){const n=r[t];e.push("Integer"===n.returnType?`int subKernelResult_${n.name} = 0`:`float subKernelResult_${n.name} = 0.0`,`layout(location = ${t+1}) out vec4 data${t+1}`)}}else e.push("out vec4 data0",t);return Ht.linesToString(e)+this.translatedSource}getMainResultGraphical(){return Ht.linesToString(["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  data0 = actualColor"])}getMainResultPackedPixels(){switch(this.returnType){case"LiteralInteger":case"Number":case"Integer":case"Float":return this.getMainResultKernelPackedPixels()+this.getMainResultSubKernelPackedPixels();default:throw new Error(`packed output only usable with Numbers, "${this.returnType}" specified`)}}getMainResultKernelPackedPixels(){return Ht.linesToString(["  threadId = indexTo3D(index, uOutputDim)","  kernel()",`  data0 = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(kernelResult)`])}getMainResultSubKernelPackedPixels(){const t=[];if(!this.subKernels)return"";for(let e=0;e<this.subKernels.length;e++){"Integer"===this.subKernels[e].returnType?t.push(`  data${e+1} = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(float(subKernelResult_${this.subKernels[e].name}))`):t.push(`  data${e+1} = ${this.useLegacyEncoder?"legacyEncode32":"encode32"}(subKernelResult_${this.subKernels[e].name})`)}return Ht.linesToString(t)}getMainResultMemoryOptimizedFloats(){const t=["  index *= 4"];switch(this.returnType){case"Number":case"Integer":case"Float":const e=["r","g","b","a"];for(let r=0;r<e.length;r++){const n=e[r];this.getMainResultKernelMemoryOptimizedFloats(t,n),this.getMainResultSubKernelMemoryOptimizedFloats(t,n),r+1<e.length&&t.push("  index += 1")}break;default:throw new Error(`optimized output only usable with Numbers, ${this.returnType} specified`)}return Ht.linesToString(t)}getMainResultKernelMemoryOptimizedFloats(t,e){t.push("  threadId = indexTo3D(index, uOutputDim)","  kernel()",`  data0.${e} = kernelResult`)}getMainResultSubKernelMemoryOptimizedFloats(t,e){if(!this.subKernels)return t;for(let r=0;r<this.subKernels.length;r++){const n=this.subKernels[r];"Integer"===n.returnType?t.push(`  data${r+1}.${e} = float(subKernelResult_${n.name})`):t.push(`  data${r+1}.${e} = subKernelResult_${n.name}`)}}getMainResultKernelNumberTexture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  data0[0] = kernelResult"]}getMainResultSubKernelNumberTexture(){const t=[];if(!this.subKernels)return t;for(let e=0;e<this.subKernels.length;++e){const r=this.subKernels[e];"Integer"===r.returnType?t.push(`  data${e+1}[0] = float(subKernelResult_${r.name})`):t.push(`  data${e+1}[0] = subKernelResult_${r.name}`)}return t}getMainResultKernelArray2Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  data0[0] = kernelResult[0]","  data0[1] = kernelResult[1]"]}getMainResultSubKernelArray2Texture(){const t=[];if(!this.subKernels)return t;for(let e=0;e<this.subKernels.length;++e){const r=this.subKernels[e];t.push(`  data${e+1}[0] = subKernelResult_${r.name}[0]`,`  data${e+1}[1] = subKernelResult_${r.name}[1]`)}return t}getMainResultKernelArray3Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  data0[0] = kernelResult[0]","  data0[1] = kernelResult[1]","  data0[2] = kernelResult[2]"]}getMainResultSubKernelArray3Texture(){const t=[];if(!this.subKernels)return t;for(let e=0;e<this.subKernels.length;++e){const r=this.subKernels[e];t.push(`  data${e+1}[0] = subKernelResult_${r.name}[0]`,`  data${e+1}[1] = subKernelResult_${r.name}[1]`,`  data${e+1}[2] = subKernelResult_${r.name}[2]`)}return t}getMainResultKernelArray4Texture(){return["  threadId = indexTo3D(index, uOutputDim)","  kernel()","  data0 = kernelResult"]}getMainResultSubKernelArray4Texture(){const t=[];if(!this.subKernels)return t;for(let e=0;e<this.subKernels.length;++e)t.push(`  data${e+1} = subKernelResult_${this.subKernels[e].name}`);return t}destroyExtensions(){this.extensions.EXT_color_buffer_float=null,this.extensions.OES_texture_float_linear=null}toJSON(){const t=super.toJSON();return t.functionNodes=qt.fromKernel(this,Ar).toJSON(),t}}function tn(t,e){const r=Ht.allPropertiesOf(t);for(let n=0;n<r.length;n++){const i=r[n];"_"===i[0]&&"_"===i[1]||("function"==typeof t[i]?"add"===i.substring(0,3)||"set"===i.substring(0,3)?e[i]=function(){return t[i].apply(t,arguments),e}:"toString"===i?e.toString=function(){return t.toString.apply(t,arguments)}:e[i]=t[i].bind(t):(e.__defineGetter__(i,()=>t[i]),e.__defineSetter__(i,e=>{t[i]=e})))}}const en=[Qr,br],rn=["gpu","cpu"],nn={webgl2:Qr,webgl:br};let sn=!0;function an(t){if(!t)return{};const e=Object.assign({},t);return t.hasOwnProperty("floatOutput")&&(f("setting","floatOutput","precision"),e.precision=t.floatOutput?"single":"unsigned"),t.hasOwnProperty("outputToTexture")&&(f("setting","outputToTexture","pipeline"),e.pipeline=Boolean(t.outputToTexture)),t.hasOwnProperty("outputImmutable")&&(f("setting","outputImmutable","immutable"),e.immutable=Boolean(t.outputImmutable)),t.hasOwnProperty("floatTextures")&&(f("setting","floatTextures","optimizeFloatMemory"),e.optimizeFloatMemory=Boolean(t.floatTextures)),e}const on=class{static disableValidation(){sn=!1}static enableValidation(){sn=!0}static get isGPUSupported(){return en.some(t=>t.isSupported)}static get isKernelMapSupported(){return en.some(t=>t.isSupported&&t.features.kernelMap)}static get isOffscreenCanvasSupported(){return"undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas||"undefined"!=typeof importScripts}static get isWebGLSupported(){return br.isSupported}static get isWebGL2Supported(){return Qr.isSupported}static get isHeadlessGLSupported(){return!1}static get isCanvasSupported(){return"undefined"!=typeof HTMLCanvasElement}static get isGPUHTMLImageArraySupported(){return Qr.isSupported}static get isSinglePrecisionSupported(){return en.some(t=>t.isSupported&&t.features.isFloatRead&&t.features.isTextureFloat)}constructor(t){if(t=t||{},this.canvas=t.canvas||null,this.context=t.context||null,this.mode=t.mode,this.Kernel=null,this.kernels=[],this.functions=[],this.nativeFunctions=[],this.injectedNative=null,"dev"!==this.mode){if(this.chooseKernel(),t.functions)for(let e=0;e<t.functions.length;e++)this.addFunction(t.functions[e]);if(t.nativeFunctions)for(const e in t.nativeFunctions)this.addNativeFunction(e,t.nativeFunctions[e])}}getValidate(){return sn}chooseKernel(){if(this.Kernel)return;let t=null;if(this.context){for(let e=0;e<en.length;e++){const r=en[e];if(r.isContextMatch(this.context)){if(!r.isSupported)throw new Error(`Kernel type ${r.name} not supported`);t=r;break}}if(null===t)throw new Error("unknown Context")}else if(this.mode){if(this.mode in nn)sn&&!nn[this.mode].isSupported||(t=nn[this.mode]);else if("gpu"===this.mode){for(let e=0;e<en.length;e++)if(en[e].isSupported){t=en[e];break}}else"cpu"===this.mode&&(t=ee);if(!t)throw new Error(`A requested mode of "${this.mode}" and is not supported`)}else{for(let e=0;e<en.length;e++)if(en[e].isSupported){t=en[e];break}t||(t=ee)}this.mode||(this.mode=t.mode),this.Kernel=t}createKernel(t,e){if(void 0===t)throw new Error("Missing source parameter");if("object"!=typeof t&&!p(t)&&"string"!=typeof t)throw new Error("source parameter not a function");if("dev"===this.mode){const r=u(t,an(e));return this.kernels.push(r),r}t="function"==typeof t?t.toString():t;const r={},n=an(e)||{};function i(e){const r=new ee(t,{argumentTypes:a.argumentTypes,constantTypes:a.constantTypes,graphical:a.graphical,loopMaxIterations:a.loopMaxIterations,constants:a.constants,dynamicOutput:a.dynamicOutput,dynamicArgument:a.dynamicArguments,output:a.output,precision:a.precision,pipeline:a.pipeline,immutable:a.immutable,optimizeFloatMemory:a.optimizeFloatMemory,fixIntegerDivisionAccuracy:a.fixIntegerDivisionAccuracy,functions:a.functions,nativeFunctions:a.nativeFunctions,injectedNative:a.injectedNative,subKernels:a.subKernels,strictIntegers:a.strictIntegers,debug:a.debug,warnVarUsage:a.warnVarUsage});r.build.apply(r,e);const n=r.run.apply(r,e);return a.replaceKernel(r),n}e&&"object"==typeof e.argumentTypes&&(n.argumentTypes=Object.keys(e.argumentTypes).map(t=>e.argumentTypes[t]));const s=Object.assign({context:this.context,canvas:this.canvas,functions:this.functions,nativeFunctions:this.nativeFunctions,injectedNative:this.injectedNative,gpu:this,validate:sn,onRequestFallback:i,onRequestSwitchKernel:function e(n,s){const o=new Array(n.length);for(let t=0;t<n.length;t++){const e=n[t],r=s.argumentTypes[t];if(e.type)o[t]=e.type;else switch(r){case"Number":case"Integer":case"Float":case"ArrayTexture(1)":o[t]=Xt(e);break;default:o[t]=r}}const u=o.join(","),h=r[u];if(h)return h.run.apply(h,n),h.renderKernels?h.renderKernels():h.renderOutput();const l=r[u]=new s.constructor(t,{argumentTypes:o,constantTypes:s.constantTypes,graphical:s.graphical,loopMaxIterations:s.loopMaxIterations,constants:s.constants,dynamicOutput:s.dynamicOutput,dynamicArgument:s.dynamicArguments,context:s.context,canvas:s.canvas,output:s.output,precision:s.precision,pipeline:s.pipeline,immutable:s.immutable,optimizeFloatMemory:s.optimizeFloatMemory,fixIntegerDivisionAccuracy:s.fixIntegerDivisionAccuracy,functions:s.functions,nativeFunctions:s.nativeFunctions,injectedNative:s.injectedNative,subKernels:s.subKernels,strictIntegers:s.strictIntegers,debug:s.debug,gpu:s.gpu,validate:sn,warnVarUsage:s.warnVarUsage,returnType:s.returnType,onRequestFallback:i,onRequestSwitchKernel:e});return l.build.apply(l,n),l.run.apply(l,n),a.replaceKernel(l),l.renderKernels?l.renderKernels():l.renderOutput()}},n),a=function(t){let e=function(){return t.build.apply(t,arguments),(e=t.renderKernels?function(){return t.run.apply(t,arguments),t.switchingKernels?(t.switchingKernels=!1,t.onRequestSwitchKernel(arguments,t)):t.renderKernels()}:t.renderOutput?function(){return t.run.apply(t,arguments),t.switchingKernels?(t.switchingKernels=!1,t.onRequestSwitchKernel(arguments,t)):t.renderOutput()}:function(){return t.run.apply(t,arguments)}).apply(t,arguments)};const r=function(){return e.apply(t,arguments)};return r.exec=function(){return new Promise((t,r)=>{try{t(e.apply(this,arguments))}catch(t){r(t)}})},r.replaceKernel=function(e){tn(t=e,r),r.kernel=t},tn(t,r),r.kernel=t,r}(new this.Kernel(t,s));return this.canvas||(this.canvas=a.canvas),this.context||(this.context=a.context),this.kernels.push(a),a}createKernelMap(){let t,e;if("function"==typeof arguments[arguments.length-2]?(t=arguments[arguments.length-2],e=arguments[arguments.length-1]):t=arguments[arguments.length-1],"dev"!==this.mode&&(!this.Kernel.isSupported||!this.Kernel.features.kernelMap)&&this.mode&&rn.indexOf(this.mode)<0)throw new Error(`kernelMap not supported on ${this.Kernel.name}`);const r=an(e);if(e&&"object"==typeof e.argumentTypes&&(r.argumentTypes=Object.keys(e.argumentTypes).map(t=>e.argumentTypes[t])),Array.isArray(arguments[0])){r.subKernels=[];const t=arguments[0];for(let e=0;e<t.length;e++){const n=t[e].toString(),i=d(n);r.subKernels.push({name:i,source:n,property:e})}}else{r.subKernels=[];const t=arguments[0];for(let e in t){if(!t.hasOwnProperty(e))continue;const n=t[e].toString(),i=d(n);r.subKernels.push({name:i||e,source:n,property:e})}}return this.createKernel(t,r)}combineKernels(){const t=arguments[0],e=arguments[arguments.length-1];if("cpu"===t.kernel.constructor.mode)return e;const r=arguments[0].canvas,n=arguments[0].context,i=arguments.length-1;for(let t=0;t<i;t++)arguments[t].setCanvas(r).setContext(n).setPipeline(!0);return function(){const t=e.apply(this,arguments);return t.toArray?t.toArray():t}}addFunction(t,e){return this.functions.push(m(t,e)),this}addNativeFunction(t,e,r){if(this.kernels.length>0)throw new Error('Cannot call "addNativeFunction" after "createKernels" has been called.');r=r||{};const{argumentTypes:n,argumentNames:i}=this.Kernel.nativeFunctionArguments(e)||{};return this.nativeFunctions.push({name:t,source:e,settings:r,argumentTypes:n,argumentNames:i,returnType:r.returnType||this.Kernel.nativeFunctionReturnType(e)}),this}injectNative(t){return this.injectedNative=t,this}destroy(){this.kernels&&setTimeout(()=>{for(let t=0;t<this.kernels.length;t++)this.kernels[t].destroy(!0);let t=this.kernels[0];t&&(t.kernel&&(t=t.kernel),t.constructor.destroyContext&&t.constructor.destroyContext(this.context))},0)}};return on.alias=function(t,e){const r=e.toString();return new Function(`return function ${t} (${Ht.getArgumentNamesFromString(r).join(", ")}) {\n  ${Ht.getFunctionBodyFromString(r)}\n}`)()},on.CPUFunctionNode=Qt,on.CPUKernel=ee,on.FunctionBuilder=qt,on.FunctionNode=Zt,on.HeadlessGLKernel=class extends br{static get isSupported(){return!1}static isContextMatch(){return!1}static getIsTextureFloat(){return!1}static getIsDrawBuffers(){return!1}static getChannelCount(){return 1}static get testCanvas(){return null}static get testContext(){return null}static get features(){return null}static setupFeatureChecks(){}static destroyContext(){}initCanvas(){return{}}initContext(){return null}toString(){return""}initExtensions(){}build(){}destroyExtensions(){}setOutput(){}static getFeatures(){return Object.freeze({isFloatRead:!1,isIntegerDivisionAccurate:!1,isTextureFloat:!1,isDrawBuffers:!1,kernelMap:!1,channelCount:1})}},on.Input=E,on.input=function(t,e){return new E(t,e)},on.Texture=Bt,on.utils={...S,...Ht},on.WebGL2FunctionNode=Ar,on.WebGL2Kernel=Qr,on.WebGLFunctionNode=_e,on.WebGLKernel=br,on.GLKernel=Ae,on.Kernel=Wt,on}();
//# sourceMappingURL=gpu-browser.min.js.map
